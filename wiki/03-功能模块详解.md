# 03 åŠŸèƒ½æ¨¡å—è¯¦è§£

æœ¬ç« è¯¦ç»†ä»‹ç»pyahkçš„å››å¤§æ ¸å¿ƒåŠŸèƒ½æ¨¡å—ï¼šæŠ€èƒ½ç³»ç»Ÿã€æ™ºèƒ½è¯å‰‚ã€è£…å¤‡æ´—ç»ƒå’Œè‡ªåŠ¨å¯»è·¯ã€‚æ¯ä¸ªæ¨¡å—éƒ½é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œæ—¢å¯ç‹¬ç«‹è¿è¡Œï¼Œä¹Ÿå¯ååŒå·¥ä½œã€‚

---

## ğŸ¯ æŠ€èƒ½è‡ªåŠ¨åŒ–ç³»ç»Ÿ

### æ¦‚è¿°
æŠ€èƒ½ç³»ç»Ÿæ˜¯pyahkçš„æ ¸å¿ƒåŠŸèƒ½ï¼Œæä¾›è‡ªåŠ¨åŒ–çš„æŠ€èƒ½é‡Šæ”¾ã€å†·å´æ£€æµ‹å’Œä¼˜å…ˆçº§ç®¡ç†ã€‚æ”¯æŒå¤šç§è§¦å‘æ¨¡å¼å’Œæ‰§è¡Œæ¡ä»¶ï¼Œå®ç°ç²¾ç¡®çš„æˆ˜æ–—è‡ªåŠ¨åŒ–ã€‚

**ğŸš€ æœ€æ–°æ¶æ„å‡çº§**ï¼šå¼•å…¥ä¼˜å…ˆçº§æŒ‰é”®æš‚åœ/æ¢å¤æœºåˆ¶ï¼Œå½“ç©ºæ ¼ã€å³é”®ç­‰ä¼˜å…ˆçº§æŒ‰é”®æ¿€æ´»æ—¶ï¼Œç³»ç»Ÿæ™ºèƒ½æš‚åœæ‰€æœ‰åå°è°ƒåº¦ä»»åŠ¡ï¼Œå®ç°"é›¶èµ„æºæµªè´¹"çš„é«˜æ•ˆè¿è¡Œã€‚

### æ ¸å¿ƒæ¶æ„ç»„ä»¶

#### UnifiedScheduler - ç»Ÿä¸€è°ƒåº¦å™¨
```python
class UnifiedScheduler:
    """ç»Ÿä¸€ä»»åŠ¡è°ƒåº¦å™¨ - æ”¯æŒæ™ºèƒ½æš‚åœ/æ¢å¤"""
    
    def pause(self) -> bool:
        """æš‚åœæ‰€æœ‰ä»»åŠ¡æ‰§è¡Œ"""
        self._paused = True
        return True
    
    def resume(self) -> bool:
        """æ¢å¤æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œï¼Œæ™ºèƒ½é‡ç®—æ—¶é—´"""
        self._paused = False
        current_time = self._now()
        for task in self._tasks.values():
            if task.enabled:
                task.next_run_time = current_time + task.interval
        self._rebuild_heap()
        self._condition.notify()
        return True
```

**æŠ€æœ¯ç‰¹ç‚¹**ï¼š
- åŸºäºheapqçš„é«˜æ•ˆä¼˜å…ˆçº§é˜Ÿåˆ—
- time.monotonic()å•è°ƒæ—¶é—´æºï¼Œé¿å…ç³»ç»Ÿæ—¶é’Ÿè°ƒæ•´å½±å“
- æ”¯æŒä»»åŠ¡çš„åŠ¨æ€å¢åˆ æ”¹å’Œæ™ºèƒ½æš‚åœæ¢å¤
- å•çº¿ç¨‹è°ƒåº¦é¿å…ç«æ€æ¡ä»¶ï¼Œæä¾›äºšæ¯«ç§’çº§ç²¾åº¦

#### SkillManager - æ™ºèƒ½æŠ€èƒ½ç®¡ç†å™¨
```python
class SkillManager:
    """é‡æ„åçš„æŠ€èƒ½ç®¡ç†å™¨ - å…·å¤‡è‡ªä¸»è°ƒåº¦å’Œæš‚åœæ§åˆ¶èƒ½åŠ›"""
    
    def _on_scheduler_pause_requested(self, event_data):
        """å“åº”ä¼˜å…ˆçº§æŒ‰é”®æŒ‰ä¸‹ - æš‚åœè°ƒåº¦å™¨ä»¥èŠ‚çœCPUèµ„æº"""
        if self.unified_scheduler.get_status()["running"]:
            self.unified_scheduler.pause()
            LOG_INFO(f"[æ€§èƒ½ä¼˜åŒ–] è°ƒåº¦å™¨å·²æš‚åœ - {reason}")
    
    def _on_scheduler_resume_requested(self, event_data):
        """å“åº”ä¼˜å…ˆçº§æŒ‰é”®é‡Šæ”¾ - æ¢å¤è°ƒåº¦å™¨"""
        if self._is_running and not self._is_paused:
            self.unified_scheduler.resume()
            LOG_INFO(f"[æ€§èƒ½ä¼˜åŒ–] è°ƒåº¦å™¨å·²æ¢å¤ - {reason}")
```

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- è‡ªä¸»è°ƒåº¦ï¼šç‹¬ç«‹çš„ç»Ÿä¸€è°ƒåº¦å™¨ç®¡ç†æ‰€æœ‰å®šæ—¶ä»»åŠ¡
- äº‹ä»¶é©±åŠ¨ï¼šé€šè¿‡äº‹ä»¶æ€»çº¿å“åº”ä¼˜å…ˆçº§æŒ‰é”®çŠ¶æ€å˜åŒ–
- æ™ºèƒ½æš‚åœï¼šåŒºåˆ†ç”¨æˆ·æ‰‹åŠ¨æš‚åœå’Œç³»ç»Ÿè‡ªåŠ¨æš‚åœ
- èµ„æºä¼˜åŒ–ï¼šä¼˜å…ˆçº§æŒ‰é”®æ¿€æ´»æ—¶å®Œå…¨åœæ­¢CPUå¯†é›†æ“ä½œ

#### ğŸš€ ä¼˜å…ˆçº§æŒ‰é”®æš‚åœ/æ¢å¤æ¶æ„

**æ€§èƒ½ä¼˜åŒ–åŸç†**ï¼š
ä¼ ç»Ÿå®ç°ä¸­ï¼Œä¼˜å…ˆçº§æŒ‰é”®æ¿€æ´»æ—¶è™½ç„¶æŠ€èƒ½è¢«é˜»å¡ï¼Œä½†è°ƒåº¦å™¨ä»åœ¨è¿è¡Œï¼š
- âŒ `check_cooldowns` æŒç»­æ‰§è¡Œä½†ç»“æœè¢«ä¸¢å¼ƒ
- âŒ å¸§æ•è·å’Œåƒç´ åˆ†ææŒç»­è¿›è¡Œä½†æ— æ•ˆ  
- âŒ èµ„æºæ£€æŸ¥ç­‰CPUå¯†é›†æ“ä½œé€ æˆ"é›¶åŠŸæ•ˆèµ„æºæµªè´¹"

æ–°æ¶æ„å®ç°çœŸæ­£çš„"æŒ‰éœ€è®¡ç®—"ï¼š
- âœ… ç¬¬ä¸€ä¸ªä¼˜å…ˆçº§æŒ‰é”®æŒ‰ä¸‹æ—¶ç«‹å³æš‚åœæ‰€æœ‰è°ƒåº¦ä»»åŠ¡
- âœ… æ‰€æœ‰ä¼˜å…ˆçº§æŒ‰é”®é‡Šæ”¾æ—¶æ™ºèƒ½æ¢å¤è°ƒåº¦
- âœ… CPUä½¿ç”¨ç‡åœ¨æš‚åœæœŸé—´é™ä½70-90%

**äº‹ä»¶æµç¨‹**ï¼š
```
ä¼˜å…ˆçº§æŒ‰é”®æŒ‰ä¸‹ â†’ InputHandleræ£€æµ‹ â†’ å‘å¸ƒæš‚åœäº‹ä»¶ 
â†’ SkillManagerå“åº” â†’ UnifiedScheduler.pause() â†’ ğŸ›‘ CPUå¤§å¹…é™ä½

ä¼˜å…ˆçº§æŒ‰é”®é‡Šæ”¾ â†’ InputHandleræ£€æµ‹ â†’ å‘å¸ƒæ¢å¤äº‹ä»¶
â†’ SkillManagerå“åº” â†’ UnifiedScheduler.resume() â†’ â–¶ï¸ ç³»ç»Ÿæ¢å¤
```

### ä¸‰ç§è§¦å‘æ¨¡å¼

#### 1. å®šæ—¶æ¨¡å¼ (TriggerMode = 0)
```json
{
  "name": "æŒç»­æŠ€èƒ½",
  "key": "1",
  "trigger_mode": 0,
  "interval": 1000,  // æ¯1ç§’æ‰§è¡Œä¸€æ¬¡
  "priority": false
}
```
- **åŠŸèƒ½**ï¼šåŸºäºå›ºå®šæ—¶é—´é—´éš”æ‰§è¡ŒæŠ€èƒ½
- **ä½¿ç”¨åœºæ™¯**ï¼šæŒç»­BUFFæŠ€èƒ½ã€å®šæœŸå›è¡€æŠ€èƒ½
- **ç‰¹ç‚¹**ï¼šä¸¥æ ¼æŒ‰æ—¶é—´é—´éš”æ‰§è¡Œï¼Œä¸å—æ¸¸æˆçŠ¶æ€å½±å“

#### 2. å†·å´æ¨¡å¼ (TriggerMode = 1)
```json
{
  "name": "ä¸»è¦è¾“å‡º",
  "key": "q",
  "trigger_mode": 1,
  "cooldown_coords": [100, 50, 20, 20],  // [x, y, width, height]
  "priority": true
}
```
- **åŠŸèƒ½**ï¼šåŸºäºæŠ€èƒ½å›¾æ ‡å†·å´çŠ¶æ€æ‰§è¡ŒæŠ€èƒ½
- **æ£€æµ‹åŸç†**ï¼šé‡‡ç”¨ç»Ÿä¸€çš„**HSVæ¨¡æ¿åŒ¹é…**ç®—æ³•ï¼Œèƒ½æœ‰æ•ˆæŠµæŠ—æ¸¸æˆå†…å…‰ç…§å’ŒæŠ€èƒ½å›¾æ ‡åŠ¨ç”»æ•ˆæœçš„å¹²æ‰°ï¼Œè¯†åˆ«æ›´ç²¾å‡†ã€‚
- **ä½¿ç”¨åœºæ™¯**ï¼šä¸»è¦è¾“å‡ºæŠ€èƒ½ã€æœ‰å†·å´æ—¶é—´çš„å…³é”®æŠ€èƒ½

#### 3. æŒ‰ä½æ¨¡å¼ (TriggerMode = 2)
```json
{
  "name": "ç§»åŠ¨æŠ€èƒ½",
  "key": "shift",
  "trigger_mode": 2
}
```
- **åŠŸèƒ½**ï¼šè¿›å…¥è¿è¡ŒçŠ¶æ€æ—¶æŒ‰ä¸‹ï¼Œåœæ­¢æ—¶é‡Šæ”¾
- **ç‰¹ç‚¹**ï¼š
  - ä»…åœ¨çŠ¶æ€åˆ‡æ¢æ—¶ä¸€æ¬¡æ€§æ‰§è¡Œ
  - ä¸å‚ä¸å¾ªç¯æˆ–å®šæ—¶ä»»åŠ¡
  - ç”±AHKæœåŠ¡æ‰§è¡Œï¼Œæ”¯æŒç»„åˆé”®
- **ä½¿ç”¨åœºæ™¯**ï¼šæŒç»­æŠ€èƒ½ã€ç§»åŠ¨é€Ÿåº¦å¢å¼º

### ä¼˜å…ˆçº§ç³»ç»Ÿ

#### å››çº§ä¼˜å…ˆé˜Ÿåˆ—æ¶æ„
pyahké‡‡ç”¨å¤šçº§ä¼˜å…ˆé˜Ÿåˆ—ç³»ç»Ÿï¼Œæ”¯æŒå››ä¸ªä¼˜å…ˆç­‰çº§ï¼š

| ä¼˜å…ˆçº§ | åç§° | æè¿° | å…¸å‹ç”¨ä¾‹ |
|--------|------|------|----------|
| emergency | ç´§æ€¥ | æœ€é«˜ä¼˜å…ˆçº§ï¼Œç«‹å³æ‰§è¡Œ | HP/MPè¯å‰‚ã€ç´§æ€¥é€ƒç”ŸæŠ€èƒ½ |
| high | é«˜ | é‡è¦æŠ€èƒ½ï¼Œä¼˜å…ˆå¤„ç† | æ ¸å¿ƒè¾“å‡ºæŠ€èƒ½ã€å…³é”®BUFF |
| normal | æ™®é€š | æ ‡å‡†æŠ€èƒ½ | å¸¸è§„æ”»å‡»æŠ€èƒ½ |
| low | ä½ | è¾…åŠ©åŠŸèƒ½ | æ‹¾å–ç‰©å“ã€ç•Œé¢æ“ä½œ |

#### MultiPriorityQueue å®ç°
```python
class MultiPriorityQueue:
    """å¤šçº§ä¼˜å…ˆé˜Ÿåˆ—å®ç°"""

    def __init__(self, maxsize: int = 0):
        # æŒ‰ä¼˜å…ˆçº§ä»é«˜åˆ°ä½æ’åˆ—
        self._queues = {
            'emergency': deque(),  # ç´§æ€¥é˜Ÿåˆ—
            'high': deque(),       # é«˜ä¼˜å…ˆçº§é˜Ÿåˆ—
            'normal': deque(),     # æ™®é€šé˜Ÿåˆ—
            'low': deque()         # ä½ä¼˜å…ˆçº§é˜Ÿåˆ—
        }
        self._priority_order = ['emergency', 'high', 'normal', 'low']

    def put(self, item, priority='normal', block=False, timeout=None):
        """æŒ‰ä¼˜å…ˆçº§æ”¾å…¥å…ƒç´ """

    def get(self, block=True, timeout=None):
        """æŒ‰ä¼˜å…ˆçº§é¡ºåºå–å‡ºå…ƒç´ """
        for priority in self._priority_order:
            if self._queues[priority]:
                return self._queues[priority].popleft()
```

#### è¯­ä¹‰åŒ–æ¥å£è®¾è®¡
```python
class InputHandler:
    # è¯­ä¹‰åŒ–çš„æŒ‰é”®æ‰§è¡Œæ¥å£
    def execute_hp_potion(self, key: str):
        """æ‰§è¡ŒHPè¯å‰‚æŒ‰é”® - ç´§æ€¥ä¼˜å…ˆçº§"""
        self._key_queue.put(key, priority='emergency', block=False)

    def execute_mp_potion(self, key: str):
        """æ‰§è¡ŒMPè¯å‰‚æŒ‰é”® - ç´§æ€¥ä¼˜å…ˆçº§"""
        self._key_queue.put(key, priority='emergency', block=False)

    def execute_skill_high(self, key: str):
        """æ‰§è¡Œé«˜ä¼˜å…ˆçº§æŠ€èƒ½æŒ‰é”®"""
        self._key_queue.put(key, priority='high', block=False)

    def execute_skill_normal(self, key: str):
        """æ‰§è¡Œæ™®é€šæŠ€èƒ½æŒ‰é”®"""
        self._key_queue.put(key, priority='normal', block=False)
```

#### æœ€ä½³å®è·µ
```json
{
  "skills": [
    {"name": "ç´§æ€¥æ²»ç–—", "priority": "emergency"},  // ç´§æ€¥ä¼˜å…ˆçº§
    {"name": "æ ¸å¿ƒè¾“å‡º", "priority": "high"},       // é«˜ä¼˜å…ˆçº§
    {"name": "è¾…åŠ©æŠ€èƒ½", "priority": "normal"},     // æ™®é€šä¼˜å…ˆçº§
    {"name": "æ‹¾å–ç‰©å“", "priority": "low"}         // ä½ä¼˜å…ˆçº§
  ]
}
```

### æ‰§è¡Œæ¡ä»¶ç³»ç»Ÿ

#### æ— æ¡ä»¶æ¨¡å¼ (ExecuteCondition = 0)
- å†·å´å°±ç»ªæ—¶ç›´æ¥æ‰§è¡Œä¸»æŒ‰é”®
- æœ€ç®€å•çš„æ‰§è¡Œæ¨¡å¼

#### Buffé™åˆ¶æ¨¡å¼ (ExecuteCondition = 1)
```json
{
  "execute_condition": 1,
  "buff_coords": [200, 100, 30, 30],
  "key": "e"
}
```
- **é€»è¾‘**ï¼šBuffå­˜åœ¨æ—¶ä¸æ‰§è¡Œï¼ŒBuffæ¶ˆå¤±æ—¶æ‰§è¡Œ
- **åœºæ™¯**ï¼šé¿å…é‡å¤ä¸ŠBUFF

#### èµ„æºæ¡ä»¶æ¨¡å¼ (ExecuteCondition = 2)
```json
{
  "execute_condition": 2,
  "resource_coords": [50, 950, 200, 20],
  "resource_threshold": 70,
  "key": "r",
  "alt_key": "t"  // èµ„æºä¸è¶³æ—¶çš„å¤‡ç”¨æŒ‰é”®
}
```
- **é€»è¾‘**ï¼šèµ„æºå……è¶³æ‰§è¡Œä¸»æŒ‰é”®ï¼Œä¸è¶³æ‰§è¡Œå¤‡ç”¨æŒ‰é”®
- **è¿ç»­æ€§æ£€æŸ¥**ï¼šé¿å…æ£€æµ‹æŠ–åŠ¨
- **åœºæ™¯**ï¼šæ ¹æ®MP/æ€’æ°”çŠ¶æ€åˆ‡æ¢æŠ€èƒ½

---

## ï¿½ å¤šçº§ä¼˜å…ˆçº§ç³»ç»Ÿï¼ˆæ ¸å¿ƒè°ƒåº¦å¼•æ“ï¼‰

### ç³»ç»Ÿæ¦‚è¿°
å¤šçº§ä¼˜å…ˆçº§ç³»ç»Ÿæ˜¯æŠ€èƒ½è‡ªåŠ¨åŒ–çš„"è¾“å…¥è°ƒåº¦å¤§è„‘"ï¼Œæä¾›ç²¾ç»†åŒ–çš„æŒ‰é”®æ‰§è¡Œä¼˜å…ˆçº§ç®¡ç†å’Œæ™ºèƒ½çš„æŠ€èƒ½æ‰§è¡Œæ§åˆ¶ã€‚é€šè¿‡å››çº§ä¼˜å…ˆé˜Ÿåˆ—å’Œå®æ—¶æŒ‰é”®çŠ¶æ€ç›‘æ§ï¼Œå®ç°æ¸¸æˆæ“ä½œçš„ç²¾ç¡®æ§åˆ¶å’Œå‰åæ‘‡å†²çªçš„æ™ºèƒ½é¿å…ã€‚

> **æœ€æ–°æ›´æ–°**ï¼šå¼•å…¥ä¼˜å…ˆçº§æŒ‰é”®"é‡æ–°æ³¨å…¥"æœºåˆ¶ï¼Œè§£å†³çŸ­æŒ‰ç©ºæ ¼/å³é”®å¶å‘ä¸ç”Ÿæ•ˆé—®é¢˜ã€‚

### å››çº§ä¼˜å…ˆé˜Ÿåˆ—æ¶æ„

| ä¼˜å…ˆçº§ | åç§° | æ•°å€¼ | å…¸å‹ç”¨ä¾‹ | æ‰§è¡Œç­–ç•¥ |
|--------|------|------|----------|----------|
| emergency | ç´§æ€¥ | 0 (æœ€é«˜) | HP/MP è¯å‰‚ã€æé™ä¿å‘½ | æ°¸ä¸è¢«æ‹¦æˆªï¼Œç«‹å³æ‰§è¡Œ |
| high | é«˜ | 1 | ä¼˜å…ˆçº§æŒ‰é”®"é‡æ³¨å…¥"äº‹ä»¶ï¼ˆspace/right_mouseï¼‰ã€æ ¸å¿ƒæŠ€èƒ½ | å…è®¸åœ¨ä¼˜å…ˆçº§æ¨¡å¼ä¸­æ‰§è¡Œ |
| normal | æ™®é€š | 2 | å¸¸è§„æŠ€èƒ½ | è¢«ä¼˜å…ˆçº§æŒ‰é”®çŠ¶æ€æš‚åœ |
| low | ä½ | 3 | è¾…åŠ© / UI / æ‹¾å– | è¢«ä¼˜å…ˆçº§æŒ‰é”®çŠ¶æ€æš‚åœ |

### ä¼˜å…ˆçº§æŒ‰é”®ç›‘æ§ + å³æ—¶é‡æ³¨å…¥ç³»ç»Ÿ

#### è®¾è®¡ç›®æ ‡
- **çŸ­æŒ‰å¯é **ï¼šä»»æ„æçŸ­é—ªé¿/å³é”®ç‚¹å‡»ä¹Ÿç»ä¸ä¸¢å¤±
- **é•¿æŒ‰ä¿æŠ¤**ï¼šæŒ‰ä½ä¼˜å…ˆçº§æŒ‰é”®æ—¶ï¼Œè‡ªåŠ¨æŠ€èƒ½å…¨å±€æš‚åœ
- **éä¾µå…¥ç­–ç•¥**ï¼šåªé‡æ³¨å…¥ä¼˜å…ˆçº§æŒ‰é”®æœ¬èº«ï¼Œä¸é‡å¤å‘é€å…¶å®ƒæŠ€èƒ½
- **æ ‡å‡†åŒ–åŒ¹é…**ï¼šæ‰€æœ‰è¾“å…¥ç»Ÿä¸€æ˜ å°„åå†åˆ¤å®šï¼ˆå‡å°‘é…ç½®å·®å¼‚ï¼‰

#### æ ¸å¿ƒç›‘å¬ + é‡æ³¨å…¥æµç¨‹
```python
def _on_key_press(self, key):
    key_name = self._get_key_name(key)
    if key_name in self._priority_keys_config:
        self._priority_keys_pressed.add(key_name)
        LOG_INFO(f"[ä¼˜å…ˆçº§æ¨¡å¼] {key_name} æŒ‰ä¸‹ - æŠ€èƒ½æš‚åœï¼Œé‡æ³¨å…¥")
        # ğŸ”¥ å…³é”®ï¼šç«‹å³é‡æ³¨å…¥åˆ°é«˜ä¼˜å…ˆçº§é˜Ÿåˆ—
        self._inject_priority_key_to_queue(key_name, True)

def _inject_priority_key_to_queue(self, key_name: str, is_press: bool):
    event = key_name if is_press else f"up_{key_name}"
    self._key_queue.put(event, 'high')  # é«˜ä¼˜å…ˆçº§æ³¨å…¥
```

#### è¯­ä¹‰åŒ–æ‰§è¡Œæ¥å£
```python
def execute_hp_potion(self, key: str):
    """æ‰§è¡ŒHPè¯å‰‚ - ç´§æ€¥ä¼˜å…ˆçº§"""
    self._key_queue.put(key, priority='emergency')

def execute_skill_high(self, key: str):
    """æ‰§è¡Œé«˜ä¼˜å…ˆçº§æŠ€èƒ½"""
    if self.is_priority_mode_active():
        LOG_INFO(f"æŠ€èƒ½ {key} è¢«è·³è¿‡ï¼ˆä¼˜å…ˆçº§æŒ‰é”®æ¿€æ´»ï¼‰")
        return
    self._key_queue.put(key, priority='high')

def execute_skill_normal(self, key: str):
    """æ‰§è¡Œæ™®é€šæŠ€èƒ½"""
    if self.is_priority_mode_active():
        LOG_INFO(f"æŠ€èƒ½ {key} è¢«è·³è¿‡ï¼ˆä¼˜å…ˆçº§æŒ‰é”®æ¿€æ´»ï¼‰")
        return
    self._key_queue.put(key, priority='normal')
```

#### è¿‡æ»¤ & é‡æ³¨å…¥è§„åˆ™
| æƒ…å†µ | è¡Œä¸º | è¯´æ˜ |
|------|------|------|
| HP/MPï¼ˆemergencyï¼‰ | ç«‹å³æ‰§è¡Œ | ä¸è¢«ä»»ä½•æ¨¡å¼é˜»å¡ |
| ä¼˜å…ˆçº§æŒ‰é”®æŒ‰ä¸‹ | ç«‹å³é‡æ³¨å…¥ï¼ˆhighï¼‰ | æ³¨å…¥ `space` / `right_mouse` ç­‰å®é™…äº‹ä»¶ |
| ä¼˜å…ˆçº§æŒ‰é”®é‡Šæ”¾ | æ³¨å…¥ `up_space` ç­‰ | ç¡®ä¿é•¿æŒ‰çŠ¶æ€ç»“æŸè¢«æ„ŸçŸ¥ |
| æ™®é€š/ä½æŠ€èƒ½åœ¨ä¼˜å…ˆçº§æŒ‰ä¸‹æœŸé—´ | è·³è¿‡ï¼ˆå»¶åï¼‰ | ä¿æŠ¤ç©å®¶æ„å›¾ï¼ˆèµ°ä½/ç„å‡†/å¸ƒé›·ï¼‰ |

#### å…¸å‹åº”ç”¨åœºæ™¯

**1. é—ªé¿ä¼˜å…ˆçº§æ¨¡å¼ï¼ˆçŸ­æŒ‰ & è¿ç»­ï¼‰**
```json
{
  "priority_keys": {
    "enabled": true,
    "keys": ["space"]
  }
}
```
è¡Œä¸ºé€»è¾‘ï¼š
```
æŒ‰ä¸‹ â†’ ç›‘å¬æ•è· â†’ æ³¨å…¥ 'space' (high) â†’ ç«‹å³æ‰§è¡Œ
ä¿æŒ â†’ æ ‡è®°ä¼˜å…ˆçº§æ¿€æ´» â†’ å…¶å®ƒæŠ€èƒ½è¿‡æ»¤
é‡Šæ”¾ â†’ æ³¨å…¥ 'up_space' â†’ çŠ¶æ€å¤ä½ â†’ æŠ€èƒ½æ¢å¤
```

**2. å¸ƒé›·/å³é”®è“„åŠ›æŠ€èƒ½ä¿æŠ¤**
```json
{
  "priority_keys": {
    "enabled": true,
    "keys": ["right_mouse"]
  }
}
```
ä¿æŠ¤æœºåˆ¶ï¼š
- **å³æ—¶ç‚¹æŒ‰**ï¼šç‚¹ä¸€ä¸‹ç«‹å³æ³¨å…¥ right_mouseï¼ˆä¸è¢«åï¼‰
- **æŒç»­æŒ‰å‹**ï¼šä¿æŒæœŸé—´å…¶å®ƒæŠ€èƒ½å†»ç»“
- **é‡Šæ”¾æ§åˆ¶**ï¼š`up_right_mouse` å¯è§¦å‘å¯é€‰"åæ‘‡ç¼“å†²"ç­–ç•¥

**3. å¤åˆä¼˜å…ˆçº§æ¨¡å¼ï¼ˆå¤šæŒ‰é”®å¹¶è¡Œï¼‰**
```json
{
  "priority_keys": {
    "enabled": true,
    "keys": ["space", "right_mouse", "ctrl"]
  }
}
```
æ™ºèƒ½é€»è¾‘ï¼š
- **é›†åˆè¯­ä¹‰**ï¼šä¼˜å…ˆçº§çŠ¶æ€ = å½“å‰æŒ‰ä¸‹ä¼˜å…ˆçº§æŒ‰é”®é›†åˆæ˜¯å¦éç©º
- **å¹¶å‘æ— å†²çª**ï¼šå¤šä¸ªæŒ‰é”®å„è‡ªç”Ÿæˆ press / up äº‹ä»¶
- **éƒ¨åˆ†é‡Šæ”¾ä¸è§£é”**ï¼šç›´åˆ°é›†åˆæ¸…ç©ºæ‰æ¢å¤æŠ€èƒ½

### æŒ‰é”®åç§°æ ‡å‡†åŒ–
```python
def _normalize_key_name(self, key: str) -> str:
    """ç»Ÿä¸€æŒ‰é”®åç§°æ ¼å¼"""
    key_mapping = {
        'leftmouse': 'left_mouse',
        'rightmouse': 'right_mouse',
        'spacebar': 'space',
        'control': 'ctrl',
        'return': 'enter',
        'escape': 'esc'
    }
    normalized = key.lower().strip()
    return key_mapping.get(normalized, normalized)
```

---

## ï¿½ğŸ® ä¼ ç»Ÿä¼˜å…ˆçº§æŒ‰é”®ç›‘æ§ç³»ç»Ÿï¼ˆå‘å‰å…¼å®¹ï¼‰

### æ¦‚è¿°
ä¼˜å…ˆçº§æŒ‰é”®ç›‘æ§ç³»ç»Ÿé€šè¿‡å®æ—¶ç›‘å¬é”®ç›˜å’Œé¼ æ ‡è¾“å…¥ï¼Œå®ç°æ™ºèƒ½çš„æŠ€èƒ½æ‰§è¡Œæ§åˆ¶ã€‚å½“ç©å®¶æŒ‰ä¸‹æŒ‡å®šçš„ä¼˜å…ˆçº§æŒ‰é”®ï¼ˆå¦‚é—ªé¿é”®ã€æŠ€èƒ½é”®ï¼‰æ—¶ï¼Œç³»ç»Ÿä¼šæš‚åœæ™®é€šæŠ€èƒ½çš„æ‰§è¡Œï¼Œç¡®ä¿ä¼˜å…ˆçº§æ“ä½œä¸è¢«æ‰“æ–­ã€‚

### æ ¸å¿ƒæœºåˆ¶

#### å®æ—¶æŒ‰é”®ç›‘å¬
```python
class InputHandler:
    def _start_priority_listeners(self):
        """å¯åŠ¨é”®ç›˜å’Œé¼ æ ‡ç›‘å¬å™¨"""
        self._keyboard_listener = KeyboardListener(
            on_press=self._on_key_press,
            on_release=self._on_key_release
        )
        self._mouse_listener = MouseListener(
            on_click=self._on_mouse_click
        )

    def _on_key_press(self, key):
        """é”®ç›˜æŒ‰ä¸‹äº‹ä»¶å¤„ç†"""
        key_name = self._get_key_name(key)
        if key_name in self._priority_keys_config:
            self._priority_keys_pressed.add(key_name)
            LOG_INFO(f"[ä¼˜å…ˆçº§æ¨¡å¼] {key_name} æŒ‰ä¸‹ - æŠ€èƒ½æš‚åœ")

    def is_priority_mode_active(self) -> bool:
        """æ£€æŸ¥æ˜¯å¦æœ‰ä¼˜å…ˆçº§æŒ‰é”®æ­£åœ¨æŒ‰ä¸‹"""
        return self._priority_mode_enabled and bool(self._priority_keys_pressed)
```

#### æŠ€èƒ½æ‰§è¡Œè¿‡æ»¤
```python
def execute_skill_normal(self, key: str):
    """æ‰§è¡Œæ™®é€šæŠ€èƒ½æŒ‰é”®"""
    if not key:
        return

    # ğŸ¯ ä¼˜å…ˆçº§æ¨¡å¼æ£€æŸ¥ï¼šæœ‰ä¼˜å…ˆçº§æŒ‰é”®æŒ‰ä¸‹æ—¶æŠ€èƒ½ä¸å“åº”
    if self.is_priority_mode_active():
        active_keys = ", ".join(self.get_active_priority_keys())
        LOG_INFO(f"[ä¼˜å…ˆçº§æ¨¡å¼] æŠ€èƒ½ {key} è¢«è·³è¿‡ï¼ˆä¼˜å…ˆçº§æŒ‰é”®: {active_keys}ï¼‰")
        return

    self._key_queue.put(key, priority='normal', block=False)
```

### é…ç½®ç³»ç»Ÿ

#### ä¼˜å…ˆçº§æŒ‰é”®é…ç½®
```json
{
  "priority_keys": {
    "enabled": true,
    "keys": ["space", "right_mouse", "ctrl"],
    "delay_ms": 50
  }
}
```

#### æŠ€èƒ½åºåˆ—é…ç½®
```json
{
  "skill_config": {
    "ç«çƒæœ¯": {
      "enabled": true,
      "key": "delay50,q",
      "alt_key": "delay100,shift+q",
      "timer": 1500,
      "priority": false
    }
  }
}
```

#### UIé…ç½®ç•Œé¢
- **å¯ç”¨å¼€å…³**ï¼šæ§åˆ¶æ•´ä¸ªä¼˜å…ˆçº§æŒ‰é”®ç³»ç»Ÿ
- **æŒ‰é”®åˆ—è¡¨**ï¼šå¯è§†åŒ–ç®¡ç†ä¼˜å…ˆçº§æŒ‰é”®
- **å»¶è¿Ÿä¿æŠ¤**ï¼šé…ç½®æŠ€èƒ½å‰æ‘‡ä¿æŠ¤æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
- **åºåˆ—è¾“å…¥**ï¼šæ”¯æŒæŠ€èƒ½æŒ‰é”®çš„å¤æ‚åºåˆ—é…ç½®
- **é¢„è®¾æ¨¡å¼**ï¼š
  - é—ªé¿æ¨¡å¼ï¼š`["space"]`
  - å¸ƒé›·æ¨¡å¼ï¼š`["right_mouse"]`
  - æˆ˜æ–—æ¨¡å¼ï¼š`["space", "right_mouse"]`

### åº”ç”¨åœºæ™¯

#### 1. é—ªé¿ä¼˜å…ˆçº§
```json
{
  "priority_keys": {
    "enabled": true,
    "keys": ["space"]
  }
}
```
- **åœºæ™¯**ï¼šç©å®¶æŒ‰ä½ç©ºæ ¼é”®è¿›è¡Œé—ªé¿æ—¶
- **è¡Œä¸º**ï¼šæš‚åœæ‰€æœ‰æ™®é€šæŠ€èƒ½æ‰§è¡Œï¼Œé¿å…å‰åæ‘‡å½±å“ç§»åŠ¨
- **æ¢å¤**ï¼šé‡Šæ”¾ç©ºæ ¼é”®åæ¢å¤æ­£å¸¸æŠ€èƒ½æ‰§è¡Œ

#### 2. æŠ€èƒ½è¿å‘ä¿æŠ¤
```json
{
  "priority_keys": {
    "enabled": true,
    "keys": ["right_mouse"]
  }
}
```
- **åœºæ™¯**ï¼šä½¿ç”¨å³é”®æŠ€èƒ½ï¼ˆå¦‚å¸ƒé›·ï¼‰æ—¶
- **è¡Œä¸º**ï¼šé˜²æ­¢å…¶ä»–æŠ€èƒ½æ‰“æ–­å½“å‰æŠ€èƒ½çš„é‡Šæ”¾
- **ä¼˜åŠ¿**ï¼šç¡®ä¿é‡è¦æŠ€èƒ½çš„å®Œæ•´é‡Šæ”¾

#### 3. ç»„åˆæŒ‰é”®æ”¯æŒ
```json
{
  "priority_keys": {
    "enabled": true,
    "keys": ["space", "right_mouse", "ctrl", "shift"]
  }
}
```
- **çµæ´»é…ç½®**ï¼šæ”¯æŒå¤šç§æŒ‰é”®ç»„åˆ
- **æ ‡å‡†åŒ–å¤„ç†**ï¼šè‡ªåŠ¨å¤„ç†æŒ‰é”®åç§°å˜ä½“ï¼ˆå¦‚ `spacebar` â†’ `space`ï¼‰

### æŠ€æœ¯ä¼˜åŠ¿

#### å¼‚æ­¥ç›‘å¬
- **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨ç‹¬ç«‹çš„ç›‘å¬çº¿ç¨‹ï¼Œä¸å½±å“ä¸»çº¿ç¨‹
- **å®æ—¶å“åº”**ï¼šæ¯«ç§’çº§æŒ‰é”®çŠ¶æ€æ£€æµ‹
- **èµ„æºç®¡ç†**ï¼šå®Œå–„çš„ç›‘å¬å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†

#### æ™ºèƒ½è¿‡æ»¤
- **ç²¾ç¡®æ§åˆ¶**ï¼šåªè¿‡æ»¤æ™®é€šæŠ€èƒ½ï¼Œç´§æ€¥æ“ä½œï¼ˆå¦‚HPè¯å‰‚ï¼‰ä¸å—å½±å“
- **çŠ¶æ€æ„ŸçŸ¥**ï¼šå®æ—¶æ£€æµ‹æŒ‰é”®æŒ‰ä¸‹/é‡Šæ”¾çŠ¶æ€
- **æ—¥å¿—å‹å¥½**ï¼šè¯¦ç»†çš„çŠ¶æ€å˜åŒ–è®°å½•

#### æŒ‰é”®æ ‡å‡†åŒ–
```python
def _normalize_key_name(self, key: str) -> str:
    """æ ‡å‡†åŒ–æŒ‰é”®åç§°ï¼Œé¿å…å¤§å°å†™å’Œæ ¼å¼é—®é¢˜"""
    key_mapping = {
        'spacebar': 'space',
        'leftmouse': 'left_mouse',
        'rightmouse': 'right_mouse',
        # ... æ›´å¤šæ˜ å°„
    }
    return key_mapping.get(normalized, normalized)
```

## ğŸš€ æŒ‰é”®åºåˆ—ä¸å»¶è¿Ÿç³»ç»Ÿ

### åºåˆ—è¯­æ³•æ”¯æŒ

é¡¹ç›®ç°å·²æ”¯æŒé«˜çº§æŒ‰é”®åºåˆ—åŠŸèƒ½ï¼Œå…è®¸åœ¨æŠ€èƒ½é…ç½®ä¸­ä½¿ç”¨å¤æ‚çš„æ—¶é—´æ§åˆ¶ã€‚

#### åŸºæœ¬è¯­æ³•
```
delay50,q          # å»¶è¿Ÿ50msåæŒ‰qé”®
q,delay100,w       # æŒ‰qé”®ï¼Œå»¶è¿Ÿ100msï¼ŒæŒ‰wé”®
delay200           # å•çº¯å»¶è¿Ÿ200ms
```

#### æ”¯æŒåœºæ™¯
- **æŠ€èƒ½å‰æ‘‡ä¿æŠ¤**ï¼š`delay50,q` - ç­‰å¾…æŠ€èƒ½åŠ¨ç”»å®Œæˆåé‡Šæ”¾ä¸‹ä¸€ä¸ªæŠ€èƒ½
- **è¿æ‹›æ§åˆ¶**ï¼š`q,delay100,w,delay50,e` - ç²¾ç¡®æ§åˆ¶æŠ€èƒ½é‡Šæ”¾æ—¶æœº
- **åŠ¨ç”»ç­‰å¾…**ï¼šé¿å…æŠ€èƒ½è¢«æ‰“æ–­æˆ–é‡å 

### æŠ€èƒ½é…ç½®ç•Œé¢

#### æŒ‰é”®è¾“å…¥å­—æ®µ
åœ¨æŠ€èƒ½é…ç½®ç•Œé¢çš„**ä¸»è¦æŒ‰é”®**å’Œ**è¾…åŠ©æŒ‰é”®**å­—æ®µä¸­ï¼Œç°åœ¨æ”¯æŒï¼š

```
å•ä¸ªæŒ‰é”®ï¼š    q, w, e, r
å»¶è¿ŸæŒ‡ä»¤ï¼š    delay50, delay100
æŒ‰é”®åºåˆ—ï¼š    delay50,q æˆ– q,delay100,w
```

**UIæç¤ºä¿¡æ¯**ï¼š
- å­—æ®µå®½åº¦å·²ä¼˜åŒ–ä»¥å®¹çº³åºåˆ—è¾“å…¥
- æ‚¬åœæç¤ºæ˜¾ç¤ºå®Œæ•´çš„è¯­æ³•è¯´æ˜
- æ”¯æŒä»»æ„é•¿åº¦çš„åºåˆ—ç»„åˆ

### ä¼˜å…ˆçº§å»¶è¿Ÿä¿æŠ¤

#### åŠŸèƒ½æ¦‚è¿°
ä¸ºé˜²æ­¢æŠ€èƒ½é‡Šæ”¾è¢«æ„å¤–æ‰“æ–­ï¼Œç³»ç»Ÿæä¾›å¯é…ç½®çš„å»¶è¿Ÿä¿æŠ¤æœºåˆ¶ã€‚

#### é…ç½®ç•Œé¢
åœ¨**ä¼˜å…ˆçº§æŒ‰é”®**æ ‡ç­¾é¡µä¸­ï¼š
- **å»¶è¿Ÿä¿æŠ¤**ï¼šæ¯«ç§’çº§å»¶è¿Ÿæ—¶é—´é…ç½®
- **é»˜è®¤å€¼**ï¼š50msï¼ˆé€‚åˆå¤§å¤šæ•°æ¸¸æˆåœºæ™¯ï¼‰
- **ä½œç”¨è¯´æ˜**ï¼šæŠ€èƒ½å‰æ‘‡ä¿æŠ¤ï¼Œé¿å…åŠ¨ç”»è¢«æ‰“æ–­

```json
{
  "priority_keys": {
    "enabled": true,
    "keys": ["space", "right_mouse"],
    "delay_ms": 50
  }
}
```

### é˜Ÿåˆ—å¤„ç†æœºåˆ¶

#### åºåˆ—è§£æ
```python
def execute_skill_normal(self, key: str):
    """æ‰§è¡Œæ™®é€šæŠ€èƒ½æŒ‰é”® - æ”¯æŒåºåˆ— delay50,q"""
    if ',' in key:
        key_sequence = [k.strip() for k in key.split(',') if k.strip()]
        for individual_key in key_sequence:
            self._key_queue.put(individual_key, priority='normal')
```

#### å»é‡é€»è¾‘
- **æ•´ä½“åºåˆ—å»é‡**ï¼š`delay50,q` ä½œä¸ºå®Œæ•´åºåˆ—è¿›è¡Œå»é‡åˆ¤æ–­
- **æ™ºèƒ½æ¸…ç†**ï¼šåºåˆ—æ‰§è¡Œå®Œæˆåè‡ªåŠ¨æ¸…ç†è·Ÿè¸ªçŠ¶æ€
- **çŠ¶æ€ä¸€è‡´æ€§**ï¼šç¡®ä¿é˜Ÿåˆ—çŠ¶æ€ä¸è·Ÿè¸ªé›†åˆåŒæ­¥

#### å»¶è¿Ÿå¤„ç†
```python
# é˜Ÿåˆ—å¤„ç†å™¨ä¸­çš„å»¶è¿Ÿé€»è¾‘
if key_lower.startswith("delay"):
    delay_ms = int(key_lower[5:])
    if self._stop_event.wait(delay_ms / 1000.0):
        break
```

### åº”ç”¨å®ä¾‹

#### 1. æŠ€èƒ½è¿æ‹›ä¿æŠ¤
```json
{
  "skill_name": "ç«çƒè¿å‡»",
  "key": "delay100,q,delay200,w",
  "trigger_mode": 0,
  "timer": 2000
}
```
- **åœºæ™¯**ï¼šç«çƒæœ¯éœ€è¦100mså‰æ‘‡ï¼Œè¿å‡»éœ€è¦200msé—´éš”
- **æ•ˆæœ**ï¼šç¡®ä¿æŠ€èƒ½æŒ‰æ­£ç¡®é¡ºåºå’Œæ—¶æœºé‡Šæ”¾

#### 2. è¾…åŠ©æŠ€èƒ½æ—¶æœºæ§åˆ¶
```json
{
  "skill_name": "æ²»ç–—åºåˆ—",
  "key": "delay50,h",
  "alt_key": "delay100,shift+h",
  "priority": true
}
```
- **ä¸»æŠ€èƒ½**ï¼šæ™®é€šæ²»ç–—ï¼Œ50mså»¶è¿Ÿä¿æŠ¤
- **è¾…åŠ©æŠ€èƒ½**ï¼šå¼ºåŒ–æ²»ç–—ï¼Œ100mså»¶è¿Ÿ+ç»„åˆé”®

#### 3. å¤æ‚å®å‘½ä»¤
```
æŠ€èƒ½æ å¿«æ·é”®ï¼šdelay50,1,delay200,2,delay100,3
```
- **å¤šæŠ€èƒ½è¿å‘**ï¼šæŒ‰é¡ºåºé‡Šæ”¾1ã€2ã€3å·æŠ€èƒ½
- **æ—¶æœºæ§åˆ¶**ï¼šæ¯ä¸ªæŠ€èƒ½é—´ç•™å‡ºé€‚å½“çš„æ‰§è¡Œæ—¶é—´

### æœ€ä½³å®è·µ

#### 1. æŒ‰é”®é€‰æ‹©åŸåˆ™
- **é«˜é¢‘æ“ä½œ**ï¼šé€‰æ‹©å¸¸ç”¨çš„ç§»åŠ¨/é—ªé¿æŒ‰é”®
- **é‡è¦æŠ€èƒ½**ï¼šé€‰æ‹©éœ€è¦å®Œæ•´é‡Šæ”¾çš„å…³é”®æŠ€èƒ½æŒ‰é”®
- **é¿å…å†²çª**ï¼šä¸è¦å°†æŠ€èƒ½æŒ‰é”®è®¾ä¸ºä¼˜å…ˆçº§æŒ‰é”®

#### 2. é…ç½®å»ºè®®
```json
{
  "priority_keys": {
    "enabled": true,
    "keys": ["space", "right_mouse"],
    "description": "é—ªé¿+å³é”®æŠ€èƒ½ä¼˜å…ˆçº§"
  }
}
```

#### 3. è°ƒè¯•æŠ€å·§
- **çŠ¶æ€ç›‘æ§**ï¼šæŸ¥çœ‹æ—¥å¿—ä¸­çš„ä¼˜å…ˆçº§æ¨¡å¼æ¿€æ´»è®°å½•
- **æ€§èƒ½æ£€æŸ¥**ï¼šç¡®è®¤ç›‘å¬å™¨æ­£å¸¸è¿è¡Œä¸”æ— æ€§èƒ½å½±å“
- **æŒ‰é”®æµ‹è¯•**ï¼šé€ä¸ªæµ‹è¯•é…ç½®çš„æŒ‰é”®æ˜¯å¦æ­£ç¡®è¯†åˆ«

---

## ğŸ’Š æ™ºèƒ½è¯å‰‚ç³»ç»Ÿ

### æ¦‚è¿°
é‡‡ç”¨å…ˆè¿›çš„HSVåŒè‰²æ£€æµ‹ç®—æ³•ï¼Œæ”¯æŒæ­£å¸¸/ä¸­æ¯’çŠ¶æ€æ™ºèƒ½è¯†åˆ«ï¼Œå®ç°ç²¾ç¡®çš„HP/MPæ£€æµ‹å’Œè‡ªåŠ¨å–‚è¯åŠŸèƒ½ã€‚æ–°ç‰ˆæœ¬å¢åŠ äº†åœ†å½¢æ£€æµ‹æŠ€æœ¯å’Œè‡ªåŠ¨çƒä½“è¯†åˆ«åŠŸèƒ½ï¼Œæä¾›æ›´å‡†ç¡®çš„èµ„æºçŠ¶æ€æ£€æµ‹ã€‚

### ä¸‰å±‚å§”æ‰˜æ¶æ„

#### ç¬¬1å±‚ï¼šSkillManager (è°ƒåº¦å±‚)
```python
# é€šè¿‡UnifiedScheduleræŒ‰å›ºå®šé—´éš”å¯åŠ¨èµ„æºæ£€æŸ¥ä»»åŠ¡
def schedule_resource_check():
    scheduler.add_task("resource_check", 200, self.check_resources)
```

#### ç¬¬2å±‚ï¼šResourceManager (ä¸šåŠ¡é€»è¾‘å±‚)
```python
class ResourceManager:
    def check_hp_potion(self, frame):
        if not self._is_hp_cooldown_ready():
            return False
        
        current_percentage = self._detect_hp_percentage(frame)
        if current_percentage < self.hp_threshold:
            self._execute_hp_potion()
            return True
        return False
```

#### ç¬¬3å±‚ï¼šBorderFrameManager (æ£€æµ‹å±‚)
```python
def _compare_resource_hsv(self, frame, template_hsv, tolerance):
    """HSVæ¨¡æ¿åŒ¹é…ï¼Œå¤„ç†è‰²ç›¸ç¯å½¢ç‰¹æ€§"""
    # æ™ºèƒ½HSVé¢œè‰²ç©ºé—´æ£€æµ‹
    h_diff = min(abs(h1 - h2), 360 - abs(h1 - h2))
    # è®¡ç®—åŒ¹é…ç™¾åˆ†æ¯”
```

### HSVåŒè‰²æ£€æµ‹æŠ€æœ¯

#### æ ¸å¿ƒä¼˜åŠ¿
- **å…‰ç…§é€‚åº”æ€§**ï¼šHSVé¢œè‰²ç©ºé—´å¯¹å…‰ç…§å˜åŒ–ä¸æ•æ„Ÿ
- **çŠ¶æ€æ„ŸçŸ¥**ï¼šè‡ªåŠ¨è¯†åˆ«æ­£å¸¸/ä¸­æ¯’/å¼‚å¸¸çŠ¶æ€çš„é¢œè‰²å˜åŒ–
- **ç¯å½¢å¤„ç†**ï¼šæ­£ç¡®å¤„ç†è‰²ç›¸çš„360åº¦ç¯å½¢ç‰¹æ€§

#### çŸ©å½¢æ£€æµ‹æ¨¡å¼
```json
{
  "hp_config": {
    "enabled": true,
    "key": "1",
    "threshold": 50,
    "region_x1": 136,
    "region_y1": 910,
    "region_x2": 213,
    "region_y2": 1004,
    "colors": [
      {
        "name": "Normal HP",
        "target_h": 157,
        "target_s": 75,
        "target_v": 29,
        "tolerance_h": 5,
        "tolerance_s": 20,
        "tolerance_v": 20
      }
    ]
  }
}
```

### åœ†å½¢æ£€æµ‹æŠ€æœ¯

#### éœå¤«åœ†å˜æ¢è‡ªåŠ¨è¯†åˆ«
```python
def auto_detect_orbs(self) -> Dict[str, Dict[str, Any]]:
    """è‡ªåŠ¨æ£€æµ‹æ¸¸æˆä¸­çš„è¡€é‡å’Œè“é‡çƒä½“"""
    # 1. æˆªå–å…¨å±å›¾åƒ
    frame = self.border_frame_manager.capture_screen_for_reroll()

    # 2. éœå¤«åœ†å˜æ¢æ£€æµ‹
    circles = cv2.HoughCircles(
        gray_blurred,
        cv2.HOUGH_GRADIENT,
        dp=1.2,
        minDist=100,
        param1=50,
        param2=30,
        minRadius=20,
        maxRadius=80
    )

    # 3. ç­›é€‰åº•éƒ¨åŒºåŸŸçš„åœ†å½¢
    bottom_circles = []
    for circle in detected_circles:
        x, y, r = circle
        if y > frame.shape[0] * 0.7:  # åº•éƒ¨åŒºåŸŸ
            bottom_circles.append((x, y, r))

    # 4. æŒ‰xåæ ‡æ’åºï¼Œè¿”å›HPå’ŒMPçƒä½“ä¿¡æ¯
    return {
        "hp": {"center_x": hp_x, "center_y": hp_y, "radius": hp_r},
        "mp": {"center_x": mp_x, "center_y": mp_y, "radius": mp_r}
    }
```

#### åŠåœ†åˆ†æç®—æ³• (è§„é¿UIå¹²æ‰°)
```python
def compare_resource_circle(self, frame, center_x, center_y, radius, resource_type, threshold):
    """ä½¿ç”¨åŠåœ†å½¢è’™ç‰ˆæ£€æµ‹èµ„æºçŠ¶æ€ï¼Œä»¥é¿å…UIå¹²æ‰°"""
    # 1. åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„åœ†å½¢è’™ç‰ˆ
    circular_mask = np.zeros((radius * 2, radius * 2), dtype=np.uint8)
    cv2.circle(circular_mask, (radius, radius), radius, 255, -1)

    # 2. åˆ›å»ºä¸€ä¸ªåªè¦†ç›–ä¸€åŠåŒºåŸŸçš„çŸ©å½¢è’™ç‰ˆ
    half_mask = np.zeros_like(circular_mask)
    if resource_type == 'hp':  # è¡€çƒï¼Œåªåˆ†æå³åŠè¾¹
        cv2.rectangle(half_mask, (width // 2, 0), (width, height), 255, -1)
    elif resource_type == 'mp':  # è“çƒï¼Œåªåˆ†æå·¦åŠè¾¹
        cv2.rectangle(half_mask, (0, 0), (width // 2, height), 255, -1)
    
    # 3. å°†ä¸¤ä¸ªè’™ç‰ˆç›¸ä¸ï¼Œå¾—åˆ°æœ€ç»ˆçš„åŠåœ†å½¢è’™ç‰ˆ
    final_mask = cv2.bitwise_and(circular_mask, half_mask)

    # 4. åº”ç”¨è’™ç‰ˆå¹¶è¿›è¡ŒHSVåŒ¹é…
    # ...

    # 5. åŸºäºåŠåœ†è’™ç‰ˆçš„é¢ç§¯è®¡ç®—åŒ¹é…ç™¾åˆ†æ¯”
    total_pixels = np.count_nonzero(final_mask)
    # ...
```

#### åœ†å½¢é…ç½®ç¤ºä¾‹
```json
{
  "hp_config": {
    "enabled": true,
    "key": "1",
    "threshold": 50,
    "center_x": 175,
    "center_y": 957,
    "radius": 39,
    "colors": [
      {
        "name": "Circular HP Detection",
        "target_h": 157,
        "target_s": 75,
        "target_v": 29,
        "tolerance_h": 5,
        "tolerance_s": 20,
        "tolerance_v": 20
      }
    ]
  }
}
```

### æ£€æµ‹æ¨¡å¼å¯¹æ¯”

| ç‰¹æ€§ | çŸ©å½¢æ£€æµ‹ | åœ†å½¢æ£€æµ‹ |
|------|----------|----------|
| **ç²¾ç¡®åº¦** | ä¸­ç­‰ï¼ˆåŒ…å«èƒŒæ™¯åƒç´ ï¼‰ | é«˜ï¼ˆåªæ£€æµ‹çƒä½“åŒºåŸŸï¼‰ |
| **é…ç½®æ–¹å¼** | æ‰‹åŠ¨é€‰æ‹©åŒºåŸŸ | è‡ªåŠ¨è¯†åˆ«æˆ–æ‰‹åŠ¨é…ç½® |
| **é€‚ç”¨åœºæ™¯** | è§„åˆ™çŸ©å½¢UI | åœ†å½¢çƒä½“UI |
| **æŠ—å¹²æ‰°æ€§** | ä¸€èˆ¬ | ä¼˜ç§€ |
| **é…ç½®å¤æ‚åº¦** | ç®€å• | ä¸­ç­‰ |

### UIé…ç½®ç•Œé¢

#### æ£€æµ‹åŒºåŸŸè®¾ç½®
- **é€‰æ‹©åŒºåŸŸæŒ‰é’®**ï¼šæ‰‹åŠ¨é€‰æ‹©çŸ©å½¢æ£€æµ‹åŒºåŸŸ
- **Detect OrbsæŒ‰é’®**ï¼šè‡ªåŠ¨è¯†åˆ«åœ†å½¢çƒä½“
- **åæ ‡è¾“å…¥æ¡†**ï¼šæ”¯æŒçŸ©å½¢(x1,y1,x2,y2)å’Œåœ†å½¢(x,y,r)æ ¼å¼
- **å®¹å·®è®¾ç½®**ï¼šHSVä¸‰ç»´å®¹å·®é…ç½®

#### é¢œè‰²åˆ†æå·¥å…·
- **å•ç‚¹å–è‰²**ï¼šç²¾ç¡®æ‹¾å–ç‰¹å®šåƒç´ é¢œè‰²
- **åŒºåŸŸå–è‰²**ï¼šåˆ†æåŒºåŸŸå†…é¢œè‰²åˆ†å¸ƒå¹¶è‡ªåŠ¨è®¡ç®—å®¹å·®
- **å¤šé¢œè‰²é…ç½®**ï¼šæ”¯æŒé…ç½®å¤šç§é¢œè‰²çŠ¶æ€ï¼ˆå¦‚æ­£å¸¸/ä¸­æ¯’ï¼‰

### å†…éƒ¨å†·å´æœºåˆ¶
```python
class ResourceManager:
    def __init__(self):
        self._last_hp_use = 0
        self._last_mp_use = 0
        self._hp_cooldown = 5000  # 5ç§’å†·å´
        self._mp_cooldown = 8000  # 8ç§’å†·å´
    
    def _is_hp_cooldown_ready(self):
        return time.time() - self._last_hp_use > self._hp_cooldown / 1000
```

---

## ğŸ”¨ è£…å¤‡æ´—ç»ƒç³»ç»Ÿ

### æ¦‚è¿°
ç‹¬ç«‹çš„F7çƒ­é”®æ§åˆ¶æ¨¡å—ï¼Œé‡‡ç”¨ä¸‰çŠ¶æ€è¯†åˆ«æœºåˆ¶ï¼Œç»“åˆPaddleOCRæ–‡å­—è¯†åˆ«æŠ€æœ¯ï¼Œå®ç°ç²¾ç¡®çš„è¯ç¼€æ£€æµ‹å’Œè‡ªåŠ¨æ´—ç»ƒæ“ä½œã€‚

### ä¸‰çŠ¶æ€è¯†åˆ«æœºåˆ¶

#### çŠ¶æ€1ï¼šæœªæ´—ç»ƒçŠ¶æ€
- **ç‰¹å¾**ï¼šè£…å¤‡æœªè¿›è¡Œä»»ä½•æ´—ç»ƒæ“ä½œ
- **è¯†åˆ«**ï¼šé€šè¿‡ç‰¹å®šUIå…ƒç´ çš„é¢œè‰²å’Œä½ç½®è¯†åˆ«
- **æ“ä½œ**ï¼šç‚¹å‡»å¼€å§‹æ´—ç»ƒæŒ‰é’®

#### çŠ¶æ€2ï¼šæ´—ç»ƒè¿›è¡Œä¸­
- **ç‰¹å¾**ï¼šæ­£åœ¨è¿›è¡Œæ´—ç»ƒï¼Œç•Œé¢æ˜¾ç¤ºè¿›åº¦æˆ–åŠ¨ç”»
- **è¯†åˆ«**ï¼šæ£€æµ‹æ´—ç»ƒè¿›åº¦æŒ‡ç¤ºå™¨
- **æ“ä½œ**ï¼šç­‰å¾…æ´—ç»ƒå®Œæˆ

#### çŠ¶æ€3ï¼šæ´—ç»ƒå®Œæˆ
- **ç‰¹å¾**ï¼šæ´—ç»ƒå®Œæˆï¼Œæ˜¾ç¤ºæ–°è¯ç¼€ç»“æœ
- **è¯†åˆ«**ï¼šæ£€æµ‹å®ŒæˆçŠ¶æ€çš„UIç‰¹å¾
- **æ“ä½œ**ï¼šè¿›è¡ŒOCRè¯†åˆ«ï¼Œå†³ç­–æ˜¯å¦ä¿ç•™

### PaddleOCRé›†æˆ

#### å¼•æ“é…ç½®
```python
from paddleocr import PaddleOCR

ocr = PaddleOCR(
    use_angle_cls=True,      # å¯ç”¨è§’åº¦åˆ†ç±»
    lang='ch',               # ä¸­æ–‡è¯†åˆ«
    use_gpu=False,           # CPUæ¨¡å¼ï¼Œå…¼å®¹æ€§æ›´å¥½
    show_log=False,          # ç¦ç”¨è¯¦ç»†æ—¥å¿—
    det_db_score_mode='slow' # ç²¾ç¡®æ£€æµ‹æ¨¡å¼
)
```

#### è¯†åˆ«æµç¨‹
```python
def recognize_affixes(self, image_region):
    # 1. å›¾åƒé¢„å¤„ç†
    processed_image = self._preprocess_image(image_region)
    
    # 2. OCRè¯†åˆ«
    results = self.ocr.ocr(processed_image, cls=True)
    
    # 3. æ–‡å­—æå–å’ŒåŒ¹é…
    detected_affixes = self._extract_text_from_results(results)
    
    # 4. ç›®æ ‡è¯ç¼€åŒ¹é…
    return self._match_target_affixes(detected_affixes)
```

### é…ç½®ç¤ºä¾‹
```json
{
  "affix_reroll": {
    "enabled": true,
    "max_attempts": 100,
    "target_affixes": ["æš´å‡»ç‡", "æš´å‡»ä¼¤å®³", "æ”»å‡»åŠ›"],
    "enchant_button": [500, 600],
    "replace_button": [600, 700],
    "close_button": [700, 100],
    "ocr_region": [400, 300, 200, 400]
  }
}
```

---

## ğŸ—ºï¸ è‡ªåŠ¨å¯»è·¯ç³»ç»Ÿ

### æ¦‚è¿°
ä¸“ä¸ºéšæœºç”Ÿæˆåœ°å›¾è®¾è®¡ï¼Œé‡‡ç”¨**ç›¸ä½ç›¸å…³ä½ç§»è·Ÿè¸ª**å’Œ**A*ç®—æ³•**ï¼Œå®ç°æ™ºèƒ½åœ°å›¾æ¢ç´¢å’Œç²¾ç¡®è·¯å¾„è§„åˆ’ã€‚

### æ ¸å¿ƒæŠ€æœ¯æ¶æ„

#### ç¬¬ä¸€é˜¶æ®µï¼šåœ°å›¾è§£è¯»ä¸æ‹¼æ¥

**1. è·¯å¾„æå–**
```python
def extract_paths(minimap_frame):
    """ä»å°åœ°å›¾æå–å¯é€šè¡Œè·¯å¾„"""
    gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
    _, mask = cv2.threshold(gray, threshold, 255, cv2.THRESH_BINARY)
    
    # å½¢æ€å­¦æ“ä½œä¼˜åŒ–è·¯å¾„è¿é€šæ€§
    kernel = cv2.getStructuringElement(cv2.MORPH_ELLIPSE, (3, 3))
    closed = cv2.morphologyEx(mask, cv2.MORPH_CLOSE, kernel)
    opened = cv2.morphologyEx(closed, cv2.MORPH_OPEN, kernel)
    
    return opened
```

**2. ç›¸ä½ç›¸å…³ä½ç§»è·Ÿè¸ª**
```python
def track_displacement(prev_frame, curr_frame):
    """è®¡ç®—åœ°å›¾ç§»åŠ¨çš„åƒç´ ä½ç§»"""
    displacement, response = cv2.phaseCorrelate(prev_frame, curr_frame)
    confidence = response  # ç½®ä¿¡åº¦
    return displacement if confidence > 0.7 else None
```

**3. å…¨å±€åœ°å›¾æ‹¼æ¥**
```python
class GlobalMapBuilder:
    def __init__(self):
        self.global_map = np.zeros((5000, 5000), dtype=np.uint8)
        self.player_pos = (2500, 2500)  # ä¸­å¿ƒèµ·å§‹ç‚¹
    
    def update_global_map(self, current_paths, displacement):
        x, y = self.player_pos
        self.global_map[y:y+h, x:x+w] = cv2.add(
            self.global_map[y:y+h, x:x+w], current_paths
        )
```

#### ç¬¬äºŒé˜¶æ®µï¼šæ¢ç´¢ä¸è·¯å¾„è§„åˆ’

**1. "é™¤è‰æœº"æ¢ç´¢ç®—æ³•**
```python
class LawnmowerExplorer:
    """ç³»ç»Ÿæ€§åœ°å›¾æ¢ç´¢ç®—æ³•"""
    def __init__(self):
        self.direction = "right"
        self.row_height = 50
        
    def get_next_move(self, current_pos, explored_map):
        if self._can_continue_current_direction():
            return self._get_direction_vector()
        else:
            self._move_to_next_row()
            self._reverse_direction()
            return self._get_direction_vector()
```

**2. A*å¯»è·¯ç®—æ³•**
```python
class AStarPathfinder:
    def find_path(self, start, goal, obstacle_map):
        """A*ç®—æ³•å¯»æ‰¾æœ€ä¼˜è·¯å¾„"""
        open_set = []
        heapq.heappush(open_set, (0, start))
        came_from = {}
        g_score = {start: 0}
        f_score = {start: self._heuristic(start, goal)}
        
        while open_set:
            current = heapq.heappop(open_set)[1]
            
            if current == goal:
                return self._reconstruct_path(came_from, current)
            
            for neighbor in self._get_neighbors(current):
                tentative_g = g_score[current] + 1
                
                if neighbor not in g_score or tentative_g < g_score[neighbor]:
                    came_from[neighbor] = current
                    g_score[neighbor] = tentative_g
                    f_score[neighbor] = tentative_g + self._heuristic(neighbor, goal)
                    heapq.heappush(open_set, (f_score[neighbor], neighbor))
        
        return []  # æ— è·¯å¾„
```

### åŒæ¨¡å¼è¿è¡Œ

#### æ¢ç´¢æ¨¡å¼
- **ç›®æ ‡**ï¼šå‘ç°åœ°å›¾ä¸­çš„æ‰€æœ‰å¯é€šè¡ŒåŒºåŸŸ
- **ç­–ç•¥**ï¼šä½¿ç”¨"é™¤è‰æœº"ç®—æ³•ç³»ç»Ÿæ€§è¦†ç›–
- **è§¦å‘**ï¼šæœªå‘ç°ç›®æ ‡æ—¶è‡ªåŠ¨å¯ç”¨

#### å¯¼èˆªæ¨¡å¼
- **ç›®æ ‡**ï¼šä»å½“å‰ä½ç½®åˆ°ç‰¹å®šç›®æ ‡çš„æœ€çŸ­è·¯å¾„
- **ç­–ç•¥**ï¼šä½¿ç”¨A*ç®—æ³•è®¡ç®—æœ€ä¼˜è·¯å¾„
- **è§¦å‘**ï¼šå‘ç°ç›®æ ‡åè‡ªåŠ¨åˆ‡æ¢

### é…ç½®ç¤ºä¾‹
```json
{
  "pathfinding": {
    "enabled": true,
    "minimap_region": [1670, 50, 200, 200],
    "player_icon_color": [255, 255, 255],
    "path_color_range": [[100, 150, 100], [130, 255, 200]],
    "exploration_step": 50,
    "confidence_threshold": 0.7,
    "max_exploration_time": 300
  }
}
```

---

## ğŸ”„ æ¨¡å—ååŒå·¥ä½œ

### çŠ¶æ€ç®¡ç†ç»Ÿä¸€æ€§
æ‰€æœ‰åŠŸèƒ½æ¨¡å—éƒ½éµå¾ªç»Ÿä¸€çš„çŠ¶æ€æœºï¼š
```
STOPPED â†â†’ READY â†â†’ RUNNING â†â†’ PAUSED
```

### æ¨¡å¼äº’æ–¥æœºåˆ¶
- **æŠ€èƒ½æ¨¡å¼**ï¼šF8æ§åˆ¶ï¼Œå¤„ç†æŠ€èƒ½å¾ªç¯å’Œè¯å‰‚æ£€æµ‹
- **æ´—ç»ƒæ¨¡å¼**ï¼šF7æ§åˆ¶ï¼Œç‹¬ç«‹çš„è£…å¤‡è¯ç¼€æ´—ç»ƒ
- **å¯»è·¯æ¨¡å¼**ï¼šF9æ§åˆ¶ï¼Œè‡ªåŠ¨åœ°å›¾æ¢ç´¢å’Œå¯¼èˆª

### èµ„æºå…±äº«
- **å±å¹•æ•è·**ï¼šæ‰€æœ‰æ¨¡å—å…±äº«åŒä¸€å¸§æ•°æ®ï¼Œé¿å…é‡å¤æ•è·
- **è¾“å…¥é˜Ÿåˆ—**ï¼šç»Ÿä¸€çš„PriorityDequeå¤„ç†æ‰€æœ‰è¾“å…¥æ“ä½œ
- **é…ç½®ç®¡ç†**ï¼šConfigManagerç»Ÿä¸€ç®¡ç†æ‰€æœ‰æ¨¡å—é…ç½®

### äº‹ä»¶é€šä¿¡
```python
# æ¨¡å—é—´é€šè¿‡EventBusè¿›è¡Œé€šä¿¡
event_bus.publish("skill:cooldown_ready", skill_name="fireball")
event_bus.publish("resource:hp_low", current_hp=30)
event_bus.publish("pathfinding:target_found", target_pos=(100, 200))
```

é€šè¿‡è¿™ç§æ¨¡å—åŒ–å’Œäº‹ä»¶é©±åŠ¨çš„è®¾è®¡ï¼Œpyahkå®ç°äº†é«˜åº¦çµæ´»å’Œå¯æ‰©å±•çš„æ¸¸æˆè‡ªåŠ¨åŒ–åŠŸèƒ½ã€‚