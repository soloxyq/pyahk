# 09 调试模式与 Debug OSD

本章解释调试模式设计理念、状态机联动、数据发布机制、问题定位方法。适用于需要分析技能执行、资源检测、输入行为的开发与高级用户。

---
## 1. 设计目标
- 明确区分 READY 与 RUNNING：避免无意义的“空UI闪烁”
- 低侵入：调试逻辑不改变核心执行路径，仅监听与被动渲染
- 性能友好：暂停 / READY / STOPPED 时不做周期性数据采集
- 统一状态体验：与主状态机保持 STOPPED→READY→RUNNING↔PAUSED 一致

---
## 2. 组成组件

| 组件 | 职责 |
|------|------|
| `DebugDisplayManager` | 收集 & 发布调试数据（HP/MP/技能、动作）|
| `DebugOsdWindow` | 透明半透明层渲染；READY 显示提示；RUNNING 动态刷新 |
| `MacroEngine` | 控制何时 start/stop 发布；广播状态变化 |
| `InputHandler` | 在 dry_run 模式下将动作记录传入 DebugDisplayManager |

---
## 3. 状态机与发布逻辑

| 状态 | OSD 可见 | 周期发布 | 行为特征 |
|------|----------|----------|----------|
| STOPPED | 隐藏 | 否 | 清理数据/停止定时器 |
| READY | 显示“DEBUG OSD READY” | 否 | 仅等待进入 RUNNING，不采集数据 |
| RUNNING | 显示 | 是 | 250ms (示例) 周期更新；技能/资源/动作实时变化 |
| PAUSED | 显示最后一帧 | 否 | 停止调度保留快照 |

MacroEngine 在 `_update_osd_visibility()` 中基于当前 MacroState 判定是否调用 `debug_display_manager.start()/stop()`。

---
## 4. 数据结构

`DebugDisplayManager.publish_state()` 典型输出字典：
```jsonc
{
  "timestamp": 1736490000.123,
  "hp": 78,                // 估算剩余百分比（可选）
  "mp": 62,
  "skills": [              // 技能冷却/就绪状态文字行
    "技能A: Ready",
    "技能B: 3.5s",
    "技能C: In CD"
  ],
  "actions": [             // 最近动作（先进后出，长度≤10）
    {"text": "Cast A", "timestamp": 1736490000.120},
    {"text": "Use HP", "timestamp": 1736489999.950}
  ]
}
```

动作通过 `add_action(text)` 加入，内部维护 deque 或列表截断。

---
## 5. READY 阶段保持策略

问题：若启动即空数据进入周期刷新，会将标题提前覆盖为 RUNNING。

解决：
1. DebugDisplayManager 在 RUNNING 前调用 `start()` 才置 `is_active=True`
2. DebugOsdWindow `_update_display_from_state()` 内部基于 `has_data` 判定（技能列表或动作存在）才切换 RUNNING 标题
3. READY 阶段仅渲染一次 `_show_ready_state()`

---
## 6. dry_run 输入记录

- 目的：在不真实发送键鼠情况下验证逻辑顺序
- 启动：通过配置或启动参数设定 dry_run=True
- 行为：`InputHandler` 将准备发送的指令描述（如 "press:1"、"click:(960,540)"）调用 `debug_display_manager.add_action()` 记录
- 显示：OSD actions 区按逆序（最新在上）显示

---
## 7. 性能考量
- 发布间隔建议 ≥200ms，防止 UI 线程压力
- actions 长度限制避免字符串频繁拼接
- 技能状态构造应尽量缓存不变文本（如“Ready”常量）
- 资源处理建议只在调试启用时额外统计（可按需扩展开关）

---
## 8. 常见问题排查
| 现象 | 分析路径 | 可能原因 | 解决 |
|------|----------|----------|------|
| OSD 不出现 | 检查状态事件 | 当前仍 STOPPED | 按 F8/F9 进入 READY |
| 一直显示 READY | has_data 不满足 | 尚无技能/动作数据 | 进入 RUNNING 产生事件 |
| RUNNING 无更新 | `is_active`=False | 未正确调用 start | 检查 `_update_osd_visibility` | 
| 动作不记录 | dry_run 关闭 | 未启用 dry_run | 临时启用或添加测试钩子 |
| 技能行缺失 | `skills` 列表为空 | 冷却检测未运行 | 确认 Scheduler 任务是否添加 |

---
## 9. 事件参考
| 事件 | 触发点 | 数据 |
|------|--------|------|
| `debug_osd_show` | 进入 READY | 无 |
| `debug_osd_ready_state` | READY 文案显示 | title/提示文本 |
| `debug_osd_update` | 每次 publish_state | state 字典 |
| `debug_osd_hide` | STOPPED | 无 |

---
## 10. 扩展与自定义
- 新增字段：在 DebugDisplayManager 内扩展采集 + publish；OSD 解析增加渲染
- 条件显示：在 `_update_display_from_state()` 中按键开关判断是否展示某些段落
- 主题皮肤：修改窗口样式表（半透明 RGBA + 字体/颜色变量）
- 性能模式：添加“轻量”模式仅显示标题+少量计数

---
## 11. 未来增强建议
- 可拖拽改变位置并持久化
- 鼠标悬停显示更详细调试信息（Tooltip）
- 统计帧延迟 / 调度耗时曲线（微型 sparkline）
- 导出最近 N 秒调试数据为 JSON 以便回放

---
本章完。返回目录：`README` 或继续阅读下一章节。
