# 02 æ¶æ„ä¸æ ¸å¿ƒæ¦‚å¿µ

## æ¦‚è¿°

pyahk é‡‡ç”¨äº‹ä»¶é©±åŠ¨ä¸æ¨¡å—åŒ–åˆ†å±‚è®¾è®¡ï¼Œå›´ç»• EventBus è¿›è¡Œè§£è€¦é€šä¿¡ï¼Œä½¿ç”¨ç»Ÿä¸€è°ƒåº¦å™¨ï¼ˆUnifiedSchedulerï¼‰é©±åŠ¨å„åŠŸèƒ½æ¨¡å—ï¼Œå¹¶é€šè¿‡é›¶æ‹·è´å›¾åƒæ•è·å®ç°é«˜æ•ˆ I/Oã€‚åœ¨è¾“å…¥ä¾§ï¼Œå¼•å…¥â€œé€‰æ‹©æ€§äº‹ä»¶æ‹¦æˆª + åˆ†å±‚ä¼˜å…ˆçº§è¾“å…¥â€æ–°æ¶æ„ï¼Œå…¼é¡¾æ¸¸æˆåŸç”Ÿæ‰‹æ„Ÿä¸ç¨‹åºåŒ–ç²¾ç¡®æ§åˆ¶ã€‚

### æ¶æ„æ ¸å¿ƒç»„ä»¶

- **é€šä¿¡ä¸­æ¢**ï¼šEventBusï¼ˆå‘å¸ƒ/è®¢é˜…ã€çº¿ç¨‹å®‰å…¨ã€é€’å½’æ£€æµ‹é˜²æŠ¤ï¼‰
- **è¿è¡Œåè°ƒ**ï¼šMacroEngineï¼ˆå››çŠ¶æ€æœºã€æ¨¡å¼äº’æ–¥ã€ä¾èµ–æ³¨å…¥ï¼‰
- **å®šæ—¶è°ƒåº¦**ï¼šUnifiedSchedulerï¼ˆå•è°ƒæ—¶é’Ÿã€ä¼˜å…ˆé˜Ÿåˆ—ã€æ™ºèƒ½æš‚åœ/æ¢å¤ï¼‰
- **è¾“å…¥ç³»ç»Ÿ**ï¼šInputHandler + CtypesHotkeyManagerï¼ˆWindows Hookã€é€‰æ‹©æ€§æ‹¦æˆªã€å››çº§é˜Ÿåˆ—ã€æŒ‰é”®åºåˆ—ï¼‰
- **å›¾åƒæ•è·**ï¼šDXGI Desktop Duplicationï¼ˆC++ åŒç¼“å†² + åŸå­æŒ‡é’ˆï¼ŒPython é›¶æ‹·è´æ˜ å°„ï¼‰

### v2025.01 æ¶æ„å‡çº§

- **ç»Ÿä¸€é…ç½®ç®¡ç†**ï¼šResourceConfigManager å®ç°é…ç½®çš„ä¸­å¤®åŒ–ç®¡ç†å’Œçƒ­é‡è½½æœºåˆ¶
- **å¯è§†åŒ–å·¥å…·é›†æˆ**ï¼šColorAnalysisTools ä¸ UI ç³»ç»Ÿæ·±åº¦é›†æˆï¼Œæä¾›ç›´è§‚çš„é…ç½®ä½“éªŒ
- **æ™ºèƒ½æ€§èƒ½ä¼˜åŒ–**ï¼šä¼˜å…ˆçº§æŒ‰é”®æš‚åœæœºåˆ¶å‡çº§ï¼Œå®ç°çœŸæ­£çš„"é›¶åŠŸæ•ˆè®¡ç®—"
- **å¢å¼ºæ£€æµ‹ç®—æ³•**ï¼šçŸ©å½¢æ£€æµ‹ç®—æ³•ä¼˜åŒ–ï¼Œæ€§èƒ½æå‡82-803å€

---

## äº‹ä»¶é©±åŠ¨ä¸çŠ¶æ€æœº

### EventBusï¼ˆé€šä¿¡ä¸­æ¢ï¼‰
- å…¨å±€å•ä¾‹ã€çº¿ç¨‹å®‰å…¨è®¢é˜…/å‘å¸ƒï¼Œå¼‚æ­¥å›è°ƒä½¿ç”¨çº¿ç¨‹æ± ã€‚
- é€’å½’äº‹ä»¶æ£€æµ‹é¿å…ç¯è·¯ï¼Œä¿è¯åœ¨å¤æ‚è”åŠ¨ä¸‹çš„ç¨³å®šæ€§ã€‚

### MacroEngineï¼ˆç³»ç»Ÿåè°ƒä¸­å¿ƒï¼‰
- å››çŠ¶æ€æœºï¼šSTOPPED â†’ READY â†’ RUNNING â†’ PAUSEDï¼›ä¸¥æ ¼çš„çŠ¶æ€è½¬æ¢ä¸æƒé™æ£€æŸ¥ã€‚
- æ¨¡å¼äº’æ–¥ï¼šæŠ€èƒ½æ¨¡å¼ã€æ´—ç»ƒæ¨¡å¼ã€å¯»è·¯æ¨¡å¼çš„äº’æ–¥æ‰§è¡Œç®¡ç†ã€‚
- ç»Ÿä¸€å‘å¸ƒçŠ¶æ€ï¼šå¯¹ UI/OSD/æ—¥å¿—è¾“å‡ºæä¾›ä¸€è‡´çš„çŠ¶æ€å¿«ç…§ã€‚

### UnifiedSchedulerï¼ˆç»Ÿä¸€è°ƒåº¦å™¨ï¼‰
- **æ ¸å¿ƒæœºåˆ¶**ï¼šåŸºäº heapq çš„æ—¶é—´ä¼˜å…ˆé˜Ÿåˆ—ï¼Œtime.monotonic() ç²¾ç¡®è®¡æ—¶
- **ä»»åŠ¡ç®¡ç†**ï¼šæ”¯æŒä»»åŠ¡çš„æ–°å¢/ç§»é™¤/æ›´æ–°ã€ä¸€æ¬¡æ€§ä»»åŠ¡ä¸å‘¨æœŸä»»åŠ¡
- **æ™ºèƒ½æš‚åœ/æ¢å¤**ï¼šä¼˜å…ˆçº§æŒ‰é”®æ¿€æ´»æ—¶è‡ªåŠ¨æš‚åœæ‰€æœ‰è®¡ç®—å¯†é›†ä»»åŠ¡
- **é›¶åŠŸæ•ˆä¼˜åŒ–**ï¼šæš‚åœæœŸé—´å®Œå…¨åœæ­¢å¸§æ•è·ã€åƒç´ åˆ†æã€å†·å´æ£€æµ‹ç­‰æ— æ•ˆè®¡ç®—
- **æ™ºèƒ½æ¢å¤ç®—æ³•**ï¼šæ¢å¤æ—¶é‡ç®— next_run_timeï¼Œé¿å…ä»»åŠ¡å †ç§¯æ‰§è¡Œï¼Œç¡®ä¿æ­£å¸¸é—´éš”

---

## é€‰æ‹©æ€§äº‹ä»¶æ‹¦æˆªä¸åˆ†å±‚ä¼˜å…ˆçº§è¾“å…¥

æ–°æ¶æ„åŸºäº Windows ä½çº§ Hookï¼ˆCtypesHotkeyManagerï¼‰ï¼Œæ›¿ä»£ pynput ç›‘å¬å™¨ï¼Œå½»åº•ä¿®å¤ suppress å¯¼è‡´çš„å…¨å±€è¾“å…¥â€œå¡æ­»â€é—®é¢˜ï¼›å¹¶å¼•å…¥â€œæŒ‰é”®åˆ†å±‚ + é€‰æ‹©æ€§æ‹¦æˆª + å‰ç½®å»¶è¿Ÿâ€çš„ç»„åˆç­–ç•¥ï¼Œå®ç°æ‰‹æ„Ÿä¸å¯é æ€§çš„å¹³è¡¡ã€‚

### æŒ‰é”®åˆ†å±‚ä¸æ‹¦æˆªç­–ç•¥
- ç‰¹æ®ŠæŒ‰é”®ï¼ˆå¦‚ spaceï¼‰ï¼šsuppress="never"ï¼Œä¿æŒæ¸¸æˆåŸç”Ÿå“åº”ï¼›ç¨‹åºä»…ç›‘æ§ç‰©ç†çŠ¶æ€ç”¨äºè°ƒåº¦å™¨æš‚åœä¸æŠ€èƒ½æŠ‘åˆ¶ã€‚
- ç®¡ç†æŒ‰é”®ï¼ˆå¦‚ eã€right_mouseï¼‰ï¼šsuppress="always"ï¼Œç¨‹åºå®Œå…¨æ¥ç®¡ï¼›å¯åœ¨ç¨‹åºä¾§ç²¾ç¡®æ§åˆ¶å‰åæ‘‡ä¸æ—¶åºã€‚

å…¸å‹é…ç½®ï¼ˆæ–°æ¨èæ ¼å¼ï¼‰ï¼š
```json
{
  "priority_keys": {
    "enabled": true,
    "special_keys": ["space"],
    "managed_keys": {
      "right_mouse": { "target": "right_mouse", "delay": 50 },
      "e": { "target": "0", "delay": 30 }
    }
  }
}
```

è¯´æ˜ï¼š
- special_keys ä»…ç”¨äºâ€œç›‘æ§+æš‚åœâ€ï¼Œä¸æ‹¦æˆªç³»ç»Ÿäº‹ä»¶ï¼Œä¸éœ€è¦ target/delayã€‚
- managed_keys ä½¿ç”¨å¯¹è±¡æ ¼å¼ï¼šå¿…é¡»åŒ…å« targetï¼ˆå‘é€ç›®æ ‡é”®ï¼‰ä¸ delayï¼ˆå‰ç½®å»¶è¿Ÿï¼Œæ¯«ç§’ï¼‰ã€‚
- ä¸ºé¿å… Hook è‡ªæ‹¦æˆªï¼Œç®¡ç†æŒ‰é”®å¦‚éœ€â€œè‡ªå‘è‡ªæ”¶â€ï¼Œéœ€æ”¹ç”¨æ˜ å°„ï¼ˆä¾‹å¦‚æ‹¦æˆª E â†’ å‘é€ 0ï¼‰ã€‚

### å››çº§ä¼˜å…ˆé˜Ÿåˆ—

| ä¼˜å…ˆçº§ | åç§° | æ•°å€¼ | ç”¨ä¾‹ | æ‰§è¡Œç­–ç•¥ |
|--------|------|------|------|----------|
| emergency | ç´§æ€¥ | 0 | å‰ç½®å»¶è¿Ÿã€HP/MP è¯å‰‚ | æ°¸ä¸è¢«æš‚åœï¼Œç«‹å³æ‰§è¡Œ |
| high      | é«˜   | 1 | ä¼˜å…ˆçº§æŒ‰é”®æœ¬ä½“ã€æ ¸å¿ƒè¾“å‡º | éä¼˜å…ˆçº§æ¨¡å¼ä¸‹æ‰§è¡Œ |
| normal    | æ™®é€š | 2 | å¸¸è§„æŠ€èƒ½ã€Buff | è¢«ä¼˜å…ˆçº§æŒ‰é”®çŠ¶æ€æš‚åœ |
| low       | ä½   | 3 | UI/æ‹¾å–/è¾…åŠ© | è¢«ä¼˜å…ˆçº§æŒ‰é”®çŠ¶æ€æš‚åœ |

### å‰ç½®å»¶è¿Ÿï¼ˆå…³é”®å¯é æ€§ç­–ç•¥ï¼‰

é—®é¢˜ï¼šå‘å¸ƒâ€œæš‚åœâ€äº‹ä»¶ä¸æ¸¸æˆçŠ¶æ€åˆ‡æ¢å­˜åœ¨ç«æ€ï¼Œç›´æ¥å‘é€ä¼˜å…ˆçº§æŒ‰é”®å¯èƒ½è¢«â€œåæ‰â€ã€‚

ç­–ç•¥ï¼šå½“æ•è·ä¼˜å…ˆçº§æŒ‰é”®æŒ‰ä¸‹æ—¶ï¼Œå…ˆå‘ emergency é˜Ÿåˆ—æ’å…¥ delayXï¼Œå†å‘ high/emergency æ’å…¥æŒ‰é”®æœ¬ä½“ï¼Œç¡®ä¿â€œæš‚åœâ†’çŠ¶æ€åŒæ­¥â†’æŒ‰é”®â€çš„ä¸¥æ ¼æ—¶åºã€‚

æµç¨‹ï¼š
```
æŒ‰ä¸‹ä¼˜å…ˆçº§æŒ‰é”®ï¼ˆå¦‚ space/e/right_mouseï¼‰
  1) å‘å¸ƒ scheduler_pause_requested
  2) enqueue(emergency, delay50)
  3) enqueue(high/emergency, æŒ‰é”®æœ¬ä½“æˆ–æ˜ å°„ç›®æ ‡)
æ‰§è¡Œé¡ºåºï¼šå…ˆ delay50 â†’ å†æŒ‰é”®
```

### æŒ‰é”®åºåˆ—ä¸æ™ºèƒ½å»é‡
- key/alt_key æ”¯æŒé€—å·åˆ†å‰²åºåˆ—ï¼šå¦‚ "delay50,q"ã€"q,delay100,w"ã€‚
- å»é‡åŸåˆ™ï¼šæ•´ä½“åºåˆ—ä½œä¸ºå•å…ƒï¼›delay/è¯å‰‚ç­‰å…³é”®ä¸å»é‡ï¼›åºåˆ—æœ«å°¾è‡ªåŠ¨æ¨å…¥æ¸…ç†æ ‡è®°ä»¥è§£é”å†æ¬¡è§¦å‘ã€‚

---

## æ•°æ®æµä¸çº¿ç¨‹æ¨¡å‹

### å›¾åƒæ•°æ®æµ
```
DXGI Duplication (C++) â†’ é›¶æ‹·è´å…±äº«å†…å­˜ â†’ NativeGraphicsCaptureManagerï¼ˆctypesï¼‰
  â†’ BorderFrameManagerï¼ˆç¼“å­˜/æ¨¡æ¿ï¼‰ â†’ Skill/Resource/Pathfinding ç­‰æ¨¡å—
```

### ç”¨æˆ·è¾“å…¥æµï¼ˆ2025.10æœ€æ–°æ¶æ„ï¼‰
```
ç”¨æˆ·æŒ‰é”® â†’ AHK Hookæ‹¦æˆª â†’ AHKé˜Ÿåˆ—å¤„ç† â†’ SendInput/äº‹ä»¶å‘é€
                      â†“ WM_COPYDATA
Python: MainWindow/OSD â†’ SignalBridge â†’ AHK InputHandler â†’ EventBus â†’ MacroEngine
```

### WM_COPYDATAåŒå‘é€šä¿¡

**Python â†’ AHKï¼ˆå‘½ä»¤å‘é€ï¼‰**
```
Python: AHKCommandSender â†’ hold_client.py â†’ WM_COPYDATA â†’ AHKæœåŠ¡å™¨
å‘½ä»¤ç±»å‹ï¼šCMD_ENQUEUE, CMD_HOOK_REGISTER, CMD_SET_PYTHON_WINDOW_STATEç­‰
```

**AHK â†’ Pythonï¼ˆäº‹ä»¶æ¥æ”¶ï¼‰**
```
AHK: SendEventToPython() â†’ WM_COPYDATA â†’ Pythonçª—å£ â†’ SignalBridge â†’ EventBus
æ”¯æŒçª—å£ï¼šMainWindow (TorchLightAssistant_MainWindow_12345)
         OSDçª—å£ (TorchLightAssistant_OSD_12345)
```

### æ™ºèƒ½çª—å£å¥æŸ„ç¼“å­˜

**AHKç«¯ç¼“å­˜ç­–ç•¥**:
```ahk
// å…¨å±€çŠ¶æ€å˜é‡
global CurrentPythonWindow := "TorchLightAssistant_MainWindow_12345"  // é»˜è®¤ä¸»çª—å£
global CachedPythonHwnd := 0  // ç¼“å­˜çš„çª—å£å¥æŸ„

// å‘é€äº‹ä»¶æ—¶çš„ä¼˜åŒ–é€»è¾‘
SendEventToPython(event) {
    if (CachedPythonHwnd != 0) {
        if (SendWMCopyDataToPython(CachedPythonHwnd, event)) {
            return  // ä½¿ç”¨ç¼“å­˜æˆåŠŸ
        }
        CachedPythonHwnd := 0  // ç¼“å­˜å¤±æ•ˆï¼Œæ¸…é™¤
    }
    
    // é‡æ–°æŸ¥æ‰¾å½“å‰ç›®æ ‡çª—å£
    CachedPythonHwnd := WinExist(CurrentPythonWindow)
    if (CachedPythonHwnd) {
        SendWMCopyDataToPython(CachedPythonHwnd, event)
    }
}
```

**Pythonç«¯çŠ¶æ€åŒæ­¥**:
- F8åˆ‡æ¢åˆ°READY/RUNNING/PAUSED â†’ `set_python_window_state("osd")`
- F8åˆ‡æ¢åˆ°STOPPED â†’ `set_python_window_state("main")`
- AHKæ”¶åˆ°CMD_SET_PYTHON_WINDOW_STATEåç«‹å³æ›´æ–°CurrentPythonWindowå’Œæ¸…é™¤ç¼“å­˜

### çº¿ç¨‹å¸ƒå±€
- **GUI ä¸»çº¿ç¨‹**ï¼šUI/OSD ä¸äº¤äº’ï¼ŒWM_COPYDATAæ¶ˆæ¯å¤„ç†
- **AHK è¿›ç¨‹**ï¼šç‹¬ç«‹è¿›ç¨‹ï¼Œ10mså®šæ—¶å™¨å¤„ç†é˜Ÿåˆ—
- **UnifiedScheduler çº¿ç¨‹**ï¼šå®šæ—¶è°ƒåº¦ä¸²è¡Œæ‰§è¡Œ
- **åŠŸèƒ½æ¨¡å—çº¿ç¨‹**ï¼šå¯»è·¯ã€æ´—ç»ƒç­‰ç‹¬ç«‹çº¿ç¨‹
- **äº‹ä»¶æ€»çº¿çº¿ç¨‹æ± **ï¼šå¼‚æ­¥å›è°ƒ

---

## é…ç½®ç®¡ç†æ¶æ„ (v2025.01 æ–°å¢)

### ResourceConfigManager ä¸­å¤®åŒ–ç®¡ç†

å®ç°é…ç½®çš„ç»Ÿä¸€ç®¡ç†å’Œçƒ­é‡è½½æœºåˆ¶ï¼Œè§£å†³äº†ä¹‹å‰å„æ¨¡å—é…ç½®åˆ†æ•£ç®¡ç†çš„é—®é¢˜ã€‚

```python
class ResourceConfigManager:
    """Resources é…ç½®ç®¡ç†å™¨ - ä¸­å¤®åŒ–ç®¡ç† HP/MP é…ç½®"""
    
    def update_widget_from_config(self, widget, config):
        """ç»Ÿä¸€çš„ä»é…ç½®æ›´æ–°Widgetçš„æ–¹æ³•"""
        
    def generate_config_from_widget(self, widget):
        """ç»Ÿä¸€çš„ä»Widgetç”Ÿæˆé…ç½®çš„æ–¹æ³•"""
        
    def parse_colors_from_config(self, config):
        """ç»Ÿä¸€çš„é¢œè‰²è§£ææ–¹æ³•"""
```

**æ ¸å¿ƒä¼˜åŒ–**ï¼š
- æ¶ˆé™¤äº†å„Widgetä¸­é‡å¤çš„é…ç½®å¤„ç†ä»£ç 
- ç»Ÿä¸€äº†é¢œè‰²è§£æé€»è¾‘ï¼Œæ”¯æŒå¤šç§æ ¼å¼
- æä¾›äº†ç»Ÿä¸€çš„é…ç½®éªŒè¯å’Œé”™è¯¯å¤„ç†

### ColorAnalysisTools é›†æˆ

ä¸ UI ç³»ç»Ÿæ·±åº¦é›†æˆçš„å¯è§†åŒ–é¢œè‰²åˆ†æå·¥å…·ï¼š

```python
class ColorAnalysisTools:
    """Colors Analysis Tools - å¯è§†åŒ–é¢œè‰²åˆ†æå·¥å…·"""
    
    def start_region_selection(self, callback):
        """å¯åŠ¨åŒºåŸŸé€‰æ‹©æ¨¡å¼"""
        
    def start_color_picking(self, callback):
        """å¯åŠ¨é¢œè‰²é€‰æ‹©æ¨¡å¼"""
        
    def analyze_region_colors(self, region, target_colors=None):
        """åˆ†æåŒºåŸŸé¢œè‰²åˆ†å¸ƒå’Œæ¨èHSVå‚æ•°"""
```

**é›†æˆä¼˜åŠ¢**ï¼š
- ç›´è§‚çš„å¯è§†åŒ–æ“ä½œç•Œé¢
- å®æ—¶é¢„è§ˆHSVå‚æ•°è°ƒä¼˜æ•ˆæœ
- ä¸€é”®ç”Ÿæˆæœ€ä¼˜é…ç½®å‚æ•°
- ä¸ResourceConfigManageræ— ç¼é›†æˆ

---

## æ™ºèƒ½æ€§èƒ½ä¼˜åŒ–æ¶æ„ (v2025.01 å‡çº§)

### ä¼˜å…ˆçº§æŒ‰é”®æ™ºèƒ½æš‚åœ/æ¢å¤æœºåˆ¶

è§£å†³äº†ä¼ ç»Ÿæ¶æ„ä¸­çš„"é›¶åŠŸæ•ˆèµ„æºæµªè´¹"é—®é¢˜ï¼š

#### ä¼ ç»Ÿæ¶æ„é—®é¢˜
- âœ˜ ä¼˜å…ˆçº§æŒ‰é”®æ¿€æ´»æ—¶ï¼ŒæŠ€èƒ½æ‰§è¡Œè™½è¢«é˜»å¡ï¼Œä½†è°ƒåº¦å™¨ä»åœ¨è¿è¡Œ
- âœ˜ `check_cooldowns`ã€å¸§æ•è·ã€åƒç´ åˆ†æç­‰CPUå¯†é›†æ“ä½œæŒç»­æ‰§è¡Œä½†ç»“æœè¢«ä¸¢å¼ƒ
- âœ˜ åœ¨æ‰‹åŠ¨æ“ä½œæœŸé—´æ¶ˆè€—å¤§é‡ä¸å¿…è¦çš„è®¡ç®—èµ„æº

#### æ–°æ¶æ„è§£å†³æ–¹æ¡ˆ

å®ç°äº‹ä»¶é©±åŠ¨çš„æ™ºèƒ½æš‚åœ/æ¢å¤æœºåˆ¶ï¼š

```python
# äº‹ä»¶é©±åŠ¨æµç¨‹
ä¼˜å…ˆçº§æŒ‰é”®æŒ‰ä¸‹ (space/right_mouse)
    â†“
InputHandler._on_key_press() - æ£€æµ‹å¹¶è®°å½•
    â†“
ç¬¬ä¸€ä¸ªä¼˜å…ˆçº§æŒ‰é”® â†’ _pause_skill_scheduler()
    â†“
event_bus.publish('scheduler_pause_requested')
    â†“
SkillManager._on_scheduler_pause_requested()
    â†“
unified_scheduler.pause() - æš‚åœæ‰€æœ‰è°ƒåº¦ä»»åŠ¡
    â†“
ğŸ›‘ ç³»ç»Ÿè¿›å…¥"é›¶è®¡ç®—"æ¨¡å¼

ä¼˜å…ˆçº§æŒ‰é”®é‡Šæ”¾
    â†“
æ‰€æœ‰ä¼˜å…ˆçº§æŒ‰é”®é‡Šæ”¾ â†’ _resume_skill_scheduler()
    â†“
event_bus.publish('scheduler_resume_requested')
    â†“
SkillManager._on_scheduler_resume_requested()
    â†“
unified_scheduler.resume() - æ™ºèƒ½æ¢å¤è°ƒåº¦
    â†“
â–¶ï¸ é‡æ–°è®¡ç®—ä»»åŠ¡æ—¶é—´å¹¶æ¢å¤è¿è¡Œ
```

### æ€§èƒ½æå‡æŒ‡æ ‡

```
CPUä½¿ç”¨ç‡é™ä½ï¼š70-90% (åœ¨æš‚åœæœŸé—´)
å¸§æ•è·åœæ­¢ï¼šå®Œå…¨é¿å…æ— æ•ˆçš„å±å¹•æ•è·
åƒç´ åˆ†ææš‚åœï¼šåœæ­¢HSVè®¡ç®—å’Œæ¨¡æ¿åŒ¹é…
è°ƒåº¦ä»»åŠ¡æ•°ï¼šä»Nä¸ªæ´»è·ƒä»»åŠ¡é™è‡³0ä¸ª
```

### æ™ºèƒ½æ¢å¤ç®—æ³•

```python
def resume(self) -> bool:
    """æ™ºèƒ½æ¢å¤ - é¿å…ä»»åŠ¡å †ç§¯æ‰§è¡Œ"""
    self._paused = False
    current_time = self._now()
    
    # ğŸ”¥ å…³é”®ï¼šé‡æ–°è®¡ç®—æ‰€æœ‰ä»»åŠ¡çš„ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´
    for task in self._tasks.values():
        if task.enabled:
            task.next_run_time = current_time + task.interval
    
    self._rebuild_heap()  # é‡å»ºä¼˜å…ˆçº§å †
    self._condition.notify()  # å”¤é†’è°ƒåº¦çº¿ç¨‹
    return True
```

**æ™ºèƒ½æ¢å¤ç‰¹ç‚¹**ï¼š
- é¿å…æ¢å¤æ—¶çš„"ä»»åŠ¡é›ªå´©"
- é‡æ–°è®¡ç®—æ—¶é—´ï¼Œç¡®ä¿ä»»åŠ¡æ­£å¸¸é—´éš”æ‰§è¡Œ
- çº¿ç¨‹å®‰å…¨çš„çŠ¶æ€åˆ‡æ¢

---

## æ¶æ„è´¨é‡ä¸è¿‘æœŸå˜æ›´

### 2025.01ï¼šè¾“å…¥æ¶æ„å‡çº§
- ä» pynput è¿ç§»åˆ° CtypesHotkeyManagerï¼ˆWindows Hookï¼‰ï¼›ä¿®å¤å…¨å±€è¾“å…¥æ— å“åº”ã€‚
- é¼ æ ‡å·¦ä¸­å³é”® VK ä¸æ¶ˆæ¯å¸¸é‡è¡¥é½ï¼Œç»Ÿä¸€å¤„ç† L/R/M/X æŒ‰é”®ç”Ÿå‘½å‘¨æœŸã€‚

### 2025.10ï¼šAHKè¾“å…¥ç³»ç»Ÿå®Œå…¨é‡æ„
- **è¿›ç¨‹åˆ†ç¦»**ï¼šAHKç‹¬ç«‹è¿›ç¨‹ + WM_COPYDATAåŒå‘é€šä¿¡ï¼Œå®Œå…¨æ›¿ä»£Python Hook
- **å¼‚æ­¥delay**ï¼šDelayUntilçŠ¶æ€æœºï¼Œå®Œå…¨éé˜»å¡ï¼Œæ¶ˆé™¤æ‰€æœ‰Sleep()è°ƒç”¨
- **é›¶ç¡¬ç¼–ç **ï¼šæ‰€æœ‰æŒ‰é”®é…ç½®ç”±Pythonä¼ å…¥ï¼ŒAHKç«¯æ— ä¸šåŠ¡é€»è¾‘ç¡¬ç¼–ç 
- **æ™ºèƒ½ç¼“å­˜**ï¼šçª—å£å¥æŸ„ç¼“å­˜æœºåˆ¶ï¼Œæ”¯æŒä¸»çª—å£/OSDçª—å£è‡ªåŠ¨åˆ‡æ¢
- **ç»Ÿä¸€é˜Ÿåˆ—**ï¼šæ‰€æœ‰æŒ‰é”®æ“ä½œéƒ½èµ°å››çº§ä¼˜å…ˆé˜Ÿåˆ—ï¼Œé€»è¾‘æ¸…æ™°å¯æ§
- **åŒçª—å£æ”¯æŒ**ï¼šMainWindowå’ŒOSDéƒ½èƒ½æ¥æ”¶AHKäº‹ä»¶ï¼Œæ— ç¼åˆ‡æ¢

### 2025.10.17-18ï¼šç´§æ€¥æŒ‰é”®å¤„ç†ä¸åºåˆ—å»é‡å¢å¼º
- **ç´§æ€¥æŒ‰é”®ç¼“å­˜**ï¼šæ™ºèƒ½ç¼“å­˜HP/MPæŒ‰é”®é…ç½®ï¼Œç¡®ä¿ç”Ÿå­˜æŠ€èƒ½åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½èƒ½ä¼˜å…ˆæ‰§è¡Œ
- **åºåˆ—å»é‡æœºåˆ¶**ï¼šå®ç°IsSequenceActiveå‡½æ•°ï¼Œé˜²æ­¢å¿«é€Ÿé‡å¤æŒ‰é”®é€ æˆçš„åºåˆ—å†²çª
- **æ‰¹é‡é…ç½®æ›´æ–°**ï¼šæ–°å¢CMD_BATCH_UPDATE_CONFIG(19)å‘½ä»¤ï¼Œä¼˜åŒ–é…ç½®åŒæ­¥æ•ˆç‡
- **ProcessQueueå¢å¼º**ï¼šæ”¯æŒæš‚åœçŠ¶æ€ä¸‹ç´§æ€¥æ“ä½œçš„æ‰§è¡Œï¼Œç¡®ä¿HP/MPè¯å‰‚ä¸å—å½±å“
- **IsEmergencyActionå‡½æ•°**ï¼šæ™ºèƒ½è¯†åˆ«ç´§æ€¥æ“ä½œï¼Œç¡®ä¿å…³é”®åŠ¨ä½œä¸è¢«ç³»ç»Ÿæš‚åœæœºåˆ¶é˜»æ­¢

---

## æˆåŠŸæ ‡å‡†ï¼ˆå°ç»“ï¼‰
- ç‰¹æ®ŠæŒ‰é”®ï¼šä¿æŒåŸç”Ÿå“åº”ï¼›æŒ‰ä¸‹æœŸé—´è‡ªåŠ¨æš‚åœåå°è°ƒåº¦ï¼Œé‡Šæ”¾å³æ¢å¤ã€‚
- ç®¡ç†æŒ‰é”®ï¼šç¨‹åºæ¥ç®¡å¹¶å¯é æ‰§è¡Œï¼ˆå¿…è¦æ—¶é€šè¿‡æ˜ å°„è§„é¿è‡ªæ‹¦æˆªï¼‰ï¼Œæ—¶åºé€šè¿‡å‰ç½®å»¶è¿Ÿä¿è¯ã€‚
- ä»»æ„åºåˆ—ï¼šæŒ‰ä¼˜å…ˆçº§ä¸é˜²æŠ–ç­–ç•¥ç¨³å®šæ‰§è¡Œï¼›ç³»ç»Ÿåœ¨ä¼˜å…ˆçº§æœŸé—´â€œé›¶æ— æ•ˆè®¡ç®—â€ã€‚


---

## AHKè¾“å…¥ç³»ç»Ÿè¯¦è§£ï¼ˆ2025.10æœ€æ–°æ¶æ„ï¼‰

### æ ¸å¿ƒè®¾è®¡ç†å¿µ

**å®Œå…¨éé˜»å¡ + å•ä¸€æš‚åœæœºåˆ¶ + é›¶ç¡¬ç¼–ç **

- **å¼‚æ­¥delay**ï¼šDelayUntilçŠ¶æ€æœºï¼Œä¸ä½¿ç”¨Sleep()
- **ç»Ÿä¸€é˜Ÿåˆ—**ï¼šæ‰€æœ‰æŒ‰é”®æ“ä½œéƒ½èµ°é˜Ÿåˆ—ç³»ç»Ÿ
- **å•å±‚æš‚åœ**ï¼šåªåœ¨AHKå±‚æš‚åœï¼ŒPythonå±‚ä¸å‚ä¸
- **é›¶ç¡¬ç¼–ç **ï¼šæ‰€æœ‰æŒ‰é”®é…ç½®ç”±Pythonä¼ å…¥

### æŒ‰é”®æ¨¡å¼è¯¦è§£

| æ¨¡å¼ | AHKç¬¦å· | æ‹¦æˆª | é‡Šæ”¾äº‹ä»¶ | ç”¨é€” | ç¤ºä¾‹ |
|------|---------|------|---------|------|------|
| **intercept** | `$` | âœ… | âŒ | æŠ€èƒ½é”®ã€ç³»ç»Ÿçƒ­é”® | Q/W/E/Rã€F8/Z |
| **priority** | `$` | âœ… | âŒ | ç®¡ç†æŒ‰é”®ï¼ˆå»¶è¿Ÿ+æ˜ å°„ï¼‰ | Eâ†’Shift |
| **special** | `~` | âŒ | âœ… | ç‰¹æ®ŠæŒ‰é”®ï¼ˆæš‚åœç³»ç»Ÿï¼‰ | Space |
| **monitor** | `~` | âŒ | âœ… | ç›‘æ§æŒ‰é”®ï¼ˆçŠ¶æ€æ£€æµ‹ï¼‰ | Aé”®ï¼ˆå¼ºåˆ¶ç§»åŠ¨ï¼‰ |
| **block** | `$` | âœ… | âŒ | ç¦ç”¨æŒ‰é”® | - |

### ç®¡ç†æŒ‰é”®æ‰§è¡Œæµç¨‹ï¼ˆå¼‚æ­¥éé˜»å¡ï¼‰

```
ç”¨æˆ·æŒ‰Eé”®ï¼ˆé…ç½®ï¼štarget="+", delay=50ï¼‰:

æ—¶é—´0ms:
  AHK: HandleManagedKey()
  - æ‹¦æˆªEé”®ï¼ˆ$ç¬¦å·ï¼‰
  - SendEventToPython("managed_key_down:e")  // ä»…æ—¥å¿—
  - EmergencyQueue.Push("delay:50")
  - EmergencyQueue.Push("press:+")
  - ç«‹å³è¿”å›ï¼ˆéé˜»å¡ï¼‰âœ…

æ—¶é—´10ms:
  AHK: ProcessQueue()
  - å–å‡º"delay:50"
  - DelayUntil = A_TickCount + 50
  - ç«‹å³è¿”å›ï¼ˆéé˜»å¡ï¼‰âœ…

æ—¶é—´20-50ms:
  AHK: ProcessQueue()
  - æ£€æŸ¥DelayUntil > A_TickCount
  - ç›´æ¥return
  - æ‰€æœ‰é˜Ÿåˆ—è¢«å†»ç»“ï¼ˆç­‰å¾…æŠ€èƒ½åæ‘‡ï¼‰âœ…

æ—¶é—´60ms:
  AHK: ProcessQueue()
  - DelayUntil <= A_TickCount
  - DelayUntil = 0ï¼ˆè‡ªåŠ¨é‡ç½®ï¼‰
  - å–å‡º"press:+"
  - Send "{+}"ï¼ˆå‘é€Shifté”®ï¼‰âœ…

æ—¶é—´70ms:
  AHK: ProcessQueue()
  - é˜Ÿåˆ—æ­£å¸¸å¤„ç†âœ…
```

### å››çº§ä¼˜å…ˆé˜Ÿåˆ—

| ä¼˜å…ˆçº§ | åç§° | æ•°å€¼ | ç”¨ä¾‹ | æ‰§è¡Œç­–ç•¥ |
|--------|------|------|------|----------|
| emergency | ç´§æ€¥ | 0 | ç®¡ç†æŒ‰é”®delayã€HP/MPè¯å‰‚ | æ°¸è¿œæ‰§è¡Œï¼ˆå³ä½¿åœ¨delayæœŸé—´ï¼‰ |
| high      | é«˜   | 1 | æ ¸å¿ƒæŠ€èƒ½ã€é«˜ä¼˜å…ˆçº§æ“ä½œ | æ­£å¸¸æ‰§è¡Œ |
| normal    | æ™®é€š | 2 | å¸¸è§„æŠ€èƒ½ã€Buff | æ­£å¸¸æ‰§è¡Œ |
| low       | ä½   | 3 | UI/æ‹¾å–/è¾…åŠ© | æ­£å¸¸æ‰§è¡Œ |

### ProcessQueueå¤„ç†é€»è¾‘

```ahk
ProcessQueue() {
    // 1. æ£€æŸ¥å¼‚æ­¥delay
    if (DelayUntil > 0) {
        if (A_TickCount < DelayUntil) {
            return  // è¿˜åœ¨å»¶è¿Ÿä¸­ï¼Œæ‰€æœ‰é˜Ÿåˆ—å†»ç»“
        } else {
            DelayUntil = 0  // å»¶è¿Ÿç»“æŸï¼Œè‡ªåŠ¨æ¢å¤
        }
    }
    
    // 2. ä¼˜å…ˆå¤„ç†Emergencyé˜Ÿåˆ—
    if (EmergencyQueue.Length > 0) {
        ExecuteAction(EmergencyQueue.RemoveAt(1))
        return
    }
    
    // 3. æ£€æŸ¥æš‚åœæ ‡å¿—
    if (IsPaused || SpecialKeysPaused) {
        return
    }
    
    // 4. æŒ‰ä¼˜å…ˆçº§å¤„ç†å…¶ä»–é˜Ÿåˆ—
    // High â†’ Normal â†’ Low
}

SetTimer(ProcessQueue, 10)  // æ¯10msè°ƒç”¨ä¸€æ¬¡
```

### åŠ¨ä½œç±»å‹

| åŠ¨ä½œç±»å‹ | æ ¼å¼ | è¯´æ˜ | ç¤ºä¾‹ |
|---------|------|------|------|
| press | `press:key` | æŒ‰ä¸‹å¹¶é‡Šæ”¾æŒ‰é”® | `press:q` |
| hold | `hold:key` | æŒ‰ä½æŒ‰é”® | `hold:shift` |
| release | `release:key` | é‡Šæ”¾æŒ‰é”® | `release:shift` |
| delay | `delay:ms` | å¼‚æ­¥å»¶è¿Ÿï¼ˆéé˜»å¡ï¼‰ | `delay:50` |
| sequence | `sequence:keys` | æŒ‰é”®åºåˆ— | `sequence:delay50,q,delay100,w` |
| mouse_click | `mouse_click:button` | é¼ æ ‡ç‚¹å‡» | `mouse_click:left` |
| notify | `notify:event` | å‘é€äº‹ä»¶åˆ°Python | `notify:managed_key_up:e` |

### AHKå‘½ä»¤åè®®

**Pythonå‘é€ç»™AHKçš„å‘½ä»¤ID**ï¼š
```python
CMD_PING = 1                    # æµ‹è¯•è¿æ¥
CMD_ENQUEUE = 4                 # æ·»åŠ æŒ‰é”®åˆ°é˜Ÿåˆ—
CMD_HOOK_REGISTER = 8           # æ³¨å†ŒHook
CMD_HOOK_UNREGISTER = 9         # å–æ¶ˆHook
CMD_SET_PYTHON_WINDOW_STATE = 18 # è®¾ç½®Pythonçª—å£çŠ¶æ€
CMD_SET_MANAGED_KEY_CONFIG = 15  # è®¾ç½®ç®¡ç†æŒ‰é”®é…ç½®
CMD_CLEAR_HOOKS = 16            # æ¸…ç©ºæ‰€æœ‰å¯é…ç½®Hook
CMD_BATCH_UPDATE_CONFIG = 19    # æ‰¹é‡æ›´æ–°é…ç½® (æ–°å¢ 2025.10)
```

**AHKå‘é€ç»™Pythonçš„äº‹ä»¶**ï¼š
```
intercept_key_down:f8           # ç³»ç»Ÿçƒ­é”®è¢«æŒ‰ä¸‹
special_key_down:space          # ç‰¹æ®ŠæŒ‰é”®è¢«æŒ‰ä¸‹
special_key_pause:start         # ç‰¹æ®ŠæŒ‰é”®å¼•èµ·çš„ç³»ç»Ÿæš‚åœ
managed_key_down:e              # ç®¡ç†æŒ‰é”®è¢«æŒ‰ä¸‹
monitor_key_down:a              # ç›‘æ§æŒ‰é”®è¢«æŒ‰ä¸‹
```

### é…ç½®ç¤ºä¾‹

```json
{
  "stationary_mode_config": {
    "hotkey": "x",
    "mode_type": "shift_modifier",
    "force_move_hotkey": "a",
    "force_move_replacement_key": "f"
  },
  "priority_keys": {
    "enabled": true,
    "special_keys": ["space"],
    "managed_keys": {
      "e": {
        "target": "shift",     // Eé”®æ˜ å°„ä¸ºShifté”®
        "delay": 50          // å‰ç½®å»¶è¿Ÿ50ms
      },
      "right_mouse": {
        "target": "right_mouse",
        "delay": 30
      }
    }
  }
}
```

### ç³»ç»Ÿå¯åŠ¨ä¸è¿è¡Œæµç¨‹

**1. ç¨‹åºå¯åŠ¨åºåˆ—**ï¼š
```
main.py å¯åŠ¨
  â†’ MacroEngine åˆå§‹åŒ–
  â†’ AHKInputHandler åˆå§‹åŒ–
  â†’ å¯åŠ¨ hold_server_extended.ahk å­è¿›ç¨‹
  â†’ ç­‰å¾… 3 ç§’ (AHK_STARTUP_WAIT)
  â†’ AHKCommandSender æµ‹è¯•è¿æ¥ (CMD_PING)
  â†’ æ³¨å†Œ F8 æ ¹çƒ­é”® (CMD_HOOK_REGISTER)
  â†’ ç³»ç»Ÿå°±ç»ªï¼Œç­‰å¾…ç”¨æˆ·æ“ä½œ
```

**2. F8 çŠ¶æ€åˆ‡æ¢æµç¨‹**ï¼š
```
ç”¨æˆ·æŒ‰ F8
  â†’ AHK: HandleInterceptKey("f8")
  â†’ AHK: SendEventToPython("intercept_key_down:f8")
  â†’ Python: æ¥æ”¶ WM_COPYDATA æ¶ˆæ¯
  â†’ Python: è§¦å‘ _handle_f8_press()
  â†’ Python: çŠ¶æ€è½¬æ¢ STOPPED â†’ READY
  â†’ Python: æ³¨å†ŒåŠ¨æ€çƒ­é”® (z/F7/F9/ä¸šåŠ¡æŒ‰é”®)
  â†’ Python: å‘é€ CMD_SET_PYTHON_WINDOW_STATE("osd")
  â†’ AHK: æ›´æ–° CurrentPythonWindow ä¸º OSD çª—å£
  â†’ æ˜¾ç¤º OSDï¼Œéšè—ä¸»çª—å£
```

**3. ç®¡ç†æŒ‰é”®å¤„ç†æµç¨‹** (Eé”®ç¤ºä¾‹)ï¼š
```
ç”¨æˆ·æŒ‰ E é”®
  â†’ AHK: HandleManagedKey("e")
  â†’ AHK: æ‹¦æˆª E é”® (ä¸ä¼ é€’ç»™æ¸¸æˆ)
  â†’ AHK: EmergencyQueue.Push("delay:50")
  â†’ AHK: EmergencyQueue.Push("press:shift")
  â†’ AHK: SendEventToPython("managed_key_down:e")  // ä»…æ—¥å¿—
  â†’ AHK: ProcessQueue() å¤„ç†
     â†’ æ‰§è¡Œ "delay:50" â†’ DelayUntil = A_TickCount + 50
     â†’ ç­‰å¾…50ms...
     â†’ æ‰§è¡Œ "press:shift" â†’ Send "{shift}"
```

### å…³é”®ä¼˜åŒ–ç‚¹

1. **å¼‚æ­¥delay**ï¼šDelayUntilçŠ¶æ€æœºï¼Œå®Œå…¨éé˜»å¡ï¼Œæ¶ˆé™¤æ‰€æœ‰Sleep()
2. **åŒçª—å£æ”¯æŒ**ï¼šMainWindowå’ŒOSDéƒ½èƒ½æ¥æ”¶AHKäº‹ä»¶ï¼Œè‡ªåŠ¨åˆ‡æ¢
3. **æ™ºèƒ½ç¼“å­˜**ï¼šçª—å£å¥æŸ„ç¼“å­˜æœºåˆ¶ï¼Œå¤±æ•ˆè‡ªåŠ¨é‡æ–°æŸ¥æ‰¾
4. **é›¶ç¡¬ç¼–ç **ï¼šAHKç«¯æ— ä¸šåŠ¡é€»è¾‘ï¼Œæ‰€æœ‰é…ç½®ç”±PythonåŠ¨æ€ä¼ å…¥
5. **ç»Ÿä¸€é˜Ÿåˆ—**ï¼šæ‰€æœ‰æŒ‰é”®æ“ä½œéƒ½èµ°å››çº§ä¼˜å…ˆé˜Ÿåˆ—ï¼Œé€»è¾‘æ¸…æ™°
6. **çŠ¶æ€å»é‡**ï¼šmonitoræŒ‰é”®é¿å…é‡å¤å‘é€äº‹ä»¶ï¼Œæå‡æ€§èƒ½
7. **å®¹é”™æ¢å¤**ï¼šç¼“å­˜å¤±æ•ˆã€çª—å£å…³é—­ç­‰å¼‚å¸¸æƒ…å†µè‡ªåŠ¨å¤„ç†
8. **ç´§æ€¥æŒ‰é”®ç¼“å­˜**ï¼šæ™ºèƒ½ç¼“å­˜HP/MPæŒ‰é”®é…ç½®ï¼Œåœ¨ProcessQueueä¸­ä¼˜å…ˆå¤„ç†ç”Ÿå­˜æŠ€èƒ½
9. **åºåˆ—å»é‡é˜²æ­¢**ï¼šå®ç°æ´»è·ƒåºåˆ—è·Ÿè¸ªæœºåˆ¶ï¼Œé¿å…å¿«é€Ÿé‡å¤è§¦å‘å¯¼è‡´çš„æ€§èƒ½é—®é¢˜

---

## ç´§æ€¥æŒ‰é”®å¤„ç†ç³»ç»Ÿ (2025.10.17æ–°å¢)

### ç´¢æ€¥æŒ‰é”®ç¼“å­˜æœºåˆ¶

ä¸ºç¡®ä¿HP/MPç­‰ç”Ÿå­˜æŠ€èƒ½åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½èƒ½ä¼˜å…ˆæ‰§è¡Œï¼Œç³»ç»Ÿå®ç°äº†æ™ºèƒ½ç¼“å­˜æœºåˆ¶ï¼š

**AHKç«¯å®ç°**:
```ahk
; ç´§æ€¥æŒ‰é”®ç¼“å­˜å˜é‡
global CachedHPKey := ""
global CachedMPKey := ""

; ç´¢æ€¥æ“ä½œè¯†åˆ«å‡½æ•°
IsEmergencyAction(action) {
    if (InStr(action, "press:" . CachedHPKey) = 1) {
        return true
    }
    if (InStr(action, "press:" . CachedMPKey) = 1) {
        return true
    }
    if (InStr(action, "delay:") = 1) {
        return true  ; å»¶æ—¶ä¹Ÿè¢«è§†ä¸ºç´¢æ€¥æ“ä½œ
    }
    return false
}

; å¢å¼ºçš„ProcessQueueå¤„ç†
ProcessQueue() {
    ; 1. ç´¢æ€¥é˜Ÿåˆ—æ°¸è¿œä¼˜å…ˆå¤„ç†ï¼Œå³ä½¿åœ¨æš‚åœçŠ¶æ€ä¸‹
    if (EmergencyQueue.Length > 0) {
        action := EmergencyQueue.RemoveAt(1)
        ExecuteAction(action)
        return
    }
    
    ; 2. æ£€æŸ¥ç³»ç»Ÿæš‚åœçŠ¶æ€
    if (IsPaused || SpecialKeysPaused) {
        return  ; æ™®é€šæ“ä½œè¢«æš‚åœï¼Œä½†ç´¹æ€¥æ“ä½œä»å¯æ‰§è¡Œ
    }
    
    ; 3. å¤„ç†å…¶ä»–ä¼˜å…ˆçº§é˜Ÿåˆ—...
}
```

**Pythonç«¯é…ç½®åŒæ­¥**:
```python
# åœ¨é…ç½®æ›´æ–°æ—¶è‡ªåŠ¨åŒæ­¥ç´¢æ€¥æŒ‰é”®
def update_emergency_keys_cache(self):
    config = self.config_manager.get_config()
    hp_key = config.get("global", {}).get("resource_management", {}).get("hp_config", {}).get("key", "")
    mp_key = config.get("global", {}).get("resource_management", {}).get("mp_config", {}).get("key", "")
    
    # ä½¿ç”¨æ–°çš„æ‰¹é‡æ›´æ–°å‘½ä»¤
    self.command_sender.batch_update_config({
        "emergency_hp_key": hp_key,
        "emergency_mp_key": mp_key
    })
```

### åºåˆ—å»é‡ä¸æ´»è·ƒè·Ÿè¸ª

ä¸ºé˜²æ­¢å¿«é€Ÿé‡å¤æŒ‰é”®å¯¼è‡´çš„åºåˆ—å†²çªå’Œæ€§èƒ½é—®é¢˜ï¼Œå®ç°äº†æ™ºèƒ½å»é‡æœºåˆ¶ï¼š

**æ´»è·ƒåºåˆ—ç®¡ç†**:
```ahk
; æ´»è·ƒåºåˆ—æ˜ å°„è¡¨
global ActiveSequences := Map()

; æ£€æŸ¥åºåˆ—æ˜¯å¦æ­£åœ¨æ‰§è¡Œ
IsSequenceActive(sequenceId) {
    return ActiveSequences.Has(sequenceId) && ActiveSequences[sequenceId]
}

; åºåˆ—å¤„ç†å¢å¼º
ProcessSequence(sequenceStr, priority := 2) {
    sequenceId := "seq_" . sequenceStr  ; ç”Ÿæˆå”¯ä¸€ID
    
    ; å»é‡æ£€æŸ¥
    if (IsSequenceActive(sequenceId)) {
        return false  ; åºåˆ—æ­£åœ¨æ‰§è¡Œï¼Œæ‹’ç»é‡å¤æ·»åŠ 
    }
    
    ; æ ‡è®°åºåˆ—ä¸ºæ´»è·ƒçŠ¶æ€
    ActiveSequences[sequenceId] := true
    
    ; è§£æå¹¶æ·»åŠ åºåˆ—åŠ¨ä½œ
    keys := StrSplit(sequenceStr, ",")
    targetQueue := GetQueueByPriority(priority)
    
    for index, key in keys {
        key := Trim(key)
        if (key) {
            targetQueue.Push("press:" . key)
        }
    }
    
    ; æœ€åæ·»åŠ æ¸…ç†æ ‡è®°
    targetQueue.Push("cleanup_sequence:" . sequenceId)
    
    return true
}

; æ¸…ç†åºåˆ—æ ‡è®°
CleanupSequence(sequenceId) {
    if (ActiveSequences.Has(sequenceId)) {
        ActiveSequences.Delete(sequenceId)
    }
}
```

### æ‰¹é‡é…ç½®æ›´æ–°æœºåˆ¶

æ–°å¢CMD_BATCH_UPDATE_CONFIGå‘½ä»¤æ”¯æŒä¸€æ¬¡æ€§æ›´æ–°å¤šä¸ªé…ç½®é¡¹ï¼Œå‡å°‘é€šä¿¡å¼€é”€ï¼š

**Pythonç«¯è°ƒç”¨**:
```python
class AHKCommandSender:
    def batch_update_config(self, config_updates: dict):
        """æ‰¹é‡æ›´æ–°AHKé…ç½®"""
        data = json.dumps(config_updates)
        return self.send_ahk_cmd(CMD_BATCH_UPDATE_CONFIG, data)

# ä½¿ç”¨ç¤ºä¾‹
self.command_sender.batch_update_config({
    "emergency_hp_key": "c",
    "emergency_mp_key": "2", 
    "special_keys_config": ["space"],
    "managed_keys_config": {"e": {"target": "shift", "delay": 50}}
})
```

**AHKç«¯å¤„ç†**:
```ahk
HandleBatchConfigUpdate(jsonData) {
    try {
        configMap := JSON.Load(jsonData)
        
        ; æ›´æ–°ç´§æ€¥æŒ‰é”®ç¼“å­˜
        if (configMap.Has("emergency_hp_key")) {
            CachedHPKey := configMap["emergency_hp_key"]
        }
        if (configMap.Has("emergency_mp_key")) {
            CachedMPKey := configMap["emergency_mp_key"]
        }
        
        ; æ‰¹é‡æ›´æ–°å…¶ä»–é…ç½®...
        ; è¿™æ¯”é€ä¸ªå‘½ä»¤æ›´æ–°æ•ˆç‡æ›´é«˜
        
    } catch as e {
        ; é”™è¯¯å¤„ç†
    }
}
```
