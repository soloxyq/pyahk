# 01 项目概述与快速入门（精简版导航）

## 项目简介

**pyahk** 是一个基于 Python 和 C++ 的现代化桌面游戏自动化辅助工具，专为 ARPG 游戏（如《暗黑破坏神 4》、《流放之路 2》等）设计。采用先进的**事件驱动架构**和**零拷贝屏幕捕获技术**，提供毫秒级响应的技能循环自动化、智能药剂管理、装备词缀洗练、自动寻路和热键管理等功能。

## 技术特色

与传统的AutoHotkey脚本相比，pyahk采用现代化的技术架构：

- **事件驱动架构**：所有组件通过中央事件总线(EventBus)进行通信，实现高度解耦，支持递归事件检测和线程安全
- **零拷贝捕获技术**：基于DXGI Desktop Duplication API的C++底层实现，结合双缓冲区和原子指针技术，极大降低性能开销
- **统一调度器**：基于monotonic时间源的单线程调度器，提供亚毫秒级定时精度，支持任务的动态增删改和智能暂停/恢复
- **优先级输入系统**：使用四级优先队列(MultiPriorityQueue)实现紧急操作插队执行，支持按键序列和前置延迟机制
- **模块化设计**：清晰的功能分离，易于维护和扩展，支持插件系统和自定义模块
- **智能状态管理**：四状态状态机(STOPPED→READY→RUNNING→PAUSED)，支持模式互斥和热重载
- **高级调试系统**：内置性能监控、OSD调试显示、日志分析和配置验证

## 系统要求

- **操作系统**: Windows 10/11 (主要支持平台)
- **Python版本**: 3.7+
- **权限要求**: 部分功能需要管理员权限（如热键监听）
- **硬件要求**: 支持DXGI的显卡，4GB以上内存

## 快速开始

### 1. 环境准备

```bash
# 克隆项目
git clone <repository-url>
cd pyahk

# 安装依赖
pip install -r requirements.txt

# 编译C++捕获库 (如果需要)
cd native_capture
build.bat
cd ..
```

### 2. 首次启动

```bash
# 启动完整GUI版本
python main.py

# 或启动特殊自动化版本
python main_special.py
```

### 3. 基础配置

#### 热键设置
- **F8 (主控键)**: 在STOPPED和READY状态间切换，准备技能模式执行
- **F7 (洗练键)**: 独立控制装备词缀洗练模式的启动/停止
- **F9 (寻路键)**: 独立控制自动寻路模式的准备/停止
- **Z (执行/暂停键)**: 在READY状态下启动执行(RUNNING)，在RUNNING状态下暂停/恢复(PAUSED)

#### 配置文件
- 默认配置：`default.json`
- 游戏专用配置：`d4.json`、`poe2_锐眼.json`等
- 配置通过GUI界面进行可视化编辑

### 4. 核心功能速览

#### 技能自动化
```json
{
  "skills": [
    {
      "name": "主要技能",
      "key": "1",                    // 基础按键
      "alt_key": "delay50,shift+1",  // 按键序列支持
      "trigger_mode": 0,             // 0=定时, 1=冷却, 2=按住
      "interval": 1000,
      "cooldown_coords": [100, 50, 20, 20],
      "priority": false
    }
  ]
}
```

#### 智能药剂系统
```json
{
  "resource_management": {
    "hp_config": {
      "enabled": true,
      "key": "1",
      "threshold": 50,
      "detection_mode": "text_ocr",  // 矩形/圆形/text_ocr
      "ocr_engine": "template",      // template/keras/tesseract
      "text_x1": 97,
      "text_y1": 814,
      "text_x2": 218,
      "text_y2": 835
    }
  }
}
```

**三大类检测方式**:
- **矩形检测** ⭐ **推荐**: HSV模板匹配，**0.3ms**，100%成功率，96%误差<5%，适合条形资源条
- **圆形检测**: HSV颜色匹配，~5ms，适合球形资源条
- **Text OCR**: 数字识别，三种引擎可选
  - 模板匹配: ~25ms，98.3%成功率，无额外依赖
  - Keras模型: ~99ms，98.5%成功率，>99%准确率
  - Tesseract: ~241ms，99.0%成功率，无需训练

**🚀 新特性：按键序列**
- **延迟控制**：`delay50,q` - 延迟50ms后按q键
- **连招支持**：`q,delay100,w` - 按q键，等待100ms，按w键
- **复杂序列**：`delay50,1,delay200,2` - 多技能精确时机控制
- **组合键支持**：`shift+q,delay100,ctrl+w` - 组合键序列
- **智能去重**：防止重复序列执行，支持紧急操作插队

**🎯 优先级按键系统**
- **智能暂停**：空格/右键激活时自动暂停技能调度，节省CPU资源
- **前置延迟**：确保游戏响应时间，避免按键冲突
- **四级优先级**：emergency(紧急) > high(高) > normal(普通) > low(低)

**🔧 高级调试功能**
- **实时OSD**：显示FPS、状态、队列长度、性能指标
- **检测可视化**：技能冷却区域、资源条区域的实时覆盖显示
- **性能监控**：CPU使用率、内存占用、帧捕获统计
- **配置验证**：JSON语法检查、参数有效性验证

#### 智能药剂
```json
{
  "potions": [
    {
      "name": "生命药剂",
      "key": "2",
      "hp_threshold": 70,
      "region": [50, 100, 100, 20],
      "hsv_range": [[0, 180, 80], [10, 255, 255]]
    }
  ]
}
```

## 状态机理解

pyahk使用严格的四状态管理：

```
STOPPED ←→ READY ←→ RUNNING ←→ PAUSED
   ↑                              ↓
   └─────────── 直接停止 ←─────────────┘
```

- **STOPPED**: 所有功能停止，热键监听关闭
- **READY**: 系统准备就绪，等待执行信号
- **RUNNING**: 功能模块正常运行，执行自动化任务
- **PAUSED**: 暂时挂起执行，保持状态但停止操作

## 使用模式

### 模式一：技能循环自动化
1. 按F8进入READY状态
2. 配置技能列表和触发条件
3. 按Z开始RUNNING
4. 系统自动执行技能循环

### 模式二：装备洗练
1. 按F7启动洗练模式
2. 配置目标词缀和操作坐标
3. 系统自动识别词缀并重铸

### 模式三：自动寻路探索
1. 按F9准备寻路模式
2. 系统自动探索地图并寻找目标

## 安全提示

- 请遵守游戏服务条款
- 建议在单机或允许的环境下使用
- 定期备份配置文件
- 注意系统资源占用

## 精简后的文档结构（6 篇）

为便于上手与维护，Wiki 压缩为 6 篇核心文档：

1) 01-项目概述与快速入门（本文）
2) 02-架构与核心概念（原 02 + 选择性事件拦截更新）
3) 03-功能模块与 API（原 03 + 09 合并）
4) 04-配置与条件系统（已更新优先级按键“映射对象”格式）
5) 05-图像捕获与性能（保留性能与优化建议）
6) 06-调试、部署与故障排查（原 06 + 07 + 08 合并）

额外说明文档（优先级按键暂停/恢复、选择性事件拦截）已融入 02/06 中，避免重复。