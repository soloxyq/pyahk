# 故障排查手册

本文档提供了常见问题的诊断和解决方案。

---

## 📋 目录

1. [文本OCR识别失败](#文本ocr识别失败)
2. [HSV颜色检测失败](#hsv颜色检测失败)
3. [性能问题](#性能问题)
4. [配置问题](#配置问题)

---

## 1. 文本OCR识别失败

### 问题现象
- HP/MP数值显示为 0/0 或百分比异常
- 识别文本为空字符串或错误
- 识别返回 -1.0（识别失败）

### 诊断步骤

#### 步骤1：检查Tesseract OCR安装和配置
**这是最常见的问题原因！**

1. **验证安装**：
   ```bash
   # 在命令行测试Tesseract是否正确安装
   "D:\Program Files\Tesseract-OCR\tesseract.exe" --version
   ```
   
2. **检查配置**：
   - 打开 `default.json`
   - 确认 `global.tesseract_ocr.tesseract_cmd` 路径正确
   - 默认路径：`D:\\Program Files\\Tesseract-OCR\\tesseract.exe`

3. **性能测试**：
   ```bash
   cd d:\repogit\pyahk
   python benchmark_ocr_performance.py
   ```
   应该看到识别结果：`540/540` → 100% 和 `253/253` → 100%

#### 步骤2：检查文本区域坐标
1. 打开调试模式：勾选"显示调试信息"
2. 查看识别区域是否正确框选了HP/MP数字
3. 如果区域不准确：
   - 使用"选择区域"按钮重新框选
   - 确保区域完整包含数字文本（如 540/540）
   - 不要包含过多背景或其他UI元素
   - 典型坐标参考：
     - HP: `(97, 814, 218, 835)` - 左下角
     - MP: `(1767, 814, 1894, 835)` - 右下角

#### 步骤3：使用测试按钮验证
1. 在HP/MP配置界面选择 **"数字匹配 (Text OCR)"** 模式
2. 点击 **"🧪 测试识别"** 按钮
3. 选择一张游戏截图
4. 查看识别结果和预处理图像
5. 如果识别失败，检查：
   - 截图分辨率是否与游戏运行时一致
   - 数字区域是否清晰可见
   - 坐标是否准确

#### 步骤4：调整OCR参数（高级）
如果识别仍有问题，可以尝试调整配置：

1. **PSM模式**（`default.json` → `global.tesseract_ocr.psm_mode`）：
   - `7`：单行文本（默认，推荐）
   - `6`：单个文本块
   - `8`：单个单词
   - `13`：原始行

2. **字符白名单**（`psm_mode.char_whitelist`）：
   - 默认：`0123456789/`
   - 如果识别到其他字符，检查是否需要扩展

### 调试技巧

启用调试模式查看预处理效果：
```python
# 在测试代码中
text, percentage = ocr_manager.recognize_and_parse(frame, region, debug=True)
```

这会显示：
- 原始ROI图像
- 放大3倍后的图像
- OTSU二值化后的图像
- 最终识别结果

### 快速检查清单
- [ ] Tesseract是否正确安装？→ 运行 `tesseract --version`
- [ ] 配置路径是否正确？→ 检查 `default.json`
- [ ] 性能测试是否通过？→ 运行 `benchmark_ocr_performance.py`
- [ ] 文本区域坐标是否准确？→ 使用"选择区域"重新框选
- [ ] 测试按钮识别是否成功？→ 使用"🧪 测试识别"验证
- [ ] 是否在特殊光照环境？→ 确认自适应阈值已启用
- [ ] 字体是否变粗/变细？→ 确认多尺度匹配已启用

---

## 2. HSV颜色检测失败

### 问题现象
- 矩形/圆形检测模式下识别不准确
- 误报或漏报资源低阈值

### 诊断步骤

#### 步骤1：调整HSV容差
1. 在GUI中逐步增加容差值（默认15）
2. 测试范围：10 → 15 → 20 → 25
3. 观察检测区域的颜色覆盖是否改善

#### 步骤2：重新框选颜色区域
1. 使用"选择区域"按钮
2. 确保选择的区域包含代表性的颜色样本
3. 避免选择边缘或渐变区域

#### 步骤3：检查光照影响
- HSV比RGB对光照更鲁棒，但极端情况仍会受影响
- 如果HSV检测不稳定，考虑切换到文本OCR模式

---

## 3. 性能问题

### 问题现象
- 系统响应延迟
- CPU占用过高
- 识别速度变慢

### 诊断步骤

#### 检查捕获模式
1. Windows Graphics Capture 性能最优（推荐）
2. 如果使用GDI/BitBlt，性能会下降

#### 检查识别模式
- **文本OCR**: < 10ms（最快）
- **矩形检测**: ~5ms
- **圆形检测**: ~5ms

#### 优化建议
1. 优先使用文本OCR模式（如果适用）
2. 降低检测频率（增加检测间隔）
3. 减少同时监控的资源数量

---

## 4. 配置问题

### 配置文件损坏
**症状**：程序启动失败或配置无法保存

**解决方案**：
```bash
# 重置为默认配置
cd d:\repogit\pyahk
cp default.json current_config.json
```

### 坐标格式错误
**正确格式**：
- 矩形: `x1,y1,x2,y2` （例如：97,814,218,835）
- 圆形: `x,y,r` （例如：100,100,50）
- 文本: `x1,y1,x2,y2` （例如：97,814,218,835）

---

## 🔧 高级调试

### 启用全局调试日志
```python
from torchlight_assistant.utils.debug_log import set_debug_level
set_debug_level("DEBUG")  # 输出详细日志
```

### 保存调试帧
```python
# 在 border_frame_manager.py 中
cv2.imwrite(f"debug_frame_{frame_count:04d}.png", frame)
```

### 性能分析
```python
import time
start = time.perf_counter()
result = recognizer.recognize_and_parse(frame, region)
elapsed = (time.perf_counter() - start) * 1000
print(f"识别耗时: {elapsed:.2f}ms")
```

---

## 📞 获取帮助

如果以上方法都无法解决问题：

1. 查看完整文档：`wiki/01-项目概述与快速入门.md`
2. 检查技术实现细节：`wiki/03-功能模块与API.md`
3. 查看性能优化指南：`wiki/05-图像捕获与性能.md`

---

## 🎯 核心要点总结

1. **文本OCR识别失败 → 首先检查游戏分辨率/UI缩放是否改变**
2. **多尺度匹配和自适应阈值已默认启用，大多数情况无需手动调整**
3. **置信度 < 0.75 通常意味着需要重新生成模板**
4. **文本OCR模式性能和准确性都优于HSV检测（在适用场景下）**
