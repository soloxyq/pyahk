# 10 输入系统

本章描述输入执行的内部机制，包括按键/鼠标模拟、优先级队列、按住(Hold)集成、与 AHK 服务的通信协议以及 dry_run 调试模式。

---
## 1. 设计目标
- 统一入口：所有输入通过 `InputHandler`
- 可预测顺序：使用线程安全队列保障先进先出（高优先级插入头部）
- 低延迟：最小化阻塞操作，必要时短暂 sleep 节流
- 可回放：dry_run 模式下记录行为便于验证

---
## 2. 关键组件

| 组件 | 职责 |
|------|------|
| InputHandler | 输入调度与执行；维护队列、线程、优先级插入 |
| HotkeyManager | 全局热键监听，转换为内部事件 |
| hold_server.ahk | 接收 WM_COPYDATA，执行按住/释放 | 
| DebugDisplayManager | 接收 dry_run 动作文本，供 OSD 展示 |

---
## 3. 队列与执行流程
1. 技能逻辑决定“需要发送某键” → 调用 `InputHandler.enqueue_action(action, priority)`
2. 若 `priority=True`，插入队列头；否则尾部
3. 后台执行线程循环：
   - 从队列取出 action
   - 解析类型：`key_press`, `mouse_click`, `hold_press`, `hold_release` 等
   - 根据 dry_run 决定是否真实发送
4. 真实输入调用底层库（pynput / win32api）或 AHK 服务

---
## 4. Hold (按住) 模式

| 阶段 | 行为 |
|------|------|
| 进入 RUNNING | 遍历 TriggerMode=2 技能 → `hold:key` |
| PAUSED / STOPPED | 对仍处于按住状态的技能发送 `release:key` |
| 配置热更新 | 新增的按住技能立即 `hold`；移除的立即 `release` |

优势：不占用调度器；简单稳定；避免误多次按下。

---
## 5. 与 AHK 服务通信

- Windows 消息：`WM_COPYDATA`
- 目标窗口：默认标题 `HoldServer_Window_UniqueName_12345`（可配置）
- 数据格式：UTF-8 文本
```
"hold:ctrl+shift+w"
"release:ctrl+shift+w"
```
- AHK 端解析后调用 `Send`/`SendInput` 执行
- 失败处理：未找到窗口 → 返回 False，记录日志；其余功能不受影响

---
## 6. 动作类型示例

| 类型 | 描述 | 备注 |
|------|------|------|
| key_press | 发送一次按键（如 `1`） | 常规技能 |
| key_combo | 组合键（`ctrl+e`） | 按顺序按下/释放 |
| mouse_click | 在坐标(x,y)点击 | 寻路/移动 |
| hold_press | 按住技能键 | Hold 模式进入 RUNNING |
| hold_release | 释放已按住键 | 状态退出或暂停 |

---
## 7. dry_run 模式

| 项 | 说明 |
|----|------|
| 启用方式 | 配置或启动参数（示例：`Global.Debug`）|
| 行为变化 | 不执行真实键鼠；改为记录动作文本 |
| 记录位置 | `DebugDisplayManager.actions` |
| 典型用途 | 快速验证优先级、条件逻辑、序列模式 |

动作文本格式建议：`press:1` / `hold:start:ctrl+w` / `click:(960,540)`。

---
## 8. 优先级策略
- 高优先级技能插队：插入到队列头部
- 防止“饿死”：不建议大量低价值技能设为高优先级
- 队列长度可监控（未来可加入告警）

---
## 9. 常见问题排查
| 现象 | 原因 | 解决 |
|------|------|------|
| Hold 不生效 | AHK 进程未启动 | 启动 hold_server.ahk |
| 输入延迟 | 队列积压 | 检查是否存在超频定时任务 |
| 动作顺序错乱 | 非线程安全修改队列 | 确认只通过 API 插入 |
| dry_run 下仍发送 | 标志未正确传递 | 检查构造 InputHandler 参数 |
| 组合键释放异常 | 释放顺序错误或遗漏 | 调整为逆序释放 |

---
## 10. 扩展建议
- 增加速率限制器（token bucket）
- 动作压缩（合并冗余相同按键）
- 失败重试（窗口未激活时延迟重发）
- 指标输出（平均排队时间）

---
本章完。返回目录：`README` 或继续阅读下一章节。
