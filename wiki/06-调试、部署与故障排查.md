# 06 调试、部署与故障排查（合订本）

本章合并原《06 调试与开发》《07 部署与运维》《08 故障排查手册》，提供从开发调试、性能分析、环境部署到问题排查的一体化指南。

---

## 一、调试与开发（摘编增强）

### 调试模式与OSD
- 通过配置 debug.enabled 开启；或使用 F7/FPS/性能统计热键。
- OSD 显示：状态机、FPS、输入队列长度、捕获/检测耗时、调度器暂停统计等。

### 可视化与日志
- 技能/资源检测区域覆盖，路径点与障碍可视化。
- 分模块 Logger 与节流日志（ThrottledLogger），避免高频刷屏。

### 性能监控要点
- 暂停/恢复事件计数、暂停持续时长、CPU 节约率（优先级按键期间）。
- Scheduler 恢复时重算 next_run_time，避免堆积执行。

### 基础开发环境
- Python >= 3.8；依赖见 requirements.txt。
- C++ DXGI 捕获：VS Build Tools + CMake，native_capture/build.bat 一键编译。

---

## 二、部署与运维（整合）

### 环境要求与权限
- Windows 10/11；管理员权限（全局热键与窗口激活）。
- 显卡支持 DXGI；若 DLL 加载失败，安装 VC++ Redistributable。

### 依赖安装
- 在线：pip install -r requirements.txt
- 国内镜像/离线包：支持下载到 offline_packages 后离线安装。

### 目录与配置
```
pyahk/
  main.py, main_special.py, default.json, native_capture/, torchlight_assistant/, wiki/
```
- 建议将实际使用的配置复制为 my_config.json 并通过 GUI 维护。

### 服务化与计划任务（可选）
- Windows 服务脚本（pywin32）；计划任务以 SYSTEM 最高权限开机启动。

### 运维监控
- 轮转日志、性能采集脚本（CPU/内存/线程），健康检查（进程/内存/日志异常）。

---

## 三、故障排查（整合要点）

### A. 输入系统相关
1) 程序启动后输入"卡死"或需按右键才恢复
- 2025.01 起已迁移到 Windows Hook，更新至最新版本即可根治。

2) 优先级按键无效或双重触发
- 检查是否区分 special_keys 与 managed_keys；管理按键建议"拦截→映射发送"。
- 查看日志是否打印"优先级按键监听已启动"。

3) 鼠标键（left/right/middle）不识别
- 已补齐 VK 与 WM 常量；若仍异常，检查杀软/权限以及 Hook 注册错误输出。

4) 切换配置文件后热键失效（原地模式/交互键）
- **症状**: 从 default.json 切换到其他配置文件后，X/A 等可配置热键不响应
- **原因**: 键角色转换冲突（如 X 键从 force_move 转为 stationary 时被错误 unregister）
- **修复**: 已采用"先取消所有可配置热键，再重新注册"策略（v2025.01.11+）
- **验证**: 查看日志中 `[热键管理] 取消注册所有可配置热键` 和 `成功注册热键 'stationary': x`

5) 原地模式切换成功但技能键未添加 Shift 修饰符
- **症状**: OSD 显示已进入原地模式，但技能键实际效果未变化
- **原因**: InputHandler 未从配置中更新 `_cached_stationary_mode_type`
- **修复**: 已在 `_on_config_updated` 中添加 stationary_mode_config 读取（v2025.01.11+）
- **验证**: 查看日志 `[输入处理器] 原地模式类型已更新: shift_modifier`

### B. 图像捕获与识别 (v2025.01 升级指南)

#### 捕获问题
- **DLL load failed**：重装 VC++ Redistributable，重编原生库；必要时降级到 MSS 备用方案。
- **帧率低**：检查是否使用了DXGI零拷贝捕获，确认native_capture库正常加载。

#### 检测准确率问题 (v2025.01 优化指南)

**第一步：选择最优检测方法**
- ✅ **矩形检测**：0.3ms，100%成功率，96%+准确率 (推荐 ⭐)
- ⚠️ **OCR检测**：25-241ms，性能慢82-803倍，仅在必要时使用

**第二步：使用ColorAnalysisTools可视化配置**
1. GUI中点击"颜色分析工具"按钮
2. 可视化选择HP/MP检测区域
3. 自动优化HSV参数
4. 实时预览检测效果

**第三步：传统调优方法(如需)**
- **冷却检测不准**：缩小 ROI、缓存模板、启用中心区域检测与连续性窗口。
- **HSV 检测不准**：
  1. 确认已按F8初始化模板（满血满蓝状态）或使用ColorAnalysisTools
  2. 调整HSV容差参数（tolerance_h/s/v）或使用自动优化
  3. 检查区域坐标是否准确框选资源条
  4. 查看性能测试报告：`python performance_test/perf_full_benchmark.py`

#### 检测性能问题 (v2025.01 优化指南)

**第一優先级：检测方法优化** 🚀
- ❌ **OCR性能灾难**：如果正在使用OCR，立即切换到矩形检测
  - OCR: 25-241ms (慢82-803倍)
  - 矩形检测: 0.3ms (基准)
- ✅ **矩形检测** (最佳选择)：0.3ms，100%成功率，96%+准确率
- ✅ **圆形检测** (备选)：~5ms，99%+成功率，适合球形资源条

**第二优先级：使用v2025.01新工具** ✨
- 使用ColorAnalysisTools一键优化配置
- ResourceConfigManager统一管理，消除配置问题
- 实时预览检测效果，可视化调优

#### 检测失败问题
- **OCR识别失败**：
  - 检查文本区域坐标是否准确
  - 尝试不同的OCR引擎（Template/Keras/Tesseract）
  - 考虑切换到矩形检测（更可靠，100%成功率）
- **矩形检测失败**：
  - 确认已按F8初始化模板
  - 检查HSV容差是否合适
  - 查看debug_frame截图验证区域

### C. 性能与资源
- 优先级按键期间应“零无效计算”（帧捕获/检测/调度暂停）；如未生效，检查事件订阅与 Scheduler 状态。
- CPU 高：调大捕获/检测间隔，合并任务，降低调试刷新频率。

### D. OCR/依赖

#### OCR相关问题
- **paddleocr 初始化失败**：清缓存重新安装；将其设为可选模块并保护导入。
- **OCR性能慢**：
  - Template OCR: ~25ms（最快的OCR）
  - Keras OCR: ~99ms（最准确）
  - Tesseract OCR: ~241ms（最慢）
  - **建议**：如果不是必须识别数字文本，切换到矩形检测（0.3ms，快82-803倍）
- **OCR识别错误**：
  - 实测478次中有8个OCR错误案例（百分比>100%）
  - 矩形检测在这些情况下仍能给出合理值
  - 考虑使用矩形检测作为主要方法，OCR作为备用

### E. 配置与序列
- 校验按键序列 delayX 规范、逗号分隔；检查 managed_keys 对象格式 {target, delay}；避免自拦截。

---

## 四、工具与脚本（精选）

### v2025.01 性能测试工具 🛠️

#### 完整基准测试套件
```bash
# 运行完整性能基准测试
python performance_test/perf_full_benchmark.py
```

**v2025.01 增强功能**：
- 测试所有检测方法（矩形、圆形、3种OCR）的性能和准确率
- **新增**：矩形检测算法优化前后对比
- **新增**：性能对比图表自动生成
- **新增**：检测方法推荐等级评分
- 识别OCR错误案例和异常数据点
- 输出文件：`performance_test/benchmark_results.json`

**实测数据**：
- 测试样本：478次真实游戏截图
- 游戏环境：多种光照条件和UI状态
- 统计指标：平均耗时、成功率、准确率、标准差

---

## 五、v2025.01 新功能故障排查

### A. ColorAnalysisTools 故障排查

#### 区域选择问题

**问题：点击区域选择按钮无响应**
- 原因：没有管理员权限或窗口被其他程序遮挡
- 解决：以管理员身份运行，关闭其他覆盖窗口

**问题：选择区域后颜色分析失败**
- 原因：区域太小或颜色单一
- 解决：选择较大区域（至少20x20像素），包含多种颜色

#### HSV优化问题

**问题：自动优化后检测效果仍然不佳**
- 解决：
  1. 尝试不同的优化模式（strict/balanced/tolerant）
  2. 手动采样更多颜色点
  3. 检查光照条件是否过于复杂

**问题：预览检测结果不稳定**
- 原因：游戏内光照变化或UI动画影响
- 解决：在稳定的游戏场景下进行配置，适当增大HSV容差

### B. ResourceConfigManager 故障排查

#### 配置加载问题

**问题：配置更新后Widget显示错误**
- 原因：配置格式不兼容或数据类型错误
- 解决：
  1. 检查日志中的配置验证错误信息
  2. 使用`ResourceConfigManager.validate_config()`进行验证
  3. 对比新旧配置格式差异

**问题：热重载配置失败**
- 原因：JSON语法错误或文件被占用
- 解决：
  1. 使用JSON校验工具检查文件格式
  2. 确保文件没有被其他程序占用
  3. 重启程序并重新加载配置

### C. 智能暂停/恢复机制问题

#### 暂停机制不生效

**问题：优先级按键激活时系统仍在消耗CPU**
- 排查步骤：
  1. 检查日志中是否有`scheduler_pause_requested`事件
  2. 确认UnifiedScheduler正在使用最新版本
  3. 查看任务管理器中是否有任务被正确暂停

**问题：恢复后出现任务堆积执行**
- 原因：智能恢复算法没有正确重计算任务时间
- 解决：
  1. 检查`UnifiedScheduler.resume()`方法实现
  2. 确认`next_run_time`被正确重设
  3. 查看是否有避免雪崩的逻辑

---

## 六、性能监控工具 (v2025.01 增强版)

### 智能性能监控

```python
# 实时性能监控
class PerformanceMonitor:
    def monitor_pause_resume_efficiency(self):
        """监控暂停/恢复机制的效率"""
        
    def track_detection_performance(self):
        """跟踪检测方法性能"""
        
    def analyze_cpu_usage_pattern(self):
        """分析CPU使用模式"""
```

### OSD 实时数据显示

**v2025.01 增强显示内容**：
- CPU使用率及暂停期间节约统计
- 检测方法和平均耗时
- 智能调度器状态和任务数
- ColorAnalysisTools使用状态和优化结果
- ResourceConfigManager管理的配置数量

### 系统监控工具
- **SchedulerPerformanceValidator**：暂停/恢复响应时间、CPU 节约率与任务准确性检测
- **monitor.py**：进程 CPU/内存/线程周期采集
- **backup_config.py**：配置备份/恢复

### 性能测试结果解读

运行benchmark后，关注以下指标：

1. **性能对比**：
   - 矩形检测：0.3ms（基准）
   - 其他方法：5-241ms（慢17-803倍）

2. **准确率对比**：
   - 矩形检测：96%误差<5%，98.5%误差<10%
   - OCR方法：90-100%准确率，但有识别失败案例

3. **成功率对比**：
   - 矩形检测：100%（无失败）
   - OCR方法：98.3-99.0%（有失败案例）

4. **可靠性对比**：
   - 矩形检测：在OCR错误时仍能给出合理值
   - OCR方法：存在8个错误案例（百分比>100%）

---

## 五、问题报告模板（简版）
包含系统/显卡/分辨率、Python/commit 版本、复现步骤、期望/实际、关键日志、相关配置片段。

---

本章为运行期与维护期的一站式参考：遇到输入/性能/捕获/配置问题先对照本章排查，再结合 02/03/04 章节定位到架构、API 与配置层。