# 03 åŠŸèƒ½æ¨¡å—è¯¦è§£

æœ¬ç« è¯¦ç»†ä»‹ç»pyahkçš„å››å¤§æ ¸å¿ƒåŠŸèƒ½æ¨¡å—ï¼šæŠ€èƒ½ç³»ç»Ÿã€æ™ºèƒ½è¯å‰‚ã€è£…å¤‡æ´—ç»ƒå’Œè‡ªåŠ¨å¯»è·¯ã€‚æ¯ä¸ªæ¨¡å—éƒ½é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œæ—¢å¯ç‹¬ç«‹è¿è¡Œï¼Œä¹Ÿå¯ååŒå·¥ä½œã€‚

---

## ğŸ¯ æŠ€èƒ½è‡ªåŠ¨åŒ–ç³»ç»Ÿ

### æ¦‚è¿°
æŠ€èƒ½ç³»ç»Ÿæ˜¯pyahkçš„æ ¸å¿ƒåŠŸèƒ½ï¼Œæä¾›è‡ªåŠ¨åŒ–çš„æŠ€èƒ½é‡Šæ”¾ã€å†·å´æ£€æµ‹å’Œä¼˜å…ˆçº§ç®¡ç†ã€‚æ”¯æŒå¤šç§è§¦å‘æ¨¡å¼å’Œæ‰§è¡Œæ¡ä»¶ï¼Œå®ç°ç²¾ç¡®çš„æˆ˜æ–—è‡ªåŠ¨åŒ–ã€‚

### ä¸‰ç§è§¦å‘æ¨¡å¼

#### 1. å®šæ—¶æ¨¡å¼ (TriggerMode = 0)
```json
{
  "name": "æŒç»­æŠ€èƒ½",
  "key": "1",
  "trigger_mode": 0,
  "interval": 1000,  // æ¯1ç§’æ‰§è¡Œä¸€æ¬¡
  "priority": false
}
```
- **åŠŸèƒ½**ï¼šåŸºäºå›ºå®šæ—¶é—´é—´éš”æ‰§è¡ŒæŠ€èƒ½
- **ä½¿ç”¨åœºæ™¯**ï¼šæŒç»­BUFFæŠ€èƒ½ã€å®šæœŸå›è¡€æŠ€èƒ½
- **ç‰¹ç‚¹**ï¼šä¸¥æ ¼æŒ‰æ—¶é—´é—´éš”æ‰§è¡Œï¼Œä¸å—æ¸¸æˆçŠ¶æ€å½±å“

#### 2. å†·å´æ¨¡å¼ (TriggerMode = 1)
```json
{
  "name": "ä¸»è¦è¾“å‡º",
  "key": "q",
  "trigger_mode": 1,
  "cooldown_coords": [100, 50, 20, 20],  // [x, y, width, height]
  "priority": true
}
```
- **åŠŸèƒ½**ï¼šåŸºäºæŠ€èƒ½å›¾æ ‡å†·å´çŠ¶æ€æ‰§è¡ŒæŠ€èƒ½
- **æ£€æµ‹åŸç†**ï¼šé€šè¿‡RGBå›¾åƒåŒ¹é…æ£€æµ‹æŠ€èƒ½æ˜¯å¦å¯ç”¨
- **ä½¿ç”¨åœºæ™¯**ï¼šä¸»è¦è¾“å‡ºæŠ€èƒ½ã€æœ‰å†·å´æ—¶é—´çš„å…³é”®æŠ€èƒ½

#### 3. æŒ‰ä½æ¨¡å¼ (TriggerMode = 2)
```json
{
  "name": "ç§»åŠ¨æŠ€èƒ½",
  "key": "shift",
  "trigger_mode": 2
}
```
- **åŠŸèƒ½**ï¼šè¿›å…¥è¿è¡ŒçŠ¶æ€æ—¶æŒ‰ä¸‹ï¼Œåœæ­¢æ—¶é‡Šæ”¾
- **ç‰¹ç‚¹**ï¼š
  - ä»…åœ¨çŠ¶æ€åˆ‡æ¢æ—¶ä¸€æ¬¡æ€§æ‰§è¡Œ
  - ä¸å‚ä¸å¾ªç¯æˆ–å®šæ—¶ä»»åŠ¡
  - ç”±AHKæœåŠ¡æ‰§è¡Œï¼Œæ”¯æŒç»„åˆé”®
- **ä½¿ç”¨åœºæ™¯**ï¼šæŒç»­æŠ€èƒ½ã€ç§»åŠ¨é€Ÿåº¦å¢å¼º

### ä¼˜å…ˆçº§ç³»ç»Ÿ

#### åŒé‡ä¼˜å…ˆçº§æœºåˆ¶
- **æ£€æŸ¥ä¼˜å…ˆçº§**ï¼šé«˜ä¼˜å…ˆçº§æŠ€èƒ½åœ¨å†·å´æ£€æµ‹æ—¶ä¼˜å…ˆæ£€æŸ¥
- **é˜Ÿåˆ—ä¼˜å…ˆçº§**ï¼šé«˜ä¼˜å…ˆçº§æŠ€èƒ½æŒ‰é”®æ’å…¥PriorityDequeå‰ç«¯

#### æœ€ä½³å®è·µ
```json
{
  "skills": [
    {"name": "ç´§æ€¥æ¢å¤", "priority": true},   // æœ€é«˜ä¼˜å…ˆçº§
    {"name": "æ ¸å¿ƒè¾“å‡º", "priority": true},   // é«˜ä¼˜å…ˆçº§
    {"name": "è¾…åŠ©æŠ€èƒ½", "priority": false}   // æ™®é€šä¼˜å…ˆçº§
  ]
}
```

### æ‰§è¡Œæ¡ä»¶ç³»ç»Ÿ

#### æ— æ¡ä»¶æ¨¡å¼ (ExecuteCondition = 0)
- å†·å´å°±ç»ªæ—¶ç›´æ¥æ‰§è¡Œä¸»æŒ‰é”®
- æœ€ç®€å•çš„æ‰§è¡Œæ¨¡å¼

#### Buffé™åˆ¶æ¨¡å¼ (ExecuteCondition = 1)
```json
{
  "execute_condition": 1,
  "buff_coords": [200, 100, 30, 30],
  "key": "e"
}
```
- **é€»è¾‘**ï¼šBuffå­˜åœ¨æ—¶ä¸æ‰§è¡Œï¼ŒBuffæ¶ˆå¤±æ—¶æ‰§è¡Œ
- **åœºæ™¯**ï¼šé¿å…é‡å¤ä¸ŠBUFF

#### èµ„æºæ¡ä»¶æ¨¡å¼ (ExecuteCondition = 2)
```json
{
  "execute_condition": 2,
  "resource_coords": [50, 950, 200, 20],
  "resource_threshold": 70,
  "key": "r",
  "alt_key": "t"  // èµ„æºä¸è¶³æ—¶çš„å¤‡ç”¨æŒ‰é”®
}
```
- **é€»è¾‘**ï¼šèµ„æºå……è¶³æ‰§è¡Œä¸»æŒ‰é”®ï¼Œä¸è¶³æ‰§è¡Œå¤‡ç”¨æŒ‰é”®
- **è¿ç»­æ€§æ£€æŸ¥**ï¼šé¿å…æ£€æµ‹æŠ–åŠ¨
- **åœºæ™¯**ï¼šæ ¹æ®MP/æ€’æ°”çŠ¶æ€åˆ‡æ¢æŠ€èƒ½

---

## ğŸ’Š æ™ºèƒ½è¯å‰‚ç³»ç»Ÿ

### æ¦‚è¿°
é‡‡ç”¨å…ˆè¿›çš„HSVåŒè‰²æ£€æµ‹ç®—æ³•ï¼Œæ”¯æŒæ­£å¸¸/ä¸­æ¯’çŠ¶æ€æ™ºèƒ½è¯†åˆ«ï¼Œå®ç°ç²¾ç¡®çš„HP/MPæ£€æµ‹å’Œè‡ªåŠ¨å–‚è¯åŠŸèƒ½ã€‚

### ä¸‰å±‚å§”æ‰˜æ¶æ„

#### ç¬¬1å±‚ï¼šSkillManager (è°ƒåº¦å±‚)
```python
# é€šè¿‡UnifiedScheduleræŒ‰å›ºå®šé—´éš”å¯åŠ¨èµ„æºæ£€æŸ¥ä»»åŠ¡
def schedule_resource_check():
    scheduler.add_task("resource_check", 200, self.check_resources)
```

#### ç¬¬2å±‚ï¼šResourceManager (ä¸šåŠ¡é€»è¾‘å±‚)
```python
class ResourceManager:
    def check_hp_potion(self, frame):
        if not self._is_hp_cooldown_ready():
            return False
        
        current_percentage = self._detect_hp_percentage(frame)
        if current_percentage < self.hp_threshold:
            self._execute_hp_potion()
            return True
        return False
```

#### ç¬¬3å±‚ï¼šBorderFrameManager (æ£€æµ‹å±‚)
```python
def _compare_resource_hsv(self, frame, template_hsv, tolerance):
    """HSVæ¨¡æ¿åŒ¹é…ï¼Œå¤„ç†è‰²ç›¸ç¯å½¢ç‰¹æ€§"""
    # æ™ºèƒ½HSVé¢œè‰²ç©ºé—´æ£€æµ‹
    h_diff = min(abs(h1 - h2), 360 - abs(h1 - h2))
    # è®¡ç®—åŒ¹é…ç™¾åˆ†æ¯”
```

### HSVåŒè‰²æ£€æµ‹æŠ€æœ¯

#### æ ¸å¿ƒä¼˜åŠ¿
- **å…‰ç…§é€‚åº”æ€§**ï¼šHSVé¢œè‰²ç©ºé—´å¯¹å…‰ç…§å˜åŒ–ä¸æ•æ„Ÿ
- **çŠ¶æ€æ„ŸçŸ¥**ï¼šè‡ªåŠ¨è¯†åˆ«æ­£å¸¸/ä¸­æ¯’/å¼‚å¸¸çŠ¶æ€çš„é¢œè‰²å˜åŒ–
- **ç¯å½¢å¤„ç†**ï¼šæ­£ç¡®å¤„ç†è‰²ç›¸çš„360åº¦ç¯å½¢ç‰¹æ€§

#### é…ç½®ç¤ºä¾‹
```json
{
  "hp_potion": {
    "enabled": true,
    "key": "1",
    "threshold": 50,
    "region": [136, 910, 213, 1004],
    "hsv_normal": [314, 75, 29],
    "hsv_poison": [120, 180, 50],
    "tolerance": [10, 20, 20],
    "cooldown": 5000
  }
}
```

### å†…éƒ¨å†·å´æœºåˆ¶
```python
class ResourceManager:
    def __init__(self):
        self._last_hp_use = 0
        self._last_mp_use = 0
        self._hp_cooldown = 5000  # 5ç§’å†·å´
        self._mp_cooldown = 8000  # 8ç§’å†·å´
    
    def _is_hp_cooldown_ready(self):
        return time.time() - self._last_hp_use > self._hp_cooldown / 1000
```

---

## ğŸ”¨ è£…å¤‡æ´—ç»ƒç³»ç»Ÿ

### æ¦‚è¿°
ç‹¬ç«‹çš„F7çƒ­é”®æ§åˆ¶æ¨¡å—ï¼Œé‡‡ç”¨ä¸‰çŠ¶æ€è¯†åˆ«æœºåˆ¶ï¼Œç»“åˆPaddleOCRæ–‡å­—è¯†åˆ«æŠ€æœ¯ï¼Œå®ç°ç²¾ç¡®çš„è¯ç¼€æ£€æµ‹å’Œè‡ªåŠ¨æ´—ç»ƒæ“ä½œã€‚

### ä¸‰çŠ¶æ€è¯†åˆ«æœºåˆ¶

#### çŠ¶æ€1ï¼šæœªæ´—ç»ƒçŠ¶æ€
- **ç‰¹å¾**ï¼šè£…å¤‡æœªè¿›è¡Œä»»ä½•æ´—ç»ƒæ“ä½œ
- **è¯†åˆ«**ï¼šé€šè¿‡ç‰¹å®šUIå…ƒç´ çš„é¢œè‰²å’Œä½ç½®è¯†åˆ«
- **æ“ä½œ**ï¼šç‚¹å‡»å¼€å§‹æ´—ç»ƒæŒ‰é’®

#### çŠ¶æ€2ï¼šæ´—ç»ƒè¿›è¡Œä¸­
- **ç‰¹å¾**ï¼šæ­£åœ¨è¿›è¡Œæ´—ç»ƒï¼Œç•Œé¢æ˜¾ç¤ºè¿›åº¦æˆ–åŠ¨ç”»
- **è¯†åˆ«**ï¼šæ£€æµ‹æ´—ç»ƒè¿›åº¦æŒ‡ç¤ºå™¨
- **æ“ä½œ**ï¼šç­‰å¾…æ´—ç»ƒå®Œæˆ

#### çŠ¶æ€3ï¼šæ´—ç»ƒå®Œæˆ
- **ç‰¹å¾**ï¼šæ´—ç»ƒå®Œæˆï¼Œæ˜¾ç¤ºæ–°è¯ç¼€ç»“æœ
- **è¯†åˆ«**ï¼šæ£€æµ‹å®ŒæˆçŠ¶æ€çš„UIç‰¹å¾
- **æ“ä½œ**ï¼šè¿›è¡ŒOCRè¯†åˆ«ï¼Œå†³ç­–æ˜¯å¦ä¿ç•™

### PaddleOCRé›†æˆ

#### å¼•æ“é…ç½®
```python
from paddleocr import PaddleOCR

ocr = PaddleOCR(
    use_angle_cls=True,      # å¯ç”¨è§’åº¦åˆ†ç±»
    lang='ch',               # ä¸­æ–‡è¯†åˆ«
    use_gpu=False,           # CPUæ¨¡å¼ï¼Œå…¼å®¹æ€§æ›´å¥½
    show_log=False,          # ç¦ç”¨è¯¦ç»†æ—¥å¿—
    det_db_score_mode='slow' # ç²¾ç¡®æ£€æµ‹æ¨¡å¼
)
```

#### è¯†åˆ«æµç¨‹
```python
def recognize_affixes(self, image_region):
    # 1. å›¾åƒé¢„å¤„ç†
    processed_image = self._preprocess_image(image_region)
    
    # 2. OCRè¯†åˆ«
    results = self.ocr.ocr(processed_image, cls=True)
    
    # 3. æ–‡å­—æå–å’ŒåŒ¹é…
    detected_affixes = self._extract_text_from_results(results)
    
    # 4. ç›®æ ‡è¯ç¼€åŒ¹é…
    return self._match_target_affixes(detected_affixes)
```

### é…ç½®ç¤ºä¾‹
```json
{
  "affix_reroll": {
    "enabled": true,
    "max_attempts": 100,
    "target_affixes": ["æš´å‡»ç‡", "æš´å‡»ä¼¤å®³", "æ”»å‡»åŠ›"],
    "enchant_button": [500, 600],
    "replace_button": [600, 700],
    "close_button": [700, 100],
    "ocr_region": [400, 300, 200, 400]
  }
}
```

---

## ğŸ—ºï¸ è‡ªåŠ¨å¯»è·¯ç³»ç»Ÿ

### æ¦‚è¿°
ä¸“ä¸ºéšæœºç”Ÿæˆåœ°å›¾è®¾è®¡ï¼Œé‡‡ç”¨**ç›¸ä½ç›¸å…³ä½ç§»è·Ÿè¸ª**å’Œ**A*ç®—æ³•**ï¼Œå®ç°æ™ºèƒ½åœ°å›¾æ¢ç´¢å’Œç²¾ç¡®è·¯å¾„è§„åˆ’ã€‚

### æ ¸å¿ƒæŠ€æœ¯æ¶æ„

#### ç¬¬ä¸€é˜¶æ®µï¼šåœ°å›¾è§£è¯»ä¸æ‹¼æ¥

**1. è·¯å¾„æå–**
```python
def extract_paths(minimap_frame):
    """ä»å°åœ°å›¾æå–å¯é€šè¡Œè·¯å¾„"""
    gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
    _, mask = cv2.threshold(gray, threshold, 255, cv2.THRESH_BINARY)
    
    # å½¢æ€å­¦æ“ä½œä¼˜åŒ–è·¯å¾„è¿é€šæ€§
    kernel = cv2.getStructuringElement(cv2.MORPH_ELLIPSE, (3, 3))
    closed = cv2.morphologyEx(mask, cv2.MORPH_CLOSE, kernel)
    opened = cv2.morphologyEx(closed, cv2.MORPH_OPEN, kernel)
    
    return opened
```

**2. ç›¸ä½ç›¸å…³ä½ç§»è·Ÿè¸ª**
```python
def track_displacement(prev_frame, curr_frame):
    """è®¡ç®—åœ°å›¾ç§»åŠ¨çš„åƒç´ ä½ç§»"""
    displacement, response = cv2.phaseCorrelate(prev_frame, curr_frame)
    confidence = response  # ç½®ä¿¡åº¦
    return displacement if confidence > 0.7 else None
```

**3. å…¨å±€åœ°å›¾æ‹¼æ¥**
```python
class GlobalMapBuilder:
    def __init__(self):
        self.global_map = np.zeros((5000, 5000), dtype=np.uint8)
        self.player_pos = (2500, 2500)  # ä¸­å¿ƒèµ·å§‹ç‚¹
    
    def update_global_map(self, current_paths, displacement):
        x, y = self.player_pos
        self.global_map[y:y+h, x:x+w] = cv2.add(
            self.global_map[y:y+h, x:x+w], current_paths
        )
```

#### ç¬¬äºŒé˜¶æ®µï¼šæ¢ç´¢ä¸è·¯å¾„è§„åˆ’

**1. "é™¤è‰æœº"æ¢ç´¢ç®—æ³•**
```python
class LawnmowerExplorer:
    """ç³»ç»Ÿæ€§åœ°å›¾æ¢ç´¢ç®—æ³•"""
    def __init__(self):
        self.direction = "right"
        self.row_height = 50
        
    def get_next_move(self, current_pos, explored_map):
        if self._can_continue_current_direction():
            return self._get_direction_vector()
        else:
            self._move_to_next_row()
            self._reverse_direction()
            return self._get_direction_vector()
```

**2. A*å¯»è·¯ç®—æ³•**
```python
class AStarPathfinder:
    def find_path(self, start, goal, obstacle_map):
        """A*ç®—æ³•å¯»æ‰¾æœ€ä¼˜è·¯å¾„"""
        open_set = []
        heapq.heappush(open_set, (0, start))
        came_from = {}
        g_score = {start: 0}
        f_score = {start: self._heuristic(start, goal)}
        
        while open_set:
            current = heapq.heappop(open_set)[1]
            
            if current == goal:
                return self._reconstruct_path(came_from, current)
            
            for neighbor in self._get_neighbors(current):
                tentative_g = g_score[current] + 1
                
                if neighbor not in g_score or tentative_g < g_score[neighbor]:
                    came_from[neighbor] = current
                    g_score[neighbor] = tentative_g
                    f_score[neighbor] = tentative_g + self._heuristic(neighbor, goal)
                    heapq.heappush(open_set, (f_score[neighbor], neighbor))
        
        return []  # æ— è·¯å¾„
```

### åŒæ¨¡å¼è¿è¡Œ

#### æ¢ç´¢æ¨¡å¼
- **ç›®æ ‡**ï¼šå‘ç°åœ°å›¾ä¸­çš„æ‰€æœ‰å¯é€šè¡ŒåŒºåŸŸ
- **ç­–ç•¥**ï¼šä½¿ç”¨"é™¤è‰æœº"ç®—æ³•ç³»ç»Ÿæ€§è¦†ç›–
- **è§¦å‘**ï¼šæœªå‘ç°ç›®æ ‡æ—¶è‡ªåŠ¨å¯ç”¨

#### å¯¼èˆªæ¨¡å¼
- **ç›®æ ‡**ï¼šä»å½“å‰ä½ç½®åˆ°ç‰¹å®šç›®æ ‡çš„æœ€çŸ­è·¯å¾„
- **ç­–ç•¥**ï¼šä½¿ç”¨A*ç®—æ³•è®¡ç®—æœ€ä¼˜è·¯å¾„
- **è§¦å‘**ï¼šå‘ç°ç›®æ ‡åè‡ªåŠ¨åˆ‡æ¢

### é…ç½®ç¤ºä¾‹
```json
{
  "pathfinding": {
    "enabled": true,
    "minimap_region": [1670, 50, 200, 200],
    "player_icon_color": [255, 255, 255],
    "path_color_range": [[100, 150, 100], [130, 255, 200]],
    "exploration_step": 50,
    "confidence_threshold": 0.7,
    "max_exploration_time": 300
  }
}
```

---

## ğŸ”„ æ¨¡å—ååŒå·¥ä½œ

### çŠ¶æ€ç®¡ç†ç»Ÿä¸€æ€§
æ‰€æœ‰åŠŸèƒ½æ¨¡å—éƒ½éµå¾ªç»Ÿä¸€çš„çŠ¶æ€æœºï¼š
```
STOPPED â†â†’ READY â†â†’ RUNNING â†â†’ PAUSED
```

### æ¨¡å¼äº’æ–¥æœºåˆ¶
- **æŠ€èƒ½æ¨¡å¼**ï¼šF8æ§åˆ¶ï¼Œå¤„ç†æŠ€èƒ½å¾ªç¯å’Œè¯å‰‚æ£€æµ‹
- **æ´—ç»ƒæ¨¡å¼**ï¼šF7æ§åˆ¶ï¼Œç‹¬ç«‹çš„è£…å¤‡è¯ç¼€æ´—ç»ƒ
- **å¯»è·¯æ¨¡å¼**ï¼šF9æ§åˆ¶ï¼Œè‡ªåŠ¨åœ°å›¾æ¢ç´¢å’Œå¯¼èˆª

### èµ„æºå…±äº«
- **å±å¹•æ•è·**ï¼šæ‰€æœ‰æ¨¡å—å…±äº«åŒä¸€å¸§æ•°æ®ï¼Œé¿å…é‡å¤æ•è·
- **è¾“å…¥é˜Ÿåˆ—**ï¼šç»Ÿä¸€çš„PriorityDequeå¤„ç†æ‰€æœ‰è¾“å…¥æ“ä½œ
- **é…ç½®ç®¡ç†**ï¼šConfigManagerç»Ÿä¸€ç®¡ç†æ‰€æœ‰æ¨¡å—é…ç½®

### äº‹ä»¶é€šä¿¡
```python
# æ¨¡å—é—´é€šè¿‡EventBusè¿›è¡Œé€šä¿¡
event_bus.publish("skill:cooldown_ready", skill_name="fireball")
event_bus.publish("resource:hp_low", current_hp=30)
event_bus.publish("pathfinding:target_found", target_pos=(100, 200))
```

é€šè¿‡è¿™ç§æ¨¡å—åŒ–å’Œäº‹ä»¶é©±åŠ¨çš„è®¾è®¡ï¼Œpyahkå®ç°äº†é«˜åº¦çµæ´»å’Œå¯æ‰©å±•çš„æ¸¸æˆè‡ªåŠ¨åŒ–åŠŸèƒ½ã€‚