# 06 调试、部署与故障排查（合订本）

本章合并原《06 调试与开发》《07 部署与运维》《08 故障排查手册》，提供从开发调试、性能分析、环境部署到问题排查的一体化指南。

---

## 一、调试与开发（摘编增强）

### 调试模式与OSD
- 通过配置 debug.enabled 开启；或使用 F7/FPS/性能统计热键。
- OSD 显示：状态机、FPS、输入队列长度、捕获/检测耗时、调度器暂停统计等。

### 可视化与日志
- 技能/资源检测区域覆盖，路径点与障碍可视化。
- 分模块 Logger 与节流日志（ThrottledLogger），避免高频刷屏。

### 性能监控要点
- 暂停/恢复事件计数、暂停持续时长、CPU 节约率（优先级按键期间）。
- Scheduler 恢复时重算 next_run_time，避免堆积执行。

### 基础开发环境
- Python >= 3.8；依赖见 requirements.txt。
- C++ DXGI 捕获：VS Build Tools + CMake，native_capture/build.bat 一键编译。

---

## 二、部署与运维（整合）

### 环境要求与权限
- Windows 10/11；管理员权限（全局热键与窗口激活）。
- 显卡支持 DXGI；若 DLL 加载失败，安装 VC++ Redistributable。

### 依赖安装
- 在线：pip install -r requirements.txt
- 国内镜像/离线包：支持下载到 offline_packages 后离线安装。

### 目录与配置
```
pyahk/
  main.py, main_special.py, default.json, native_capture/, torchlight_assistant/, wiki/
```
- 建议将实际使用的配置复制为 my_config.json 并通过 GUI 维护。

### 服务化与计划任务（可选）
- Windows 服务脚本（pywin32）；计划任务以 SYSTEM 最高权限开机启动。

### 运维监控
- 轮转日志、性能采集脚本（CPU/内存/线程），健康检查（进程/内存/日志异常）。

---

## 三、故障排查（整合要点）

### A. 输入系统相关
1) 程序启动后输入"卡死"或需按右键才恢复
- 2025.01 起已迁移到 Windows Hook，更新至最新版本即可根治。

2) 优先级按键无效或双重触发
- 检查是否区分 special_keys 与 managed_keys；管理按键建议"拦截→映射发送"。
- 查看日志是否打印"优先级按键监听已启动"。

3) 鼠标键（left/right/middle）不识别
- 已补齐 VK 与 WM 常量；若仍异常，检查杀软/权限以及 Hook 注册错误输出。

4) 切换配置文件后热键失效（原地模式/交互键）
- **症状**: 从 default.json 切换到其他配置文件后，X/A 等可配置热键不响应
- **原因**: 键角色转换冲突（如 X 键从 force_move 转为 stationary 时被错误 unregister）
- **修复**: 已采用"先取消所有可配置热键，再重新注册"策略（v2025.01.11+）
- **验证**: 查看日志中 `[热键管理] 取消注册所有可配置热键` 和 `成功注册热键 'stationary': x`

5) 原地模式切换成功但技能键未添加 Shift 修饰符
- **症状**: OSD 显示已进入原地模式，但技能键实际效果未变化
- **原因**: InputHandler 未从配置中更新 `_cached_stationary_mode_type`
- **修复**: 已在 `_on_config_updated` 中添加 stationary_mode_config 读取（v2025.01.11+）
- **验证**: 查看日志 `[输入处理器] 原地模式类型已更新: shift_modifier`

### B. 图像捕获与识别

#### 捕获问题
- **DLL load failed**：重装 VC++ Redistributable，重编原生库；必要时降级到 MSS 备用方案。
- **帧率低**：检查是否使用了DXGI零拷贝捕获，确认native_capture库正常加载。

#### 检测准确率问题
- **冷却检测不准**：缩小 ROI、缓存模板、启用中心区域检测与连续性窗口。
- **HSV 检测不准**：
  1. 确认已按F8初始化模板（满血满蓝状态）
  2. 调整HSV容差参数（tolerance_h/s/v）
  3. 检查区域坐标是否准确框选资源条
  4. 查看性能测试报告：`python performance_test/perf_full_benchmark.py`

#### 检测性能问题
- **检测速度慢**：
  - ❌ 如果使用OCR：切换到矩形检测（快82-803倍）
  - ✅ 矩形检测：0.3ms，100%成功率，96%误差<5%
  - ✅ 圆形检测：~5ms，适合球形资源条
  - ⚠️ OCR方法：25-241ms，仅在必要时使用

#### 检测失败问题
- **OCR识别失败**：
  - 检查文本区域坐标是否准确
  - 尝试不同的OCR引擎（Template/Keras/Tesseract）
  - 考虑切换到矩形检测（更可靠，100%成功率）
- **矩形检测失败**：
  - 确认已按F8初始化模板
  - 检查HSV容差是否合适
  - 查看debug_frame截图验证区域

### C. 性能与资源
- 优先级按键期间应“零无效计算”（帧捕获/检测/调度暂停）；如未生效，检查事件订阅与 Scheduler 状态。
- CPU 高：调大捕获/检测间隔，合并任务，降低调试刷新频率。

### D. OCR/依赖

#### OCR相关问题
- **paddleocr 初始化失败**：清缓存重新安装；将其设为可选模块并保护导入。
- **OCR性能慢**：
  - Template OCR: ~25ms（最快的OCR）
  - Keras OCR: ~99ms（最准确）
  - Tesseract OCR: ~241ms（最慢）
  - **建议**：如果不是必须识别数字文本，切换到矩形检测（0.3ms，快82-803倍）
- **OCR识别错误**：
  - 实测478次中有8个OCR错误案例（百分比>100%）
  - 矩形检测在这些情况下仍能给出合理值
  - 考虑使用矩形检测作为主要方法，OCR作为备用

### E. 配置与序列
- 校验按键序列 delayX 规范、逗号分隔；检查 managed_keys 对象格式 {target, delay}；避免自拦截。

---

## 四、工具与脚本（精选）

### 性能测试工具
- **perf_full_benchmark.py**：完整的HP/MP检测性能基准测试
  - 测试所有4种检测方法（矩形、圆形、3种OCR）
  - 对比性能、准确率、成功率
  - 自动生成详细统计报告
  - 运行方式：`python performance_test/perf_full_benchmark.py`
  - 测试数据：478次真实游戏截图
  - 输出文件：`performance_test/benchmark_results.json`

### 系统监控工具
- **SchedulerPerformanceValidator**：暂停/恢复响应时间、CPU 节约率与任务准确性检测
- **monitor.py**：进程 CPU/内存/线程周期采集
- **backup_config.py**：配置备份/恢复

### 性能测试结果解读

运行benchmark后，关注以下指标：

1. **性能对比**：
   - 矩形检测：0.3ms（基准）
   - 其他方法：5-241ms（慢17-803倍）

2. **准确率对比**：
   - 矩形检测：96%误差<5%，98.5%误差<10%
   - OCR方法：90-100%准确率，但有识别失败案例

3. **成功率对比**：
   - 矩形检测：100%（无失败）
   - OCR方法：98.3-99.0%（有失败案例）

4. **可靠性对比**：
   - 矩形检测：在OCR错误时仍能给出合理值
   - OCR方法：存在8个错误案例（百分比>100%）

---

## 五、问题报告模板（简版）
包含系统/显卡/分辨率、Python/commit 版本、复现步骤、期望/实际、关键日志、相关配置片段。

---

本章为运行期与维护期的一站式参考：遇到输入/性能/捕获/配置问题先对照本章排查，再结合 02/03/04 章节定位到架构、API 与配置层。