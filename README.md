## 📚 项目文档

本项目采用模块化文档结构，详细内容请参考wiki目录：

| 模块 | 内容概述 | 目标用户 |
|------|----------|----------|
| [01-项目概述与快速入门](wiki/01-项目概述与快速入门.md) | 项目介绍、安装配置、基础使用 | 所有用户 |
| [02-核心架构设计](wiki/02-核心架构设计.md) | 系统架构、事件总线、调度器、输入系统 | 开发者 |
| [03-功能模块详解](wiki/03-功能模块详解.md) | 技能系统、药剂管理、装备洗练、自动寻路 | 高级用户 |
| [04-配置与条件系统](wiki/04-配置与条件系统.md) | 配置管理、条件逻辑、热重载机制 | 配置人员 |
| [05-图像捕获与性能](wiki/05-图像捕获与性能.md) | DXGI捕获、模板匹配、性能优化 | 技术人员 |
| [06-调试与开发](wiki/06-调试与开发.md) | 调试工具、开发环境、测试框架 | 开发者 |
| [07-部署与运维](wiki/07-部署与运维.md) | 环境部署、监控告警、故障恢复 | 运维人员 |
| [08-故障排查手册](wiki/08-故障排查手册.md) | 常见问题、诊断工具、解决方案 | 支持人员 |
| [09-API参考与扩展](wiki/09-API参考与扩展.md) | API接口、插件开发、扩展指南 | 扩展开发者 |
| [10-多级优先级系统](wiki/10-多级优先级系统.md) | 四级优先队列、按键监控、技能过滤 | 高级用户 |


## 项目入口

pyahk提供两种使用方式：

1. **GUI版本** (`main.py`)：完整的图形用户界面，支持所有功能模块的可视化配置和控制
2. **命令行版本** (`main_special.py`)：轻量级版本，专注于特定游戏场景的自动化任务

## 核心功能特性

- **零拷贝屏幕捕获技术**: 基于DXGI Desktop Duplication API的C++实现，使用双缓冲区和原子指针技术实现真正的零拷贝，确保毫秒级响应速度。
- **事件驱动架构**: 核心组件通过中央事件总线(EventBus)通信，支持异步发布/订阅模式，实现完全解耦和递归事件检测。
- **统一调度器**: 基于heapq和monotonic时间源的单线程调度器，避免系统时钟调整影响，提供亚毫秒级定时精度。
- **优先级按键暂停/恢复机制**: 通过全局按键监听，在用户按住自定义的优先级按键（如空格、右键）时，能智能地暂停所有后台调度任务（技能冷却、资源检测等），在按键释放后自动恢复。此机制实现了真正的“按需计算”，在手动操作期间可节省70-90%的CPU资源。
- **智能药剂管理**: 
    - **自动圆形校准**: 用户只需点击一下按钮，程序即可通过霍夫圆变换算法，自动识别游戏中的血量/蓝量球体，并精确计算出其圆心和半径，无需手动配置坐标。
    - **半圆分析算法**: 在计算药剂百分比时，智能地只分析球体未被UI遮挡的一半（如血球的右半圆，蓝球的左半圆），从根本上排除了UI边框的干扰。
    - **统一HSV模板匹配**: 所有资源检测均采用更鲁棒的HSV颜色空间进行模板匹配。
- **高级技能系统**: 
    - **统一HSV冷却检测**: 所有技能的冷却检测都已升级为HSV模板匹配，能有效抵抗游戏内光照和技能图标动画效果的干扰，识别更精准。
    - **多触发模式**: 支持定时、冷却、按住(Hold)等多种触发模式。
    - **双重优先级**: 支持检查优先级（优先检测）和队列优先级（插队执行），确保核心技能的响应速度。
- **装备词缀洗练**: 基于SimpleAffixRerollManager的配置驱动洗练，集成PaddleOCR词缀识别和实时OSD反馈。
- **自动寻路与探索**: 采用相位相关位移跟踪和A*算法，实现随机地图的自主探索和精确路径规划。
- **状态机管理**: 严格的四状态转换机制(STOPPED→READY→RUNNING→PAUSED)和模式互斥逻辑。
- **调试与监控**: 集成DebugDisplayManager提供实时OSD和条件日志输出。

## 使用方法

1.  **启动程序**:
    *   **GUI版本**: 运行 `main.py`，启动包含完整PySide6界面的版本，支持所有功能模块。
    *   **特殊版本**: 运行 `main_special.py`，启动专用于特定自动化场景的独立脚本(Z键控制自动左键)。

2.  **配置**: 在GUI中完成配置，支持JSON格式的配置文件加载/保存，配置通过ConfigManager统一管理。

3.  **热键操作**:
    *   **F8 (主控键)**: 在STOPPED和READY状态间切换，准备技能模式执行。
    *   **F7 (洗练键)**: 独立控制装备词缀洗练模式的启动/停止。
    *   **F9 (寻路键)**: 独立控制自动寻路模式的准备/停止。
    *   **Z (执行/暂停键)**: 在READY状态下启动执行(RUNNING)，在RUNNING状态下暂停/恢复(PAUSED)。

4.  **颜色配置格式**: 新版本支持更清晰的多行颜色配置格式：
    ```
    容差值(H,S,V)     # 第一行：全局容差设置
    颜色1(H,S,V)      # 第二行：第一种检测颜色
    颜色2(H,S,V)      # 第三行：第二种检测颜色（可选）
    ...               # 更多颜色（可选）
    ```
    
    **示例配置**：
    - **HP血量检测**：
      ```
      10,20,20        # 容差：H±10, S±20, V±20
      157,75,29       # 红色血量
      40,84,48        # 绿色血量（备用）
      ```
    
    - **MP魔力检测**：
      ```
      5,5,5           # 容差：H±5, S±5, V±5
      104,80,58       # 蓝色魔力
      ```

## 依赖环境与配置

### 系统要求
- **操作系统**: Windows 10/11
- **Python版本**: 3.7+

### 核心依赖
```
PySide6>=6.5.0        # GUI框架
psutil>=5.9.0         # 系统进程监控
pynput>=1.7.6         # 键盘鼠标输入控制
Pillow>=9.0.0         # 图像处理
mss>=9.0.1           # 高性能截图(备用)
numpy>=1.20.0         # 数值计算
opencv-python>=4.5.0  # 计算机视觉
pywin32>=306          # Windows API
paddleocr==2.7.3      # OCR文字识别(固定版本)
```

### 项目结构
```
torchlight_assistant/
├── core/                           # 核心业务逻辑
│   ├── macro_engine.py            # 主控制器和状态管理
│   ├── event_bus.py               # 事件总线
│   ├── unified_scheduler.py       # 统一调度器
│   ├── input_handler.py           # 输入处理器
│   ├── skill_manager.py           # 技能管理
│   ├── resource_manager.py        # 资源检测
│   ├── debug_display_manager.py   # 调试显示
│   ├── simple_affix_reroll_manager.py # 装备洗练
│   ├── pathfinding_manager.py     # 自动寻路
│   └── states.py                  # 状态枚举
├── gui/                           # 用户界面
│   ├── main_window.py             # 主窗口
│   ├── debug_osd_window.py        # 调试覆盖窗口
│   └── ...
├── utils/                         # 工具类
│   ├── multi_priority_queue.py    # 多级优先队列
│   ├── priority_deque.py          # 优先级队列(兼容)
│   ├── native_graphics_capture_manager.py # 图形捕获
│   ├── border_frame_manager.py    # 边框管理
│   ├── hotkey_manager.py          # 热键管理
│   └── ...
└── native_capture/                # C++原生捕获库
    ├── capture_lib.cpp            # DXGI捕获实现
    ├── capture_lib.h              # C接口定义
    ├── python_wrapper.py          # Python包装器
    └── ...
```