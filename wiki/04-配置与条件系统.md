# 04 配置与条件系统

## 概述

配置系统是pyahk的核心基础设施，提供灵活的JSON配置管理和强大的条件逻辑系统。支持热重载、配置验证和多配置文件管理，为复杂的游戏自动化需求提供精确的控制能力。

---

## 📋 配置管理架构

### ConfigManager 核心功能
```python
class ConfigManager:
    """统一配置管理器"""
    def __init__(self):
        self._configs = {}
        self._watchers = {}
        self._schema_validator = None
    
    def load_config(self, config_file: str) -> dict:
        """加载并验证配置文件"""
        
    def save_config(self, config_file: str, config_data: dict):
        """保存配置到文件"""
        
    def hot_reload(self, config_file: str):
        """热重载配置，无需重启程序"""
```

### 配置文件结构
```json
{
  "version": "1.0",
  "global": {
    "debug_mode": false,
    "capture_interval": 100,
    "log_level": "INFO"
  },
  "skills": [
    {
      "name": "主要技能",
      "key": "1",
      "trigger_mode": 1,
      "execute_condition": 2,
      "priority": "high",
      "enabled": true
    }
  ],
  "resource_management": {
    "hp_config": {
      "enabled": true,
      "key": "1",
      "threshold": 50,
      "center_x": 175,
      "center_y": 957,
      "radius": 39,
      "colors": [
        {
          "name": "HP Normal",
          "target_h": 157,
          "target_s": 75,
          "target_v": 29,
          "tolerance_h": 5,
          "tolerance_s": 20,
          "tolerance_v": 20
        }
      ]
    },
    "mp_config": {
      "enabled": true,
      "key": "2",
      "threshold": 50,
      "center_x": 175,
      "center_y": 957,
      "radius": 39,
      "colors": [...]
    },
    "check_interval": 200
  },
  "priority_keys": {
    "enabled": true,
    "keys": ["space", "right_mouse"]
  },
  "pathfinding": {
    "enabled": false,
    "minimap_region": [1670, 50, 200, 200],
    "exploration_mode": "systematic"
  },
  "affix_reroll": {
    "enabled": false,
    "target_affixes": ["暴击率", "暴击伤害"],
    "max_attempts": 100
  }
}
```

### 配置验证与类型检查
```python
from pydantic import BaseModel, Field
from typing import List, Optional, Tuple

class SkillConfig(BaseModel):
    name: str
    key: str
    trigger_mode: int = Field(ge=0, le=2)
    execute_condition: int = Field(ge=0, le=2)
    priority: bool = False
    enabled: bool = True
    interval: Optional[int] = Field(None, ge=50)
    cooldown_coords: Optional[List[int]] = None

class GlobalConfig(BaseModel):
    debug_mode: bool = False
    capture_interval: int = Field(100, ge=50, le=1000)
    log_level: str = Field("INFO", regex="^(DEBUG|INFO|WARNING|ERROR)$")
```

### 配置热重载机制
```python
class ConfigWatcher:
    """配置文件变化监控"""
    def __init__(self, config_manager):
        self.config_manager = config_manager
        self.file_watchers = {}
    
    def watch_config_file(self, config_file: str):
        """监控配置文件变化，自动重载"""
        from watchdog.observers import Observer
        from watchdog.events import FileSystemEventHandler
        
        class ConfigFileHandler(FileSystemEventHandler):
            def on_modified(self, event):
                if event.src_path.endswith('.json'):
                    self.config_manager.hot_reload(event.src_path)
```

---

## 🎯 条件系统详解

### 设计目标
- **简单可枚举**：使用整型枚举值 0/1/2 控制分支
- **扩展友好**：新增条件时只需增加枚举 + `_evaluate_condition` 分支
- **稳定防抖**：资源条件加入连续窗口，避免边界抖动

### 条件枚举概览

| 值 | 名称 | 语义 | 适用场景 |
|----|------|------|----------|
| 0 | 无条件 | 直接允许执行 | 普通循环技能 |
| 1 | BUFF 限制 | 仅当指定 Buff 不存在/失效时执行 | 维持类技能、需刷新状态 |
| 2 | 资源条件 | 资源达到阈值且在连续窗口内稳定 | 资源驱动爆发/消耗类 |

### 执行调用栈
```python
def _try_execute_skill(skill):
    """技能执行入口"""
    if not skill.enabled:
        return False
    
    if not self._check_execution_conditions(skill):
        return False
    
    return self._execute_skill_action(skill)

def _check_execution_conditions(skill):
    """条件检查分发器"""
    condition = skill.execute_condition
    
    if condition == 0:
        return True  # 无条件
    elif condition == 1:
        return self._evaluate_condition_buff(skill)
    elif condition == 2:
        return self._evaluate_condition_resource(skill)
    else:
        LOG_ERROR(f"未知的执行条件: {condition}")
        return False
```

### 无条件模式 (ExecuteCondition = 0)
```json
{
  "name": "基础攻击",
  "key": "1",
  "trigger_mode": 1,
  "execute_condition": 0,
  "cooldown_coords": [100, 50, 20, 20]
}
```
- **行为**：冷却就绪时直接执行主按键
- **适用**：无特殊限制的常规技能
- **优势**：简单直接，性能最高

### Buff限制模式 (ExecuteCondition = 1)
```json
{
  "name": "护盾技能",
  "key": "e",
  "trigger_mode": 1,
  "execute_condition": 1,
  "buff_coords": [200, 100, 30, 30],
  "buff_color": [100, 150, 200],
  "buff_tolerance": 20
}
```

#### 检测逻辑
```python
def _evaluate_condition_buff(self, skill):
    """Buff存在性检测"""
    if not skill.buff_coords:
        return True
    
    frame = self.border_manager.get_current_frame()
    if frame is None:
        return False
    
    x, y, w, h = skill.buff_coords
    roi = frame[y:y+h, x:x+w]
    
    # RGB颜色匹配检测Buff图标
    target_color = skill.buff_color
    tolerance = skill.buff_tolerance or 20
    
    similarity = self._calculate_color_similarity(roi, target_color)
    buff_exists = similarity > 0.8  # 80%相似度阈值
    
    # Buff存在时不执行，不存在时执行
    return not buff_exists
```

#### 应用场景
- **护盾技能**：护盾消失时自动重新施放
- **增益BUFF**：BUFF到期时自动刷新
- **状态维持**：确保关键状态持续存在

### 资源条件模式 (ExecuteCondition = 2)
```json
{
  "name": "消耗技能",
  "key": "r",
  "trigger_mode": 1,
  "execute_condition": 2,
  "resource_coords": [50, 950, 200, 20],
  "resource_threshold": 70,
  "resource_type": "mp",
  "alt_key": "t",
  "continuity_window": 3,
  "continuity_threshold": 2
}
```

#### 连续性检测机制
```python
class ResourceContinuityChecker:
    """资源条件连续性检测器"""
    def __init__(self):
        self._resource_history = {}  # skill_name -> deque
    
    def check_resource_continuity(self, skill_name, is_sufficient, window_size=3, threshold_count=2):
        """检查资源条件是否在连续窗口内稳定满足"""
        history = self._resource_history.setdefault(skill_name, deque(maxlen=window_size))
        history.append(is_sufficient)
        
        # 要求最近N次检查中有M次满足条件
        satisfied_count = sum(history)
        return satisfied_count >= threshold_count and len(history) >= window_size
```

#### 资源检测逻辑
```python
def _evaluate_condition_resource(self, skill):
    """资源充足性检测"""
    if not skill.resource_coords:
        return True
    
    # 1. 检测当前资源百分比
    current_percentage = self._detect_resource_percentage(skill)
    if current_percentage is None:
        return False
    
    # 2. 判断是否满足阈值
    threshold = skill.resource_threshold or 50
    is_sufficient = current_percentage >= threshold
    
    # 3. 连续性检查
    window_size = skill.continuity_window or 3
    threshold_count = skill.continuity_threshold or 2
    
    is_stable = self.continuity_checker.check_resource_continuity(
        skill.name, is_sufficient, window_size, threshold_count
    )
    
    if is_stable:
        # 资源充足且稳定，执行主按键
        self._execute_key(skill.key)
        return True
    elif skill.alt_key:
        # 资源不足，执行备用按键
        self._execute_key(skill.alt_key)
        return True
    
    return False
```

#### 双按键策略
- **主按键**：资源充足时使用的高消耗技能
- **备用按键**：资源不足时使用的低消耗替代技能
- **智能切换**：根据实时资源状态自动选择合适的技能

---

## 🔧 高级配置技巧

### 1. 技能优先级配置
```json
{
  "skills": [
    {
      "name": "紧急治疗",
      "priority": "emergency",
      "execute_condition": 2,
      "resource_type": "hp",
      "resource_threshold": 30
    },
    {
      "name": "主要输出",
      "priority": "high",
      "execute_condition": 1,
      "buff_coords": [300, 100, 40, 40]
    },
    {
      "name": "辅助技能",
      "priority": "normal",
      "execute_condition": 0
    },
    {
      "name": "拾取物品",
      "priority": "low",
      "execute_condition": 0
    }
  ]
}
```

#### 优先级等级说明
- **emergency**：紧急优先级，用于HP/MP药剂等关键操作
- **high**：高优先级，用于核心输出和重要BUFF技能
- **normal**：普通优先级，用于常规攻击技能
- **low**：低优先级，用于辅助功能和界面操作

### 2. 条件组合策略
```json
{
  "name": "复合条件技能",
  "key": "q",
  "execute_condition": 2,
  "resource_coords": [50, 950, 200, 20],
  "resource_threshold": 80,
  "additional_conditions": {
    "buff_check": {
      "coords": [200, 100, 30, 30],
      "required": false
    },
    "enemy_presence": {
      "coords": [500, 400, 100, 100],
      "required": true
    }
  }
}
```

### 3. 环境适配配置
```json
{
  "profiles": {
    "1920x1080": {
      "hp_region": [136, 910, 213, 1004],
      "mp_region": [136, 870, 213, 894],
      "skill_size": 20
    },
    "2560x1440": {
      "hp_region": [181, 1213, 284, 1339],
      "mp_region": [181, 1160, 284, 1192],
      "skill_size": 27
    }
  }
}
```

### 4. 优先级按键配置
```json
{
  "priority_keys": {
    "enabled": true,
    "keys": ["space", "right_mouse"],
    "description": "闪避+右键技能优先级"
  }
}
```

#### 配置说明
- **enabled**：是否启用优先级按键系统
- **keys**：优先级按键列表，支持多种按键名称变体
- **description**：配置描述（可选）

#### 支持的按键类型
- **键盘按键**：`space`, `ctrl`, `shift`, `alt`, `tab`, `enter`, `esc`, `a-z`, `0-9`, `f1-f12`
- **鼠标按键**：`left_mouse`, `right_mouse`, `middle_mouse`
- **按键标准化**：自动处理变体（如 `spacebar` → `space`）

### 5. 智能药剂圆形检测配置
```json
{
  "resource_management": {
    "hp_config": {
      "enabled": true,
      "key": "1",
      "threshold": 50,
      "center_x": 175,
      "center_y": 957,
      "radius": 39,
      "colors": [
        {
          "name": "HP Normal",
          "target_h": 157,
          "target_s": 75,
          "target_v": 29,
          "tolerance_h": 5,
          "tolerance_s": 20,
          "tolerance_v": 20
        }
      ]
    },
    "mp_config": {
      "enabled": true,
      "key": "2",
      "threshold": 50,
      "center_x": 175,
      "center_y": 957,
      "radius": 39,
      "colors": [
        {
          "name": "MP Normal",
          "target_h": 104,
          "target_s": 80,
          "target_v": 58,
          "tolerance_h": 4,
          "tolerance_s": 5,
          "tolerance_v": 5
        }
      ]
    }
  }
}
```

#### 圆形检测优势
- **精确度更高**：只检测球体区域，排除背景干扰
- **自动识别**：支持"Detect Orbs"按钮自动识别球体位置
- **抗干扰强**：圆形蒙版确保只计算球体内的像素

#### 矩形检测配置（向后兼容）
```json
{
  "resource_management": {
    "hp_config": {
      "enabled": true,
      "key": "1",
      "threshold": 50,
      "region_x1": 136,
      "region_y1": 910,
      "region_x2": 213,
      "region_y2": 1004,
      "colors": [...]
    }
  }
}
```

### 6. 调试配置
```json
{
  "debug": {
    "enabled": true,
    "log_conditions": true,
    "log_resource_detection": true,
    "log_priority_keys": true,
    "save_detection_frames": false,
    "condition_log_interval": 1000
  }
}
```

---

## 🔄 配置最佳实践

### 1. 渐进式配置
```python
# 第一阶段：基础技能配置
basic_skills = [
    {"name": "攻击", "key": "1", "trigger_mode": 0, "execute_condition": 0}
]

# 第二阶段：添加冷却检测
advanced_skills = [
    {"name": "攻击", "key": "1", "trigger_mode": 1, "execute_condition": 0,
     "cooldown_coords": [100, 50, 20, 20]}
]

# 第三阶段：添加复杂条件
expert_skills = [
    {"name": "攻击", "key": "1", "trigger_mode": 1, "execute_condition": 2,
     "cooldown_coords": [100, 50, 20, 20],
     "resource_coords": [50, 950, 200, 20],
     "resource_threshold": 70}
]
```

### 2. 配置模板
```json
{
  "templates": {
    "basic_skill": {
      "trigger_mode": 1,
      "execute_condition": 0,
      "priority": "normal",
      "enabled": true
    },
    "high_priority_skill": {
      "trigger_mode": 1,
      "execute_condition": 0,
      "priority": "high",
      "enabled": true
    },
    "emergency_skill": {
      "trigger_mode": 1,
      "execute_condition": 0,
      "priority": "emergency",
      "enabled": true
    },
    "resource_skill": {
      "trigger_mode": 1,
      "execute_condition": 2,
      "resource_threshold": 70,
      "continuity_window": 3,
      "continuity_threshold": 2,
      "priority": "normal"
    },
    "buff_skill": {
      "trigger_mode": 1,
      "execute_condition": 1,
      "buff_tolerance": 20,
      "priority": "high"
    },
    "circular_hp_potion": {
      "enabled": true,
      "threshold": 50,
      "center_x": 175,
      "center_y": 957,
      "radius": 39,
      "colors": [
        {
          "name": "HP Normal",
          "target_h": 157,
          "target_s": 75,
          "target_v": 29,
          "tolerance_h": 5,
          "tolerance_s": 20,
          "tolerance_v": 20
        }
      ]
    },
    "rectangular_mp_potion": {
      "enabled": true,
      "threshold": 50,
      "region_x1": 1552,
      "region_y1": 910,
      "region_x2": 1560,
      "region_y2": 1004,
      "colors": [
        {
          "name": "MP Normal",
          "target_h": 104,
          "target_s": 80,
          "target_v": 58,
          "tolerance_h": 4,
          "tolerance_s": 5,
          "tolerance_v": 5
        }
      ]
    }
  }
}
```

### 3. 配置验证
```python
def validate_skill_config(skill_config):
    """配置验证函数"""
    errors = []

    # 必需字段检查
    required_fields = ["name", "key", "trigger_mode"]
    for field in required_fields:
        if field not in skill_config:
            errors.append(f"缺少必需字段: {field}")

    # 优先级验证
    priority = skill_config.get("priority", "normal")
    valid_priorities = ["emergency", "high", "normal", "low"]
    if priority not in valid_priorities:
        errors.append(f"无效的优先级: {priority}，应为: {valid_priorities}")

    # 条件特定验证
    execute_condition = skill_config.get("execute_condition", 0)
    if execute_condition == 1:  # BUFF条件
        if not skill_config.get("buff_coords"):
            errors.append("BUFF条件模式需要配置buff_coords")
    elif execute_condition == 2:  # 资源条件
        if not skill_config.get("resource_coords"):
            errors.append("资源条件模式需要配置resource_coords")

    return errors

def validate_resource_config(resource_config):
    """智能药剂配置验证"""
    errors = []

    # 检查是否至少配置了矩形或圆形检测方式
    has_rect_config = all(k in resource_config for k in ["region_x1", "region_y1", "region_x2", "region_y2"])
    has_circle_config = all(k in resource_config for k in ["center_x", "center_y", "radius"])

    if not has_rect_config and not has_circle_config:
        errors.append("需要配置矩形检测区域或圆形检测参数")

    # 颜色配置验证
    colors = resource_config.get("colors", [])
    if not colors:
        errors.append("至少需要配置一种颜色用于检测")

    for i, color in enumerate(colors):
        required_fields = ["target_h", "target_s", "target_v", "tolerance_h", "tolerance_s", "tolerance_v"]
        for field in required_fields:
            if field not in color:
                errors.append(f"颜色{i+1}缺少字段: {field}")

    return errors

def validate_priority_keys_config(config):
    """优先级按键配置验证"""
    errors = []

    if not isinstance(config.get("enabled"), bool):
        errors.append("enabled字段必须为布尔值")

    keys = config.get("keys", [])
    if not isinstance(keys, list):
        errors.append("keys字段必须为数组")

    # 标准化按键名称检查
    valid_key_patterns = [
        r'^[a-zA-Z0-9]$',  # 单字母数字
        r'^f[0-9]{1,2}$',  # F1-F12
        r'^(ctrl|shift|alt|space|tab|enter|esc)$',  # 特殊键
        r'^(left_mouse|right_mouse|middle_mouse)$'  # 鼠标键
    ]

    import re
    for key in keys:
        if not any(re.match(pattern, key) for pattern in valid_key_patterns):
            errors.append(f"无效的按键名称: {key}")

    return errors
```

通过这套完整的配置和条件系统，pyahk能够适应各种复杂的游戏场景和用户需求，提供精确的自动化控制能力。