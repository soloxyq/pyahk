# 12 条件系统详解

本章解析技能 `ExecuteCondition` 枚举以及相关的资源连续性检测、Buff 限制策略的执行路径，帮助正确配置与扩展条件逻辑。

---
## 1. 设计目标
- 简单可枚举：使用整型枚举值 0/1/2 控制分支
- 扩展友好：新增条件时只需增加枚举 + `_evaluate_condition` 分支
- 稳定防抖：资源条件加入连续窗口，避免边界抖动

---
## 2. 条件枚举概览
| 值 | 名称 | 语义 | 适用场景 |
|----|------|------|----------|
| 0 | 无条件 | 直接允许执行 | 普通循环技能 |
| 1 | BUFF 限制 | 仅当指定 Buff 不存在/失效时执行 | 维持类技能、需刷新状态 |
| 2 | 资源条件 | 资源达到阈值且在连续窗口内稳定 | 资源驱动爆发/消耗类 |

> Buff 的存在性/失效检测可依赖未来扩展：日志解析 / 屏幕图标识别 / 状态内缓存。

---
## 3. 执行调用栈
```
_try_execute_skill(skill)
  └─ _check_execution_conditions(skill)
       ├─ ExecuteCondition == 0 → True
       ├─ ExecuteCondition == 1 → _evaluate_condition_buff(skill)
       └─ ExecuteCondition == 2 → _evaluate_condition_resource(skill)
                                   └─ _check_resource_continuity(name, now)
```

---
## 4. 资源条件 (ExecuteCondition=2)

目标：避免瞬时阈值抖动导致技能被频繁触发。策略：要求在最近 N 次检查中，有 M 次判定资源条件满足（或全部满足）。

| 参数 | 说明 |
|------|------|
| 窗口大小(window) | 最近统计的判定次数（例如 3~5） |
| 最低满足次数(threshold_count) | 满足次数达到此值判定稳定 |
| 时间跨度 | 使用时间戳过滤过期记录（如 >1.5s 清理） |

实现思路（伪代码）：
```python
win = self._resource_history.setdefault(skill_name, deque(maxlen=window))
win.append( current_condition_boolean )
if sum(win) >= threshold_count:
    return True
return False
```

---
## 5. Buff 限制 (ExecuteCondition=1)

语义：当某个 Buff “不在”时才释放，用于维持类技能刷新机制。

检测来源可扩展：
- 方式1：内部状态缓存（技能释放后写入，超时失效）
- 方式2：屏幕图标 HSV / 模板检测（尚可扩展）
- 方式3：外部插件回调

当前若未实现具体 Buff 读取，可临时：
- 返回 True（允许执行）或
- 利用 debug 日志标记“待实现”

---
## 6. 与冷却检测协同

执行路径顺序：
1. （冷却模式）先判定冷却图标是否“Ready”
2. 再进入条件系统判定（ExecuteCondition 分支）
3. 通过后才入队输入

优势：减少不必要的条件计算（冷却都没好无需做复杂资源检查）。

---
## 7. Debug 支持

- 在 DEBUG 日志中打印：`[cond] skill=X mode=2 window=3/5 pass=True`
- 可为资源窗口添加可视化（未来在 Debug OSD 添加“R(x/5)”字段）

---
## 8. 扩展示例：新增“怪物数量”条件 (ExecuteCondition=3)

步骤：
1. 枚举注释中登记 3 的语义
2. `_evaluate_condition()` 增加分支：
```python
elif cond == 3:
    return self._evaluate_condition_enemy_count(skill)
```
3. 新增方法：
```python
def _evaluate_condition_enemy_count(self, skill):
    cnt = self._enemy_counter.estimate()
    return cnt >= skill.config.get("EnemyCountMin", 3)
```
4. 文档：更新本章节表格

---
## 9. 常见问题排查
| 现象 | 可能原因 | 解决 |
|------|----------|------|
| 条件始终不触发 | 资源窗口阈值过高 | 降低 threshold_count / 调整窗口 | 
| 频繁触发 | 未使用窗口防抖 | 启用 `_check_resource_continuity` |
| Buff 条件无效 | 缺少实际检测实现 | 添加缓存或屏幕检测 | 
| 冷却技能跳过条件 | 判定顺序错误 | 确认先冷却再条件 |

---
## 10. 优化建议
- 对资源窗口去噪：使用滑动平均或指数平滑提升稳定性
- 条件缓存：同一帧多技能共享的基础数据（如当前资源%) 可预先计算一次
- 分级日志：仅在条件翻转（True→False / False→True）时输出

---
本章完。返回目录：`README` 或继续阅读下一章节。
