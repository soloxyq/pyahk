# 智能药剂系统

## 概述

智能药剂系统是pyahk的高级功能，采用先进的HSV双色检测算法，支持正常/中毒状态智能识别，实现精确的HP/MP检测和自动喂药功能。系统采用三层委托架构，确保高度可维护性和扩展性。

## 技术架构

### 三层委托架构

#### 第1层：SkillManager (调度层)
- **职责**：通过UnifiedScheduler按固定间隔启动资源检查任务
- **调度间隔**：默认200ms，可配置范围50-1000ms
- **无业务逻辑**：仅负责任务调度，不关心药剂具体逻辑

#### 第2层：ResourceManager (业务逻辑层)
- **职责**：药剂功能的"大脑"，负责所有业务决策
- **核心功能**：
  - 接收调度和帧数据
  - 管理药剂内部冷却时间
  - 决策是否需要使用药剂
  - 委托底层进行图像检测
- **被动执行**：无独立线程，完全由上层驱动

#### 第3层：BorderFrameManager (统一检测层)
- **职责**：所有图像检测的统一核心
- **智能路由**：通过skill_name参数区分任务类型
- **检测算法**：HSV模板匹配，比较当前帧与F8缓存模板

## 检测技术

### HSV双色检测算法
```python
# HSV颜色空间检测，支持环形色相处理
def hsv_match_percentage(current_hsv, template_hsv, tolerance):
    h_diff = min(abs(h1 - h2), 360 - abs(h1 - h2))  # 处理色相环形
    s_diff = abs(s1 - s2)
    v_diff = abs(v1 - v2)
    # 计算匹配百分比
```

### 模板缓存机制
- **F8准备阶段**：自动截取并保存HP/MP区域的HSV模板
- **运行时检测**：与缓存模板进行实时比较
- **动态容差**：支持不同光照条件下的稳定检测

### 检测方法对比

| 检测类型 | 算法 | 优势 | 适用场景 |
|---------|------|------|----------|
| RGB检测 | 像素RGB值比较 | 简单快速 | 固定环境 |
| HSV检测 | 色相饱和度明度 | 光照适应性强 | 动态环境 |
| 双色检测 | 正常+中毒状态 | 状态感知 | 复杂游戏机制 |

## 功能特性

### 1. 智能状态识别
- **正常状态**：血条/蓝条正常颜色检测
- **中毒状态**：自动识别中毒时的颜色变化
- **双重判断**：结合两种状态提高检测准确性

### 2. 内部冷却机制
```python
# 防止药水浪费的冷却控制
hp_cooldown = 5000  # HP药剂5秒冷却
mp_cooldown = 8000  # MP药剂8秒冷却
```

### 3. 1080P优化配置
```python
# 针对1080P屏幕的默认配置
hp_defaults = {
    "region": (136, 910, 213, 1004),    # 血条区域
    "hsv": (314, 75, 29),               # 血药颜色HSV
    "tolerance": (10, 20, 20),          # 颜色容差
    "threshold": 50,                    # 50%触发阈值
    "cooldown": 5000,                   # 5秒冷却
    "key": "1"                          # 默认按键
}

mp_defaults = {
    "region": (1552, 910, 1560, 1004), # 蓝条区域
    "hsv": (208, 80, 58),               # 蓝药颜色HSV
    "tolerance": (7, 5, 5),             # 更严格容差
    "threshold": 50,                    # 50%触发阈值
    "cooldown": 8000,                   # 8秒冷却
    "key": "2"                          # 默认按键
}
```

## 配置指南

### 基础配置
1. **启用功能**：在"智能药剂"标签页启用HP/MP检测
2. **设置区域**：使用"📦 选择区域"工具选择血条/蓝条位置
3. **颜色拾取**：使用"🎨 拾取颜色"工具获取精确HSV值
4. **阈值设置**：设置触发药剂使用的血量/蓝量百分比

### 高级配置
- **容差调整**：根据游戏光照效果调整HSV容差
- **冷却时间**：根据药剂类型设置合适的内部冷却
- **检测间隔**：在性能和精度之间平衡检测频率

### 配置示例
```json
{
  "resource_management": {
    "enabled": true,
    "check_interval": 200,
    "hp_config": {
      "enabled": true,
      "region_x1": 136, "region_y1": 910,
      "region_x2": 213, "region_y2": 1004,
      "hsv_h": 314, "hsv_s": 75, "hsv_v": 29,
      "tolerance_h": 10, "tolerance_s": 20, "tolerance_v": 20,
      "threshold": 50,
      "cooldown": 5000,
      "key": "1"
    },
    "mp_config": {
      "enabled": true,
      "region_x1": 1552, "region_y1": 910,
      "region_x2": 1560, "region_y2": 1004,
      "hsv_h": 208, "hsv_s": 80, "hsv_v": 58,
      "tolerance_h": 7, "tolerance_s": 5, "tolerance_v": 5,
      "threshold": 50,
      "cooldown": 8000,
      "key": "2"
    }
  }
}
```

## 使用工具

### 区域选择工具
- **功能**：可视化选择血条/蓝条区域
- **操作**：主界面自动隐藏，全屏拖拽选择
- **特点**：实时显示坐标，精确到像素

### 颜色拾取工具
- **功能**：放大镜式颜色拾取
- **操作**：鼠标移动实时显示HSV值
- **特点**：点击确认，自动填入配置

### 实时预览
- **状态显示**：实时显示当前血量/蓝量百分比
- **匹配度显示**：显示HSV模板匹配度
- **冷却状态**：显示药剂内部冷却倒计时

## 使用流程

### 初始设置
1. 启动游戏并进入有血条/蓝条的界面
2. 在"智能药剂"标签页启用功能
3. 使用工具选择检测区域和拾取颜色
4. 设置触发阈值和冷却时间
5. 保存配置

### 运行使用
1. **F8准备**：进入READY状态，自动缓存HSV模板
2. **Z开始**：开始运行，启动药剂检测任务
3. **自动执行**：系统自动检测并在需要时使用药剂
4. **状态监控**：通过日志和界面监控运行状态

### Debug模式
- 启用debug模式可查看详细的检测日志
- 实时显示HSV匹配度和触发决策过程
- 帮助调试和优化配置参数

## 性能优化

### 帧复用机制
- 同一检测周期内复用屏幕帧数据
- 避免重复截图带来的性能开销
- 与技能检测系统共享帧数据

### 智能调度
- 通过统一调度器精确控制检测间隔
- 支持动态调整检测频率
- 在性能和响应速度间平衡

### 内存优化
- HSV模板数据轻量化存储
- 及时释放不需要的图像数据
- 避免内存泄漏和过度占用

## 故障排除

### 常见问题

1. **检测不准确**
   - 检查区域选择是否准确
   - 调整HSV容差参数
   - 确认游戏界面缩放设置

2. **药剂不执行**
   - 检查按键设置是否正确
   - 确认冷却时间设置
   - 查看debug日志定位问题

3. **频繁误触发**
   - 增加容差范围
   - 调整触发阈值
   - 优化检测区域位置

### Debug技巧
- 开启debug模式查看详细日志
- 使用截图保存功能验证检测区域
- 实时监控HSV值变化趋势