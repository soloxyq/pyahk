# ä¼˜å…ˆçº§æŒ‰é”®æš‚åœ/æ¢å¤æ¶æ„è¯´æ˜

## æ¦‚è¿°

æœ¬æ¶æ„å®ç°äº†ä¸€ä¸ªé«˜æ•ˆçš„"æš‚åœ/æ¢å¤"æœºåˆ¶ï¼Œå½“ç”¨æˆ·æŒ‰ä¸‹ä¼˜å…ˆçº§æŒ‰é”®ï¼ˆå¦‚ç©ºæ ¼é”®ã€å³é”®ç­‰ï¼‰æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æš‚åœ `SkillManager` çš„æ‰€æœ‰è°ƒåº¦ä»»åŠ¡ï¼Œä»¥é¿å…ä¸å¿…è¦çš„ CPU èµ„æºæµªè´¹ã€‚å½“ä¼˜å…ˆçº§æŒ‰é”®é‡Šæ”¾åï¼Œç³»ç»Ÿè‡ªåŠ¨æ¢å¤æ­£å¸¸è°ƒåº¦ã€‚

## æ ¸å¿ƒåŸç†

### é—®é¢˜èƒŒæ™¯
- ä¹‹å‰çš„å®ç°ä¸­ï¼Œå½“ä¼˜å…ˆçº§æŒ‰é”®è¢«æŒ‰ä¸‹æ—¶ï¼Œè™½ç„¶æŠ€èƒ½æ‰§è¡Œè¢«é˜»å¡ï¼Œä½† `UnifiedScheduler` ä»ç„¶ç»§ç»­è¿è¡Œ
- è¿™å¯¼è‡´ `check_cooldowns`ã€å¸§æ£€æµ‹ã€èµ„æºæ£€æŸ¥ç­‰è€—è´¹ CPU çš„ä»»åŠ¡ä»åœ¨æ‰§è¡Œï¼Œä½†ç»“æœå®Œå…¨è¢«ä¸¢å¼ƒ
- é€ æˆäº†"é›¶åŠŸæ•ˆçš„èµ„æºæµªè´¹"

### è§£å†³æ–¹æ¡ˆ
å®ç°äº†ä¸€ä¸ªåŸºäºäº‹ä»¶æ€»çº¿çš„åŒå‘é€šä¿¡æœºåˆ¶ï¼š

1. **InputHandler** ç›‘æ§ä¼˜å…ˆçº§æŒ‰é”®çŠ¶æ€å˜åŒ–
2. å½“ç¬¬ä¸€ä¸ªä¼˜å…ˆçº§æŒ‰é”®æŒ‰ä¸‹æ—¶ï¼Œé€šè¿‡äº‹ä»¶æ€»çº¿é€šçŸ¥ **SkillManager** æš‚åœè°ƒåº¦
3. å½“æ‰€æœ‰ä¼˜å…ˆçº§æŒ‰é”®é‡Šæ”¾æ—¶ï¼Œé€šè¿‡äº‹ä»¶æ€»çº¿é€šçŸ¥ **SkillManager** æ¢å¤è°ƒåº¦

## æ¶æ„ç»„ä»¶

### 1. InputHandler (ä¼˜å…ˆçº§æŒ‰é”®ç›‘æ§)

**æ–‡ä»¶**: `torchlight_assistant/core/input_handler.py`

**å…³é”®æ–¹æ³•**:
```python
def _pause_skill_scheduler(self):
    """æš‚åœæŠ€èƒ½è°ƒåº¦å™¨ä»¥èŠ‚çœCPUèµ„æº"""
    event_bus.publish('scheduler_pause_requested', {
        'reason': 'priority_key_pressed',
        'active_keys': list(self._priority_keys_pressed)
    })

def _resume_skill_scheduler(self):
    """æ¢å¤æŠ€èƒ½è°ƒåº¦å™¨"""
    event_bus.publish('scheduler_resume_requested', {
        'reason': 'priority_key_released'
    })
```

**è§¦å‘æ—¶æœº**:
- `_on_key_press`: ç¬¬ä¸€ä¸ªä¼˜å…ˆçº§æŒ‰é”®æŒ‰ä¸‹æ—¶è§¦å‘æš‚åœ
- `_on_key_release`: æœ€åä¸€ä¸ªä¼˜å…ˆçº§æŒ‰é”®é‡Šæ”¾æ—¶è§¦å‘æ¢å¤
- `_on_mouse_click`: é¼ æ ‡ä¼˜å…ˆçº§æŒ‰é”®çš„æŒ‰ä¸‹/é‡Šæ”¾

### 2. SkillManager (è°ƒåº¦å™¨æ§åˆ¶)

**æ–‡ä»¶**: `torchlight_assistant/core/skill_manager.py`

**äº‹ä»¶è®¢é˜…**:
```python
event_bus.subscribe("scheduler_pause_requested", self._on_scheduler_pause_requested)
event_bus.subscribe("scheduler_resume_requested", self._on_scheduler_resume_requested)
```

**å›è°ƒæ–¹æ³•**:
```python
def _on_scheduler_pause_requested(self, event_data):
    """å“åº”ä¼˜å…ˆçº§æŒ‰é”®æŒ‰ä¸‹ - æš‚åœè°ƒåº¦å™¨ä»¥èŠ‚çœCPUèµ„æº"""
    if self.unified_scheduler.get_status()["running"]:
        self.unified_scheduler.pause()

def _on_scheduler_resume_requested(self, event_data):
    """å“åº”ä¼˜å…ˆçº§æŒ‰é”®é‡Šæ”¾ - æ¢å¤è°ƒåº¦å™¨"""
    if self._is_running and not self._is_paused:
        self.unified_scheduler.resume()
```

### 3. UnifiedScheduler (æ ¸å¿ƒè°ƒåº¦å™¨)

**æ–‡ä»¶**: `torchlight_assistant/core/unified_scheduler.py`

**ä¿®å¤çš„æ–¹æ³•**:
```python
def pause(self) -> bool:
    """æš‚åœæ‰€æœ‰ä»»åŠ¡æ‰§è¡Œ"""
    if not self._running or self._paused:
        return False
    self._paused = True
    return True

def resume(self) -> bool:
    """æ¢å¤æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œ"""
    if not self._running or not self._paused:
        return False
    self._paused = False
    # é‡æ–°è®¡ç®—ä»»åŠ¡æ‰§è¡Œæ—¶é—´
    current_time = self._now()
    for task in self._tasks.values():
        if task.enabled:
            task.next_run_time = current_time + task.interval
    self._rebuild_heap()
    self._condition.notify()
    return True
```

## æ€§èƒ½ä¼˜åŒ–æ•ˆæœ

### CPU ä½¿ç”¨ä¼˜åŒ–
- **æš‚åœæœŸé—´**: æ‰€æœ‰è°ƒåº¦ä»»åŠ¡åœæ­¢æ‰§è¡Œï¼ŒCPU ä½¿ç”¨ç‡æ˜¾è‘—é™ä½
- **æ¢å¤æœºåˆ¶**: æ™ºèƒ½é‡æ–°è®¡ç®—ä»»åŠ¡æ‰§è¡Œæ—¶é—´ï¼Œé¿å…å †ç§¯æ‰§è¡Œ

### èµ„æºèŠ‚çº¦
- é¿å…æ— æ•ˆçš„å¸§æ•è·å’Œåƒç´ åˆ†æ
- åœæ­¢å†·å´æ—¶é—´æ£€æŸ¥å’Œèµ„æºçŠ¶æ€æ›´æ–°
- å‡å°‘ä¸å¿…è¦çš„å†…å­˜åˆ†é…å’Œç½‘ç»œè®¿é—®

### å“åº”æ€§æå‡
- ä¼˜å…ˆçº§æŒ‰é”®å“åº”æ›´åŠ å³æ—¶
- ç³»ç»Ÿæ•´ä½“å“åº”æ€§å¾—åˆ°æ”¹å–„

## çŠ¶æ€ç®¡ç†

### æš‚åœçŠ¶æ€å±‚çº§
1. **ç”¨æˆ·æ‰‹åŠ¨æš‚åœ** (`_is_paused = True`): é€šè¿‡ UI æˆ–çƒ­é”®æš‚åœæ•´ä¸ªç³»ç»Ÿ
2. **ä¼˜å…ˆçº§æŒ‰é”®æš‚åœ** (`unified_scheduler.pause()`): ä¸´æ—¶æ€§èƒ½ä¼˜åŒ–æš‚åœ
3. **ç³»ç»Ÿåœæ­¢** (`_is_running = False`): å®Œå…¨åœæ­¢è¿è¡Œ

### æ¢å¤é€»è¾‘
- åªæœ‰åœ¨ç³»ç»Ÿè¿è¡Œä¸­ï¼ˆ`_is_running = True`ï¼‰ä¸”æœªè¢«ç”¨æˆ·æ‰‹åŠ¨æš‚åœï¼ˆ`_is_paused = False`ï¼‰æ—¶æ‰ä¼šè‡ªåŠ¨æ¢å¤
- ç¡®ä¿ç”¨æˆ·çš„æ‰‹åŠ¨æš‚åœä¸ä¼šè¢«ä¼˜å…ˆçº§æŒ‰é”®çš„è‡ªåŠ¨æ¢å¤æœºåˆ¶è¦†ç›–

## äº‹ä»¶æµç¨‹å›¾

```
ç”¨æˆ·æŒ‰ä¸‹ç©ºæ ¼é”®
      â†“
InputHandler._on_key_press()
      â†“
_pause_skill_scheduler()
      â†“
event_bus.publish('scheduler_pause_requested')
      â†“
SkillManager._on_scheduler_pause_requested()
      â†“
unified_scheduler.pause()
      â†“
ğŸ›‘ æ‰€æœ‰è°ƒåº¦ä»»åŠ¡æš‚åœæ‰§è¡Œ

      â†“ (ç”¨æˆ·é‡Šæ”¾ç©ºæ ¼é”®)

InputHandler._on_key_release()
      â†“
_resume_skill_scheduler()
      â†“
event_bus.publish('scheduler_resume_requested')
      â†“
SkillManager._on_scheduler_resume_requested()
      â†“
unified_scheduler.resume()
      â†“
â–¶ï¸ æ‰€æœ‰è°ƒåº¦ä»»åŠ¡æ¢å¤æ‰§è¡Œ
```

## æµ‹è¯•éªŒè¯

æ¶æ„å·²é€šè¿‡ä»¥ä¸‹æµ‹è¯•éªŒè¯ï¼š

1. **è°ƒåº¦å™¨æš‚åœ/æ¢å¤åŠŸèƒ½æµ‹è¯•**: âœ… é€šè¿‡
2. **äº‹ä»¶æ€»çº¿é€šä¿¡æµ‹è¯•**: âœ… é€šè¿‡
3. **å¤šä¼˜å…ˆçº§æŒ‰é”®å¤„ç†æµ‹è¯•**: âœ… é€šè¿‡
4. **çŠ¶æ€ç®¡ç†é€»è¾‘æµ‹è¯•**: âœ… é€šè¿‡

## ä¼˜åŠ¿æ€»ç»“

1. **é›¶èµ„æºæµªè´¹**: ä¼˜å…ˆçº§æŒ‰é”®æ¿€æ´»æœŸé—´å®Œå…¨åœæ­¢ä¸å¿…è¦çš„è®¡ç®—
2. **å³æ—¶å“åº”**: æŒ‰é”®æŒ‰ä¸‹åç«‹å³æš‚åœï¼Œé‡Šæ”¾åç«‹å³æ¢å¤
3. **æ™ºèƒ½çŠ¶æ€ç®¡ç†**: å°Šé‡ç”¨æˆ·çš„æ‰‹åŠ¨æš‚åœçŠ¶æ€
4. **çº¿ç¨‹å®‰å…¨**: ä½¿ç”¨äº‹ä»¶æ€»çº¿å’Œæ¡ä»¶å˜é‡ç¡®ä¿çº¿ç¨‹å®‰å…¨
5. **å¯æ‰©å±•æ€§**: æ¶æ„æ”¯æŒæœªæ¥æ·»åŠ æ›´å¤šæš‚åœ/æ¢å¤è§¦å‘æ¡ä»¶

è¿™ä¸ªæ¶æ„å®ç°äº†çœŸæ­£çš„"æŒ‰éœ€è®¡ç®—"ï¼Œåªåœ¨å®é™…éœ€è¦æ—¶æ¶ˆè€— CPU èµ„æºï¼Œæ˜¾è‘—æå‡äº†ç³»ç»Ÿçš„æ•´ä½“æ•ˆç‡ã€‚