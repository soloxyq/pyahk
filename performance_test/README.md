# Performance Test - HP/MP检测性能基准测试

## 📋 概述

这个目录包含HP/MP检测方法的完整性能基准测试，对比了以下4种检测方法：

1. **Template OCR** - 模板匹配OCR引擎
2. **Keras OCR** - 深度学习OCR引擎
3. **Tesseract OCR** - 通用OCR引擎
4. **矩形检测** - HSV颜色模板匹配

## 🚀 快速开始

### 运行完整benchmark测试

```bash
python performance_test/perf_full_benchmark.py
```

### 测试流程

1. 加载 `debug_frame_0002.png` 作为矩形检测的模板（模拟F8按键）
2. 对 `deepai/data/processed/frames/` 目录下的所有frame进行测试
3. 每个frame测试所有4种检测方法
4. 如果3个OCR引擎结果不一致，自动重试一次
5. 计算矩形检测与OCR基准值的误差
6. 生成详细的统计报告

## 📊 测试指标

### 性能指标
- **平均耗时** - 每次检测的平均时间
- **最快/最慢** - 性能范围
- **速度优势** - 相对于矩形检测的速度对比

### 准确性指标（矩形检测）
- **平均误差** - 与OCR基准值的平均差异
- **误差分布** - 误差<5%、<10%、<15%的比例
- **OCR错误案例** - OCR识别错误（百分比>100%）的案例数

### 成功率指标
- **成功识别数** - 成功返回结果的次数
- **识别失败数** - 返回None或错误的次数
- **成功率** - 成功识别数 / 总测试数

## 📁 文件说明

### 核心文件

- **perf_full_benchmark.py** - 完整的benchmark测试脚本
  - 测试所有4种检测方法
  - OCR不一致时自动重试
  - 计算矩形检测准确性
  - 生成详细统计报告

- **benchmark_results.json** - 测试结果数据
  - 每个frame的详细测试结果
  - 所有方法的性能统计
  - 矩形检测准确性分析

- **README.md** - 本文档

### 依赖文件

- **debug_frame_0002.png** - 矩形检测的模板图片（需要在项目根目录）
- **deepai/data/processed/frames/** - 测试用的frame图片目录

## 🎯 测试结果示例

```
================================================================================
测试总结
================================================================================

================================================================================
TEMPLATE 引擎
================================================================================
总测试数: 478 (HP: 239, MP: 239)
成功识别: 470
识别失败: 8
成功率: 98.3%

性能统计:
  平均耗时: 24.7ms
  最快: 18.5ms
  最慢: 35.6ms

================================================================================
RECTANGLE 引擎
================================================================================
总测试数: 478 (HP: 239, MP: 239)
成功识别: 478
识别失败: 0
成功率: 100.0%

性能统计:
  平均耗时: 0.3ms
  最快: 0.2ms
  最慢: 1.0ms

================================================================================
矩形检测准确性分析（与OCR基准值对比）
================================================================================

HP检测准确性:
  总测试数: 239
  OCR合理案例: 235 (OCR在0-100%范围内)
  OCR错误案例: 4 (OCR超出0-100%范围)

  【仅统计OCR合理的案例】
  平均误差: 3.5%
  最大误差: 15.2%
  最小误差: 0.0%
  误差<5%的比例: 95.0%
  误差<10%的比例: 98.0%
  误差<15%的比例: 99.5%

综合评估:
  总测试数: 473
  OCR合理案例: 465
  OCR错误案例: 8

  【仅统计OCR合理的案例】
  平均误差: 3.2%
  最大误差: 15.2%
  误差<5%的比例: 96.0%
  误差<10%的比例: 98.5%

  ⚠️  发现 8 个OCR错误案例
      在这些案例中，矩形检测给出的是合理值（0-100%）
      而OCR识别出了错误的数字，导致百分比超出范围
      这说明：矩形检测在这些情况下比OCR更可靠！
```

## 🔍 关键发现

### 1. 性能对比

| 方法 | 平均耗时 | 速度优势 |
|------|----------|----------|
| 矩形检测 | 0.3ms | 基准 |
| Template OCR | 24.7ms | 慢82倍 |
| Keras OCR | 99.0ms | 慢330倍 |
| Tesseract OCR | 240.9ms | 慢803倍 |

### 2. 准确性对比

- **矩形检测**: 
  - 100%成功率（无失败案例）
  - 96%的案例误差<5%
  - 在OCR识别错误时仍能给出合理值

- **OCR方法**:
  - 98-99%成功率（有失败案例）
  - 存在识别错误（百分比>100%）
  - 性能慢82-803倍

### 3. 结论

**矩形检测是最佳选择：**
- ✅ 性能最快（0.3ms）
- ✅ 成功率最高（100%）
- ✅ 准确性高（96%误差<5%）
- ✅ 在OCR失败时更可靠

## 🛠️ 配置说明

### 矩形检测区域

```python
RECT_REGIONS = {
    "hp": (113, 896, 124, 1051),  # HP条区域
    "mp": (1787, 894, 1800, 1053)  # MP条区域
}
```

### HSV容差

```python
HSV_TOLERANCE = {
    "h_tolerance": 10,  # H值容差
    "s_tolerance": 20,  # S值容差
    "v_tolerance": 20   # V值容差
}
```

### OCR区域

```python
HP_COORDS = (97, 814, 228, 835)   # HP文本区域
MP_COORDS = (1767, 814, 1894, 835) # MP文本区域
```

## 📝 注意事项

1. **模板图片**: 确保 `debug_frame_0002.png` 存在于项目根目录
2. **测试数据**: 确保 `deepai/data/processed/frames/` 目录包含测试frame
3. **依赖安装**: 需要安装所有OCR引擎的依赖
4. **运行时间**: 完整测试约需要10-15分钟（239个frame × 4种方法）

## 🔄 重试机制

当3个OCR引擎结果不一致时，脚本会自动重试一次：

```
⚠️  OCR结果不一致，重试一次...
   HP不一致: ['1583/1583', '15583/1583', '1583/1583']

--- Template 引擎 (重试) ---
  HP: 1583/1583
  ...

✅ HP重试后一致: 1583/1583
```

这有助于：
- 发现OCR的不稳定性
- 提高测试准确性
- 识别需要改进的案例

## 📈 后续优化方向

1. **矩形检测优化**:
   - 调整HSV容差参数
   - 优化连续段检测算法
   - 支持不同分辨率

2. **测试扩展**:
   - 增加更多测试场景
   - 测试不同光照条件
   - 测试不同HP/MP百分比范围

3. **性能优化**:
   - 批量处理优化
   - 并行测试
   - 缓存优化
