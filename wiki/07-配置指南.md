# 07 配置指南

本指南详细说明项目中的各类配置文件、字段含义、默认值及修改建议。内容覆盖：全局配置、技能配置、药剂（资源）配置、热键、执行条件、寻路/洗练/序列模式等。

---
## 1. 配置文件概览

项目主要使用 JSON 格式配置，可通过 GUI 进行加载/保存。常见文件：
- `default.json` / `last.json`：主配置（技能 + 全局 + 热键 + 模式）
- `d4.json` / `d4_druid.json` / `poe2_锐眼.json`：针对不同游戏/职业的定制技能配置
- `notepadtest.json`：测试用示例

所有配置读写由 `ConfigManager` 统一处理，支持局部字段缺失的向后兼容（缺失字段按默认值补全）。

---
## 2. 顶层配置结构 (示例)
```jsonc
{
  "Global": {
    "TargetWindow": "Diablo IV",
    "CaptureMode": "full",              // full / region
    "EnableSound": true,
    "Debug": false
  },
  "Hotkeys": {
    "MainToggle": "F8",                  // 技能模式 准备/停止
    "ExecutePause": "Z",                 // 运行/暂停/恢复
    "RerollToggle": "F7",                // 洗练模式
    "PathToggle": "F9",                  // 寻路模式
    "InPlaceToggle": "F10"               // 原地模式（示例）
  },
  "Skills": {
    "Skill1": { /* 见下方技能配置 */ },
    "Skill2": { /* ... */ }
  },
  "Resource": {
    "HP": { /* 血药配置 */ },
    "MP": { /* 蓝药配置 */ }
  },
  "Sequence": {
    "Enabled": false,
    "Order": ["Skill1","Skill3","Skill2"],
    "Interval": 150
  },
  "Pathfinding": { /* 寻路参数 */ },
  "Reroll": { /* 洗练参数 */ }
}
```

---
## 3. 技能配置字段详解
> 仅保留真实生效字段，遵循三种触发模式：定时 / 冷却 / 按住。

| 字段 | 类型 | 说明 | 适用模式 | 备注 |
|------|------|------|----------|------|
| Enabled | bool | 是否启用该技能 | 全部 | false 时完全忽略 |
| Priority | bool | 高优先级：检查优先 + 队列前端插入 | 定时/冷却 | 不影响按住模式生命周期 |
| TriggerMode | int | 0=定时 1=冷却 2=按住 | 全部 | GUI 下拉选择 |
| Timer | int(ms) | 定时间隔 | 定时 | 建议 >=150ms 避免过度触发 |
| CooldownCoordX | int | 技能图标中心X | 冷却 | 1080P 基准坐标 |
| CooldownCoordY | int | 技能图标中心Y | 冷却 | 与 Size 配合截取 |
| CooldownSize | int | 截取正方形边长 | 冷却 | 典型值 12~20 |
| ExecuteCondition | int | 0=无 1=BUFF限制 2=资源条件 | 定时/冷却 | 按住模式不参与 |
| AltKey | string | 组合修饰键或备用键 | 可选 | 为空表示只发主键 |
| Key | string | 主执行键 | 全部 | e.g. "1", "q", "ctrl+e" (按住模式直接发送 hold) |

### 3.1 触发模式逻辑差异
- 定时：到间隔即尝试执行（先条件→再入队）
- 冷却：按坐标截取图标区域，与准备阶段缓存模板进行相似度对比≥阈值(默认95) 判定可执行
- 按住：状态 RUNNING 时一次性 hold；PAUSED/STOPPED/离开模式时一次性 release

### 3.2 ExecuteCondition 详细
| 值 | 名称 | 判定逻辑 | 典型用途 |
|----|------|----------|----------|
| 0 | 无 | 跳过附加条件 | 一般技能 |
| 1 | BUFF 限制 | 若指定 buff 未激活/失效才允许释放 | 维持类技能、光环刷新 |
| 2 | 资源条件 | 资源(HP/MP/怒气等) 达到阈值连续窗口判真 | 资源驱动爆发技能 |

内部流程：`_try_execute_skill` → `_check_execution_conditions` → `_evaluate_condition` → (资源时) `_check_resource_continuity`。

---
## 4. 药剂 (Resource) 配置

| 字段 | 说明 | 补充 |
|------|------|------|
| region | (x1,y1,x2,y2) 检测区域 | F8 READY 阶段缓存 HSV 模板 |
| hsv | (H,S,V) 目标颜色 | 拾取工具自动生成 |
| tolerance | (dH,dS,dV) 容差 | H 环绕处理，建议 H ≤15 |
| threshold | 触发阈值百分比 | HP/MP 低于则触发；对双色检测取综合值 |
| cooldown | 内部冷却(ms) | 避免过度连按浪费 |
| key | 药剂按键 | 进入冷却前只触发一次 |
| enabled | 是否启用 | false 则完全禁用 |

### 4.1 默认值（1080P）
参见 `README` 中提供的默认示例或 `ResourceManager` 内部常量。若配置缺失自动回填。

### 4.2 检测算法摘要
- F8 READY → `capture_template_hsv()` 截取区域转换 HSV 作为模板
- 运行时 → `BorderFrameManager.compare_cooldown_image("hp_region")` 路由到资源检测
- 内部 `_compare_resource_hsv` 计算当前帧与模板的匹配度，估算剩余比例
- 低于 threshold 且未处于内部冷却 → 入队使用药剂 → 记录时间戳

---
## 5. 序列模式 (Sequence)

| 字段 | 说明 |
|------|------|
| Enabled | 是否启用 |
| Order | 技能名称数组（按顺序循环） |
| Interval | 两次序列触发间隔(ms) |

启用后序列任务作为独立调度项插入，内部仍尊重技能自身条件（冷却/资源）与优先级。

---
## 6. 寻路(Pathfinding) 关键参数 (示例)
常见可配置含义（实际字段以实现为准）：
- `Enabled`: 是否启用寻路功能
- `ExploreMode`: explore / navigate 模式标志
- `StepDistance`: 每次移动步长像素（影响点击偏移）
- `MapSize`: 全局拼接数组边长，如 5000
- `TargetColorHSV`: 目标点 HSV 过滤参数
- `ReplanInterval`: 重规划检查间隔

---
## 7. 洗练(Reroll) 配置摘要
- `Enabled`: 是否启用
- `AffixTargets`: 目标词缀集合
- `MaxAttempts`: 最大重铸次数
- `OcrConfidence`: OCR 置信度阈值
- `Hotkey`: 触发键（如 F7）
- `Interval`: 循环间隔 / 动作节流

---
## 8. 热键 (Hotkeys)

| 热键 | 作用 |
|------|------|
| F8 | 技能模式 STOPPED ↔ READY ↔ (Z) RUNNING |
| Z | READY→RUNNING / RUNNING→PAUSED / PAUSED→RUNNING |
| F7 | 装备洗练模式切换 |
| F9 | 寻路模式切换 |
| F10(示例) | 原地模式切换 |

热键由 `HotkeyManager` 注册；状态变化经 `EventBus` 广播，驱动 UI 与调度行为更新。

---
## 9. Debug / 日志相关
- 设置环境变量 `DEBUG=1` → 启用详细日志
- Debug OSD：显示 HP/MP/技能冷却状态、最近动作队列（dry_run 模式）
- `DebugDisplayManager` 在 RUNNING 状态周期发布；PAUSED/READY 停止发布但保留最后帧；STOPPED 隐藏
- 关键事件含 `engine:state_changed`, `debug_osd_update`, `debug_osd_ready_state`

---
## 10. 安全与性能建议
- 避免毫秒级过低定时（<80ms），收益极低还会增加 CPU 占用
- 冷却图标 `CooldownSize` 不宜过大：增加无用像素噪声
- 合理分配优先级，防止低价值技能抢占输入队列
- 屏幕捕获全屏模式下，非必要不要开启过多高频检测任务
- 资源阈值适度：避免在边界抖动频繁触发

---
## 11. 常见配置错误与排查
| 现象 | 可能原因 | 解决 |
|------|----------|------|
| 技能不释放 | Enabled=false 或条件未满足 | 检查日志 `_try_execute_skill` 分支 | 
| 冷却技能永远待命 | 坐标/Size 错误导致模板不匹配 | F8 READY 后查看 Debug OSD 图标行 | 
| 药剂不触发 | threshold 过低 / hsv 不准 / 冷却未过 | 使用拾色器重新采样 & 查看内部冷却 | 
| 按住技能未按下 | AHK 服务未运行 / 窗口名不匹配 | 确认 hold_server.ahk 运行标题 | 
| Z 无法切 RUNNING | 当前模式未处于 READY | 先按 F8 / F9 进入准备阶段 | 
| Debug OSD 卡住 | READY 状态无数据正常现象 | 进入 RUNNING 产生数据后刷新 | 

---
## 12. 后续优化方向
- GUI 内联字段校验与提示
- 一键导出调试报告（配置+日志片段）
- 自动模板刷新与对比统计
- 资源检测自适应阈值

---
本章节结束。返回目录：`README` 或访问其他 wiki 文档。