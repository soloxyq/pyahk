# 04 é…ç½®ä¸æ¡ä»¶ç³»ç»Ÿ

## æ¦‚è¿°

é…ç½®ç³»ç»Ÿæ˜¯pyahkçš„æ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼Œæä¾›çµæ´»çš„JSONé…ç½®ç®¡ç†å’Œå¼ºå¤§çš„æ¡ä»¶é€»è¾‘ç³»ç»Ÿã€‚æ”¯æŒçƒ­é‡è½½ã€é…ç½®éªŒè¯å’Œå¤šé…ç½®æ–‡ä»¶ç®¡ç†ï¼Œä¸ºå¤æ‚çš„æ¸¸æˆè‡ªåŠ¨åŒ–éœ€æ±‚æä¾›ç²¾ç¡®çš„æ§åˆ¶èƒ½åŠ›ã€‚

---

## ğŸ“‹ é…ç½®ç®¡ç†æ¶æ„

### ConfigManager æ ¸å¿ƒåŠŸèƒ½
```python
class ConfigManager:
    """ç»Ÿä¸€é…ç½®ç®¡ç†å™¨"""
    def __init__(self):
        self._configs = {}
        self._watchers = {}
        self._schema_validator = None
    
    def load_config(self, config_file: str) -> dict:
        """åŠ è½½å¹¶éªŒè¯é…ç½®æ–‡ä»¶"""
        
    def save_config(self, config_file: str, config_data: dict):
        """ä¿å­˜é…ç½®åˆ°æ–‡ä»¶"""
        
    def hot_reload(self, config_file: str):
        """çƒ­é‡è½½é…ç½®ï¼Œæ— éœ€é‡å¯ç¨‹åº"""
```

### é…ç½®æ–‡ä»¶ç»“æ„
```json
{
  "version": "1.0",
  "global": {
    "debug_mode": false,
    "capture_interval": 100,
    "log_level": "INFO"
  },
  "skills": [
    {
      "name": "ä¸»è¦æŠ€èƒ½",
      "key": "1",
      "trigger_mode": 1,
      "execute_condition": 2,
      "priority": true,
      "enabled": true
    }
  ],
  "potions": [
    {
      "name": "ç”Ÿå‘½è¯å‰‚",
      "key": "2",
      "hp_threshold": 70,
      "region": [136, 910, 213, 1004],
      "hsv_range": [[314, 65, 19], [324, 85, 39]],
      "cooldown": 5000,
      "enabled": true
    }
  ],
  "pathfinding": {
    "enabled": false,
    "minimap_region": [1670, 50, 200, 200],
    "exploration_mode": "systematic"
  },
  "affix_reroll": {
    "enabled": false,
    "target_affixes": ["æš´å‡»ç‡", "æš´å‡»ä¼¤å®³"],
    "max_attempts": 100
  }
}
```

### é…ç½®éªŒè¯ä¸ç±»å‹æ£€æŸ¥
```python
from pydantic import BaseModel, Field
from typing import List, Optional, Tuple

class SkillConfig(BaseModel):
    name: str
    key: str
    trigger_mode: int = Field(ge=0, le=2)
    execute_condition: int = Field(ge=0, le=2)
    priority: bool = False
    enabled: bool = True
    interval: Optional[int] = Field(None, ge=50)
    cooldown_coords: Optional[List[int]] = None

class GlobalConfig(BaseModel):
    debug_mode: bool = False
    capture_interval: int = Field(100, ge=50, le=1000)
    log_level: str = Field("INFO", regex="^(DEBUG|INFO|WARNING|ERROR)$")
```

### é…ç½®çƒ­é‡è½½æœºåˆ¶
```python
class ConfigWatcher:
    """é…ç½®æ–‡ä»¶å˜åŒ–ç›‘æ§"""
    def __init__(self, config_manager):
        self.config_manager = config_manager
        self.file_watchers = {}
    
    def watch_config_file(self, config_file: str):
        """ç›‘æ§é…ç½®æ–‡ä»¶å˜åŒ–ï¼Œè‡ªåŠ¨é‡è½½"""
        from watchdog.observers import Observer
        from watchdog.events import FileSystemEventHandler
        
        class ConfigFileHandler(FileSystemEventHandler):
            def on_modified(self, event):
                if event.src_path.endswith('.json'):
                    self.config_manager.hot_reload(event.src_path)
```

---

## ğŸ¯ æ¡ä»¶ç³»ç»Ÿè¯¦è§£

### è®¾è®¡ç›®æ ‡
- **ç®€å•å¯æšä¸¾**ï¼šä½¿ç”¨æ•´å‹æšä¸¾å€¼ 0/1/2 æ§åˆ¶åˆ†æ”¯
- **æ‰©å±•å‹å¥½**ï¼šæ–°å¢æ¡ä»¶æ—¶åªéœ€å¢åŠ æšä¸¾ + `_evaluate_condition` åˆ†æ”¯
- **ç¨³å®šé˜²æŠ–**ï¼šèµ„æºæ¡ä»¶åŠ å…¥è¿ç»­çª—å£ï¼Œé¿å…è¾¹ç•ŒæŠ–åŠ¨

### æ¡ä»¶æšä¸¾æ¦‚è§ˆ

| å€¼ | åç§° | è¯­ä¹‰ | é€‚ç”¨åœºæ™¯ |
|----|------|------|----------|
| 0 | æ— æ¡ä»¶ | ç›´æ¥å…è®¸æ‰§è¡Œ | æ™®é€šå¾ªç¯æŠ€èƒ½ |
| 1 | BUFF é™åˆ¶ | ä»…å½“æŒ‡å®š Buff ä¸å­˜åœ¨/å¤±æ•ˆæ—¶æ‰§è¡Œ | ç»´æŒç±»æŠ€èƒ½ã€éœ€åˆ·æ–°çŠ¶æ€ |
| 2 | èµ„æºæ¡ä»¶ | èµ„æºè¾¾åˆ°é˜ˆå€¼ä¸”åœ¨è¿ç»­çª—å£å†…ç¨³å®š | èµ„æºé©±åŠ¨çˆ†å‘/æ¶ˆè€—ç±» |

### æ‰§è¡Œè°ƒç”¨æ ˆ
```python
def _try_execute_skill(skill):
    """æŠ€èƒ½æ‰§è¡Œå…¥å£"""
    if not skill.enabled:
        return False
    
    if not self._check_execution_conditions(skill):
        return False
    
    return self._execute_skill_action(skill)

def _check_execution_conditions(skill):
    """æ¡ä»¶æ£€æŸ¥åˆ†å‘å™¨"""
    condition = skill.execute_condition
    
    if condition == 0:
        return True  # æ— æ¡ä»¶
    elif condition == 1:
        return self._evaluate_condition_buff(skill)
    elif condition == 2:
        return self._evaluate_condition_resource(skill)
    else:
        LOG_ERROR(f"æœªçŸ¥çš„æ‰§è¡Œæ¡ä»¶: {condition}")
        return False
```

### æ— æ¡ä»¶æ¨¡å¼ (ExecuteCondition = 0)
```json
{
  "name": "åŸºç¡€æ”»å‡»",
  "key": "1",
  "trigger_mode": 1,
  "execute_condition": 0,
  "cooldown_coords": [100, 50, 20, 20]
}
```
- **è¡Œä¸º**ï¼šå†·å´å°±ç»ªæ—¶ç›´æ¥æ‰§è¡Œä¸»æŒ‰é”®
- **é€‚ç”¨**ï¼šæ— ç‰¹æ®Šé™åˆ¶çš„å¸¸è§„æŠ€èƒ½
- **ä¼˜åŠ¿**ï¼šç®€å•ç›´æ¥ï¼Œæ€§èƒ½æœ€é«˜

### Buffé™åˆ¶æ¨¡å¼ (ExecuteCondition = 1)
```json
{
  "name": "æŠ¤ç›¾æŠ€èƒ½",
  "key": "e",
  "trigger_mode": 1,
  "execute_condition": 1,
  "buff_coords": [200, 100, 30, 30],
  "buff_color": [100, 150, 200],
  "buff_tolerance": 20
}
```

#### æ£€æµ‹é€»è¾‘
```python
def _evaluate_condition_buff(self, skill):
    """Buffå­˜åœ¨æ€§æ£€æµ‹"""
    if not skill.buff_coords:
        return True
    
    frame = self.border_manager.get_current_frame()
    if frame is None:
        return False
    
    x, y, w, h = skill.buff_coords
    roi = frame[y:y+h, x:x+w]
    
    # RGBé¢œè‰²åŒ¹é…æ£€æµ‹Buffå›¾æ ‡
    target_color = skill.buff_color
    tolerance = skill.buff_tolerance or 20
    
    similarity = self._calculate_color_similarity(roi, target_color)
    buff_exists = similarity > 0.8  # 80%ç›¸ä¼¼åº¦é˜ˆå€¼
    
    # Buffå­˜åœ¨æ—¶ä¸æ‰§è¡Œï¼Œä¸å­˜åœ¨æ—¶æ‰§è¡Œ
    return not buff_exists
```

#### åº”ç”¨åœºæ™¯
- **æŠ¤ç›¾æŠ€èƒ½**ï¼šæŠ¤ç›¾æ¶ˆå¤±æ—¶è‡ªåŠ¨é‡æ–°æ–½æ”¾
- **å¢ç›ŠBUFF**ï¼šBUFFåˆ°æœŸæ—¶è‡ªåŠ¨åˆ·æ–°
- **çŠ¶æ€ç»´æŒ**ï¼šç¡®ä¿å…³é”®çŠ¶æ€æŒç»­å­˜åœ¨

### èµ„æºæ¡ä»¶æ¨¡å¼ (ExecuteCondition = 2)
```json
{
  "name": "æ¶ˆè€—æŠ€èƒ½",
  "key": "r",
  "trigger_mode": 1,
  "execute_condition": 2,
  "resource_coords": [50, 950, 200, 20],
  "resource_threshold": 70,
  "resource_type": "mp",
  "alt_key": "t",
  "continuity_window": 3,
  "continuity_threshold": 2
}
```

#### è¿ç»­æ€§æ£€æµ‹æœºåˆ¶
```python
class ResourceContinuityChecker:
    """èµ„æºæ¡ä»¶è¿ç»­æ€§æ£€æµ‹å™¨"""
    def __init__(self):
        self._resource_history = {}  # skill_name -> deque
    
    def check_resource_continuity(self, skill_name, is_sufficient, window_size=3, threshold_count=2):
        """æ£€æŸ¥èµ„æºæ¡ä»¶æ˜¯å¦åœ¨è¿ç»­çª—å£å†…ç¨³å®šæ»¡è¶³"""
        history = self._resource_history.setdefault(skill_name, deque(maxlen=window_size))
        history.append(is_sufficient)
        
        # è¦æ±‚æœ€è¿‘Næ¬¡æ£€æŸ¥ä¸­æœ‰Mæ¬¡æ»¡è¶³æ¡ä»¶
        satisfied_count = sum(history)
        return satisfied_count >= threshold_count and len(history) >= window_size
```

#### èµ„æºæ£€æµ‹é€»è¾‘
```python
def _evaluate_condition_resource(self, skill):
    """èµ„æºå……è¶³æ€§æ£€æµ‹"""
    if not skill.resource_coords:
        return True
    
    # 1. æ£€æµ‹å½“å‰èµ„æºç™¾åˆ†æ¯”
    current_percentage = self._detect_resource_percentage(skill)
    if current_percentage is None:
        return False
    
    # 2. åˆ¤æ–­æ˜¯å¦æ»¡è¶³é˜ˆå€¼
    threshold = skill.resource_threshold or 50
    is_sufficient = current_percentage >= threshold
    
    # 3. è¿ç»­æ€§æ£€æŸ¥
    window_size = skill.continuity_window or 3
    threshold_count = skill.continuity_threshold or 2
    
    is_stable = self.continuity_checker.check_resource_continuity(
        skill.name, is_sufficient, window_size, threshold_count
    )
    
    if is_stable:
        # èµ„æºå……è¶³ä¸”ç¨³å®šï¼Œæ‰§è¡Œä¸»æŒ‰é”®
        self._execute_key(skill.key)
        return True
    elif skill.alt_key:
        # èµ„æºä¸è¶³ï¼Œæ‰§è¡Œå¤‡ç”¨æŒ‰é”®
        self._execute_key(skill.alt_key)
        return True
    
    return False
```

#### åŒæŒ‰é”®ç­–ç•¥
- **ä¸»æŒ‰é”®**ï¼šèµ„æºå……è¶³æ—¶ä½¿ç”¨çš„é«˜æ¶ˆè€—æŠ€èƒ½
- **å¤‡ç”¨æŒ‰é”®**ï¼šèµ„æºä¸è¶³æ—¶ä½¿ç”¨çš„ä½æ¶ˆè€—æ›¿ä»£æŠ€èƒ½
- **æ™ºèƒ½åˆ‡æ¢**ï¼šæ ¹æ®å®æ—¶èµ„æºçŠ¶æ€è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„æŠ€èƒ½

---

## ğŸ”§ é«˜çº§é…ç½®æŠ€å·§

### 1. æŠ€èƒ½ä¼˜å…ˆçº§é…ç½®
```json
{
  "skills": [
    {
      "name": "ç´§æ€¥æ²»ç–—",
      "priority": true,
      "execute_condition": 2,
      "resource_type": "hp",
      "resource_threshold": 30
    },
    {
      "name": "ä¸»è¦è¾“å‡º",
      "priority": true,
      "execute_condition": 1,
      "buff_coords": [300, 100, 40, 40]
    },
    {
      "name": "è¾…åŠ©æŠ€èƒ½",
      "priority": false,
      "execute_condition": 0
    }
  ]
}
```

### 2. æ¡ä»¶ç»„åˆç­–ç•¥
```json
{
  "name": "å¤åˆæ¡ä»¶æŠ€èƒ½",
  "key": "q",
  "execute_condition": 2,
  "resource_coords": [50, 950, 200, 20],
  "resource_threshold": 80,
  "additional_conditions": {
    "buff_check": {
      "coords": [200, 100, 30, 30],
      "required": false
    },
    "enemy_presence": {
      "coords": [500, 400, 100, 100],
      "required": true
    }
  }
}
```

### 3. ç¯å¢ƒé€‚é…é…ç½®
```json
{
  "profiles": {
    "1920x1080": {
      "hp_region": [136, 910, 213, 1004],
      "mp_region": [136, 870, 213, 894],
      "skill_size": 20
    },
    "2560x1440": {
      "hp_region": [181, 1213, 284, 1339],
      "mp_region": [181, 1160, 284, 1192],
      "skill_size": 27
    }
  }
}
```

### 4. è°ƒè¯•é…ç½®
```json
{
  "debug": {
    "enabled": true,
    "log_conditions": true,
    "log_resource_detection": true,
    "save_detection_frames": false,
    "condition_log_interval": 1000
  }
}
```

---

## ğŸ”„ é…ç½®æœ€ä½³å®è·µ

### 1. æ¸è¿›å¼é…ç½®
```python
# ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æŠ€èƒ½é…ç½®
basic_skills = [
    {"name": "æ”»å‡»", "key": "1", "trigger_mode": 0, "execute_condition": 0}
]

# ç¬¬äºŒé˜¶æ®µï¼šæ·»åŠ å†·å´æ£€æµ‹
advanced_skills = [
    {"name": "æ”»å‡»", "key": "1", "trigger_mode": 1, "execute_condition": 0,
     "cooldown_coords": [100, 50, 20, 20]}
]

# ç¬¬ä¸‰é˜¶æ®µï¼šæ·»åŠ å¤æ‚æ¡ä»¶
expert_skills = [
    {"name": "æ”»å‡»", "key": "1", "trigger_mode": 1, "execute_condition": 2,
     "cooldown_coords": [100, 50, 20, 20],
     "resource_coords": [50, 950, 200, 20],
     "resource_threshold": 70}
]
```

### 2. é…ç½®æ¨¡æ¿
```json
{
  "templates": {
    "basic_skill": {
      "trigger_mode": 1,
      "execute_condition": 0,
      "priority": false,
      "enabled": true
    },
    "resource_skill": {
      "trigger_mode": 1,
      "execute_condition": 2,
      "resource_threshold": 70,
      "continuity_window": 3,
      "continuity_threshold": 2
    },
    "buff_skill": {
      "trigger_mode": 1,
      "execute_condition": 1,
      "buff_tolerance": 20
    }
  }
}
```

### 3. é…ç½®éªŒè¯
```python
def validate_skill_config(skill_config):
    """é…ç½®éªŒè¯å‡½æ•°"""
    errors = []
    
    # å¿…éœ€å­—æ®µæ£€æŸ¥
    required_fields = ["name", "key", "trigger_mode"]
    for field in required_fields:
        if field not in skill_config:
            errors.append(f"ç¼ºå°‘å¿…éœ€å­—æ®µ: {field}")
    
    # æ¡ä»¶ç‰¹å®šéªŒè¯
    if skill_config.get("execute_condition") == 2:
        if not skill_config.get("resource_coords"):
            errors.append("èµ„æºæ¡ä»¶æ¨¡å¼éœ€è¦é…ç½®resource_coords")
    
    return errors
```

é€šè¿‡è¿™å¥—å®Œæ•´çš„é…ç½®å’Œæ¡ä»¶ç³»ç»Ÿï¼Œpyahkèƒ½å¤Ÿé€‚åº”å„ç§å¤æ‚çš„æ¸¸æˆåœºæ™¯å’Œç”¨æˆ·éœ€æ±‚ï¼Œæä¾›ç²¾ç¡®çš„è‡ªåŠ¨åŒ–æ§åˆ¶èƒ½åŠ›ã€‚