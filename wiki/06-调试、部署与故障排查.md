# 06 调试、部署与故障排查（合订本）

本章合并原《06 调试与开发》《07 部署与运维》《08 故障排查手册》，提供从开发调试、性能分析、环境部署到问题排查的一体化指南。

---

## 一、调试与开发（摘编增强）

### 调试模式与OSD
- 通过配置 debug.enabled 开启；或使用 F7/FPS/性能统计热键。
- OSD 显示：状态机、FPS、输入队列长度、捕获/检测耗时、调度器暂停统计等。

### 可视化与日志
- 技能/资源检测区域覆盖，路径点与障碍可视化。
- 分模块 Logger 与节流日志（ThrottledLogger），避免高频刷屏。

### 性能监控要点
- 暂停/恢复事件计数、暂停持续时长、CPU 节约率（优先级按键期间）。
- Scheduler 恢复时重算 next_run_time，避免堆积执行。

### 基础开发环境
- Python >= 3.8；依赖见 requirements.txt。
- C++ DXGI 捕获：VS Build Tools + CMake，native_capture/build.bat 一键编译。

---

## 二、部署与运维（整合）

### 环境要求与权限
- Windows 10/11；管理员权限（全局热键与窗口激活）。
- 显卡支持 DXGI；若 DLL 加载失败，安装 VC++ Redistributable。

### 依赖安装
- 在线：pip install -r requirements.txt
- 国内镜像/离线包：支持下载到 offline_packages 后离线安装。

### 目录与配置
```
pyahk/
  main.py, main_special.py, default.json, native_capture/, torchlight_assistant/, wiki/
```
- 建议将实际使用的配置复制为 my_config.json 并通过 GUI 维护。

### 服务化与计划任务（可选）
- Windows 服务脚本（pywin32）；计划任务以 SYSTEM 最高权限开机启动。

### 运维监控
- 轮转日志、性能采集脚本（CPU/内存/线程），健康检查（进程/内存/日志异常）。

---

## 三、故障排查（整合要点）

### A. 输入系统相关
1) 程序启动后输入"卡死"或需按右键才恢复
- 2025.01 起已迁移到 Windows Hook，更新至最新版本即可根治。

2) 优先级按键无效或双重触发
- 检查是否区分 special_keys 与 managed_keys；管理按键建议"拦截→映射发送"。
- 查看日志是否打印"优先级按键监听已启动"。

3) 鼠标键（left/right/middle）不识别
- 已补齐 VK 与 WM 常量；若仍异常，检查杀软/权限以及 Hook 注册错误输出。

4) 切换配置文件后热键失效（原地模式/交互键）
- **症状**: 从 default.json 切换到其他配置文件后，X/A 等可配置热键不响应
- **原因**: 键角色转换冲突（如 X 键从 force_move 转为 stationary 时被错误 unregister）
- **修复**: 已采用"先取消所有可配置热键，再重新注册"策略（v2025.01.11+）
- **验证**: 查看日志中 `[热键管理] 取消注册所有可配置热键` 和 `成功注册热键 'stationary': x`

5) 原地模式切换成功但技能键未添加 Shift 修饰符
- **症状**: OSD 显示已进入原地模式，但技能键实际效果未变化
- **原因**: InputHandler 未从配置中更新 `_cached_stationary_mode_type`
- **修复**: 已在 `_on_config_updated` 中添加 stationary_mode_config 读取（v2025.01.11+）
- **验证**: 查看日志 `[输入处理器] 原地模式类型已更新: shift_modifier`

### B. 图像捕获与识别
- DLL load failed：重装 VC++，重编原生库；必要时降级到 MSS 备用方案。
- 冷却/HSV 检测不准：缩小 ROI、缓存模板、启用中心区域检测与连续性窗口。

### C. 性能与资源
- 优先级按键期间应“零无效计算”（帧捕获/检测/调度暂停）；如未生效，检查事件订阅与 Scheduler 状态。
- CPU 高：调大捕获/检测间隔，合并任务，降低调试刷新频率。

### D. OCR/依赖
- paddleocr 初始化失败：清缓存重新安装；将其设为可选模块并保护导入。

### E. 配置与序列
- 校验按键序列 delayX 规范、逗号分隔；检查 managed_keys 对象格式 {target, delay}；避免自拦截。

---

## 四、工具与脚本（精选）
- SchedulerPerformanceValidator：暂停/恢复响应时间、CPU 节约率与任务准确性检测。
- monitor.py：进程 CPU/内存/线程周期采集。
- backup_config.py：配置备份/恢复。

---

## 五、问题报告模板（简版）
包含系统/显卡/分辨率、Python/commit 版本、复现步骤、期望/实际、关键日志、相关配置片段。

---

本章为运行期与维护期的一站式参考：遇到输入/性能/捕获/配置问题先对照本章排查，再结合 02/03/04 章节定位到架构、API 与配置层。