# 故障排查手册

本文档提供了常见问题的诊断和解决方案。

---

## 📋 目录

1. [文本OCR识别失败](#文本ocr识别失败)
2. [HSV颜色检测失败](#hsv颜色检测失败)
3. [性能问题](#性能问题)
4. [配置问题](#配置问题)

---

## 1. 文本OCR识别失败

### 问题现象
- HP/MP数值显示为 0/0
- 识别文本为空字符串
- 识别结果置信度很低（< 0.75）

### 诊断步骤

#### 步骤1：检查游戏分辨率和UI缩放
**这是最常见的问题原因！**

1. **症状**：游戏更新后、切换分辨率后、改变UI缩放后识别失败
2. **原因**：文本OCR使用模板匹配，模板是基于特定字体大小生成的。如果游戏字体大小改变（通常只有几个像素），匹配度会急剧下降
3. **解决方案**：
   ```bash
   # 重新生成匹配当前分辨率的模板
   cd d:\repogit\pyahk
   python torchlight_assistant/utils/digit_template_generator.py
   ```
4. **验证**：在调试模式下查看置信度分数是否恢复到 > 0.90

#### 步骤2：检查文本区域坐标
1. 打开调试模式：勾选"显示调试信息"
2. 查看识别区域是否正确框选了HP/MP数字
3. 如果区域不准确：
   - 使用"选择区域"按钮重新框选
   - 确保区域完整包含数字，但不包含过多背景
   - 典型坐标：
     - HP: `(97, 814, 218, 835)` - 左下角
     - MP: `(1767, 814, 1894, 835)` - 右下角

#### 步骤3：检查光照和背景
1. **症状**：在特定地图/场景下识别失败
2. **原因**：背景色变化（如白天/黑夜、地图滤镜）影响二值化
3. **解决方案**：
   - 默认情况下，系统已启用**自适应阈值**，对光照变化有很强的鲁棒性
   - 如果仍有问题，可以在代码中调整参数：
     ```python
     # 在 digit_text_recognizer.py 的 recognize_text_in_region 中
     processed = self.preprocess_image(roi, use_adaptive=True)  # 确保启用自适应
     ```

#### 步骤4：检查字体粗细变化
1. **症状**：特殊状态下（如被点燃、冰冻）字体变色或变粗
2. **原因**：模板匹配对字体粗细敏感
3. **解决方案**：
   - 默认情况下，系统已启用**多尺度匹配**（95%-105%），可以容忍小幅度的字体变化
   - 如果需要更大的容忍度：
     ```python
     # 在创建识别器时调整尺度范围
     recognizer = DigitTextRecognizer(
         match_threshold=0.70,
         enable_multiscale=True,
         scale_range=(0.90, 1.0, 1.10)  # 扩大到90%-110%
     )
     ```

### 调试技巧

启用详细调试输出：
```python
# 在测试代码中
text, percentage = recognizer.recognize_and_parse(frame, region, debug=True)
```

输出示例：
```
[DEBUG] ROI尺寸: (21, 121), 区域: (97, 814, 218, 835)
[DEBUG] 提取到 7 个字符区域
  字符1: 位置(4,0), 尺寸11x16, 识别'5', 置信度0.988
  字符2: 位置(19,0), 尺寸11x16, 识别'4', 置信度1.000
  字符3: 位置(34,0), 尺寸11x16, 识别'0', 置信度0.998
  字符4: 位置(49,0), 尺寸7x16, 识别'/', 置信度1.000
  字符5: 位置(60,0), 尺寸11x16, 识别'5', 置信度0.988
  字符6: 位置(75,0), 尺寸11x16, 识别'4', 置信度1.000
  字符7: 位置(90,0), 尺寸11x16, 识别'0', 置信度0.998
[DEBUG] 最终识别: '540/540'
```

### 快速检查清单
- [ ] 游戏分辨率是否改变？→ 重新生成模板
- [ ] UI缩放是否改变？→ 重新生成模板
- [ ] 文本区域坐标是否正确？→ 重新框选
- [ ] 置信度分数如何？→ 如果 > 0.75 但 < 0.90，可能需要重新生成模板
- [ ] 是否在特殊光照环境？→ 确认自适应阈值已启用
- [ ] 字体是否变粗/变细？→ 确认多尺度匹配已启用

---

## 2. HSV颜色检测失败

### 问题现象
- 矩形/圆形检测模式下识别不准确
- 误报或漏报资源低阈值

### 诊断步骤

#### 步骤1：调整HSV容差
1. 在GUI中逐步增加容差值（默认15）
2. 测试范围：10 → 15 → 20 → 25
3. 观察检测区域的颜色覆盖是否改善

#### 步骤2：重新框选颜色区域
1. 使用"选择区域"按钮
2. 确保选择的区域包含代表性的颜色样本
3. 避免选择边缘或渐变区域

#### 步骤3：检查光照影响
- HSV比RGB对光照更鲁棒，但极端情况仍会受影响
- 如果HSV检测不稳定，考虑切换到文本OCR模式

---

## 3. 性能问题

### 问题现象
- 系统响应延迟
- CPU占用过高
- 识别速度变慢

### 诊断步骤

#### 检查捕获模式
1. Windows Graphics Capture 性能最优（推荐）
2. 如果使用GDI/BitBlt，性能会下降

#### 检查识别模式
- **文本OCR**: < 10ms（最快）
- **矩形检测**: ~5ms
- **圆形检测**: ~5ms

#### 优化建议
1. 优先使用文本OCR模式（如果适用）
2. 降低检测频率（增加检测间隔）
3. 减少同时监控的资源数量

---

## 4. 配置问题

### 配置文件损坏
**症状**：程序启动失败或配置无法保存

**解决方案**：
```bash
# 重置为默认配置
cd d:\repogit\pyahk
cp default.json current_config.json
```

### 坐标格式错误
**正确格式**：
- 矩形: `x1,y1,x2,y2` （例如：97,814,218,835）
- 圆形: `x,y,r` （例如：100,100,50）
- 文本: `x1,y1,x2,y2` （例如：97,814,218,835）

---

## 🔧 高级调试

### 启用全局调试日志
```python
from torchlight_assistant.utils.debug_log import set_debug_level
set_debug_level("DEBUG")  # 输出详细日志
```

### 保存调试帧
```python
# 在 border_frame_manager.py 中
cv2.imwrite(f"debug_frame_{frame_count:04d}.png", frame)
```

### 性能分析
```python
import time
start = time.perf_counter()
result = recognizer.recognize_and_parse(frame, region)
elapsed = (time.perf_counter() - start) * 1000
print(f"识别耗时: {elapsed:.2f}ms")
```

---

## 📞 获取帮助

如果以上方法都无法解决问题：

1. 查看完整文档：`wiki/01-项目概述与快速入门.md`
2. 检查技术实现细节：`wiki/03-功能模块与API.md`
3. 查看性能优化指南：`wiki/05-图像捕获与性能.md`

---

## 🎯 核心要点总结

1. **文本OCR识别失败 → 首先检查游戏分辨率/UI缩放是否改变**
2. **多尺度匹配和自适应阈值已默认启用，大多数情况无需手动调整**
3. **置信度 < 0.75 通常意味着需要重新生成模板**
4. **文本OCR模式性能和准确性都优于HSV检测（在适用场景下）**
