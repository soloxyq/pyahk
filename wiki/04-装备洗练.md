# 装备洗练系统

## 概述

装备洗练系统是pyahk的独立功能模块，专门用于自动化装备词缀重铸。系统采用三状态智能识别机制，结合PaddleOCR文字识别技术，实现精确的词缀检测和自动洗练操作。

## 核心技术

### 三状态识别机制

#### 状态1：未洗练状态
- **特征**：装备未进行任何洗练操作
- **识别**：通过特定UI元素的颜色和位置识别
- **操作**：点击开始洗练按钮

#### 状态2：洗练进行中
- **特征**：正在进行洗练，界面显示进度或动画
- **识别**：检测洗练进度指示器
- **操作**：等待洗练完成

#### 状态3：洗练完成
- **特征**：洗练完成，显示新词缀结果
- **识别**：检测完成状态的UI特征
- **操作**：进行OCR识别，决策是否保留

### PaddleOCR集成

#### OCR引擎配置
```python
# PaddleOCR优化配置
ocr_config = {
    "use_angle_cls": True,      # 启用角度分类
    "lang": "ch",               # 中文识别
    "use_gpu": False,           # CPU模式，兼容性更好
    "show_log": False,          # 禁用详细日志
    "det_db_score_mode": "slow" # 精确检测模式
}
```

#### 文字识别流程
1. **区域截取**：截取装备词缀显示区域
2. **图像预处理**：调整对比度和清晰度
3. **OCR识别**：提取词缀文字内容
4. **词缀匹配**：与目标词缀列表对比
5. **决策执行**：保留满意词缀或继续洗练

## 功能特性

### 1. 智能状态监控
- **实时状态检测**：持续监控洗练界面状态
- **状态转换处理**：自动处理各状态间的转换逻辑
- **异常恢复**：检测到异常状态时自动恢复

### 2. 词缀识别与匹配
- **多词缀支持**：同时识别多个装备词缀
- **模糊匹配**：支持部分匹配和近似匹配
- **优先级排序**：支持词缀优先级设置

### 3. 洗练控制
- **自动重试**：不满意时自动继续洗练
- **停止条件**：达到目标词缀时自动停止
- **安全机制**：避免意外的连续操作

## 配置指南

### 基础配置

#### 1. OCR引擎设置
```json
{
  "ocr_config": {
    "enabled": true,
    "language": "ch",
    "use_gpu": false,
    "confidence_threshold": 0.7
  }
}
```

#### 2. 检测区域设置
```json
{
  "reroll_config": {
    "detect_regions": {
      "state_indicator": [100, 200, 150, 250],
      "affix_area": [300, 400, 600, 700],
      "button_area": [500, 800, 600, 850]
    }
  }
}
```

#### 3. 目标词缀配置
```json
{
  "target_affixes": [
    {"text": "攻击力", "priority": 1, "required": true},
    {"text": "暴击", "priority": 2, "required": false},
    {"text": "速度", "priority": 3, "required": false}
  ]
}
```

### 高级配置

#### 1. 识别参数调优
- **置信度阈值**：调整OCR识别的最低置信度
- **图像预处理**：配置对比度、亮度调整参数
- **识别区域**：精确设置词缀显示区域坐标

#### 2. 洗练策略
- **最大尝试次数**：设置自动洗练的最大次数
- **停止条件**：定义满意词缀的组合条件
- **间隔时间**：设置操作间的等待间隔

## 使用流程

### 准备阶段
1. **加载OCR引擎**：在"洗练"标签页点击"加载OCR引擎"
2. **配置区域**：设置状态检测和词缀识别区域
3. **设置目标**：配置期望的装备词缀
4. **测试识别**：使用测试功能验证识别准确性

### 执行阶段
1. **准备装备**：将需要洗练的装备准备好
2. **F7启动**：按F7键启动洗练模式
3. **自动执行**：系统自动进行洗练和识别
4. **结果确认**：达到满意结果时自动停止

### 监控调试
- **实时OSD**：显示当前状态和识别结果
- **日志记录**：详细记录操作和识别过程
- **手动干预**：支持手动停止和调整

## 状态机设计

### 状态转换图
```
[等待状态] --检测到装备--> [未洗练]
[未洗练] --点击洗练--> [洗练中]
[洗练中] --完成检测--> [洗练完成]
[洗练完成] --OCR识别--> [结果评估]
[结果评估] --不满意--> [未洗练]
[结果评估] --满意--> [完成停止]
```

### 状态处理逻辑
```python
class RerollStateMachine:
    def handle_waiting_state(self):
        # 检测是否有装备可洗练
        
    def handle_not_rerolled_state(self):
        # 点击开始洗练按钮
        
    def handle_rerolling_state(self):
        # 等待洗练动画完成
        
    def handle_completed_state(self):
        # 进行OCR识别和结果评估
```

## 词缀识别算法

### OCR预处理
1. **图像增强**：提高文字清晰度
2. **噪声过滤**：移除背景干扰
3. **尺寸标准化**：调整到最佳识别尺寸

### 文字提取
```python
def extract_affixes(image_region):
    # 1. OCR识别
    results = ocr.ocr(image_region)
    
    # 2. 文字过滤
    texts = filter_valid_texts(results)
    
    # 3. 词缀匹配
    matched_affixes = match_target_affixes(texts)
    
    return matched_affixes
```

### 匹配策略
- **精确匹配**：完全匹配目标词缀文字
- **包含匹配**：词缀文字包含目标关键词
- **模糊匹配**：使用编辑距离算法的近似匹配

## 性能优化

### OCR引擎优化
- **按需加载**：仅在需要时加载OCR引擎
- **内存管理**：及时释放不需要的图像数据
- **并行处理**：支持多线程OCR识别

### 检测优化
- **区域缓存**：缓存检测区域设置
- **状态缓存**：避免重复的状态检测
- **智能等待**：根据状态动态调整检测间隔

## 错误处理

### 常见错误类型
1. **OCR识别失败**：图像质量问题或区域设置错误
2. **状态检测错误**：界面变化或坐标偏移
3. **操作执行失败**：点击位置错误或时机不对

### 错误恢复机制
```python
def handle_recognition_error(error_type):
    if error_type == "OCR_FAILED":
        # 调整图像预处理参数重试
        retry_with_enhanced_image()
    elif error_type == "STATE_DETECTION_FAILED":
        # 重置状态检测
        reset_state_detection()
    elif error_type == "OPERATION_FAILED":
        # 重新定位操作区域
        recalibrate_operation_areas()
```

## 扩展功能

### 自定义词缀库
- 支持导入自定义词缀配置
- 词缀优先级和权重设置
- 组合词缀的评分机制

### 统计分析
- 洗练成功率统计
- 词缀出现频率分析
- 操作效率评估

### 批量处理
- 多装备连续洗练
- 自动装备切换
- 批量结果导出

## 使用技巧

1. **区域设置**：确保识别区域准确覆盖词缀显示区域
2. **光照环境**：保持稳定的游戏画面亮度
3. **字体设置**：游戏中使用清晰易识别的字体
4. **分辨率**：推荐使用1080P分辨率以获得最佳识别效果
5. **干扰因素**：避免其他窗口遮挡游戏界面
6. **网络延迟**：考虑网络延迟对状态检测的影响