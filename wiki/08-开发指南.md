# 08 开发指南

本章面向希望阅读、扩展或贡献代码的开发者，概述工程结构、核心模式、关键模块交互、扩展点与代码风格建议。

---
## 1. 架构速览

核心理念：事件驱动 + 单线程调度器 + 被动式业务模块 + C++高性能捕获。整体采用明确的状态机与统一数据发布机制。

```
+-----------------+       +------------------+        +-------------------+
|  MacroEngine    | <---> |   EventBus        | <----> |  UI (PySide6)      |
| (状态/模式协调) |       | (发布/订阅中心)   |        | DebugOSD/MainWindow |
+--------+--------+       +---------+--------+        +----------+--------+
         |                          ^                            ^
         v                          |                            |
+--------+--------+        +--------+---------+         +--------+---------+
| SkillManager    | -----> | UnifiedScheduler  |         | PathfindingMgr   |
| (技能/药剂调度) |        | (单线程任务循环)  |         | (地图/路径)       |
+--------+--------+        +--------+---------+         +------------------+
         |                           
         v                           
+--------+--------+        +-------------------+
| ResourceManager | --->   | BorderFrameManager|
| (药剂业务)       |        | (图像检测/模板)    |
+-----------------+        +---------+---------+
                                  |
                                  v
                           +--------------+
                           | NativeCapture|
                           | (C++ DLL)    |
                           +--------------+
```

---
## 2. 入口与运行流程

| 文件 | 作用 |
|------|------|
| `main.py` | GUI 启动入口，构建 MainWindow，初始化 MacroEngine、Managers、注册事件与热键 |
| `main_special.py` | 精简命令行入口，主要用于特定自动化脚本场景 |
| `torchlight_assistant/core/macro_engine.py` | 状态机 & 模式调度核心 |

### 启动阶段顺序 (GUI)
1. 解析/加载配置 → 构造 ConfigManager
2. 初始化 EventBus / UnifiedScheduler / 各 Manager
3. 构建 UI (MainWindow) 并注册监听（`engine:state_changed`, `debug_osd_update` 等）
4. 注册全局热键（HotkeyManager）
5. 进入空闲 (STOPPED)

---
## 3. 状态机 (MacroState)

统一四态：`STOPPED → READY → RUNNING ↔ PAUSED`。

| 状态 | 行为 |
|------|------|
| STOPPED | 释放所有按住技能、停止调度任务、隐藏 Debug OSD、停止捕获 |
| READY | 完成捕获准备：模板缓存、HSV 截取、图像调试帧保存；显示 OSD Ready 文案；不启动周期发布 |
| RUNNING | 启动技能/药剂调度任务 + DebugDisplayManager 发布；按住技能一次性按下 |
| PAUSED | 暂停调度任务；停止 Debug 发布但保留最后UI；按住技能释放或保留（按实现） |

状态切换由热键驱动（F8/F9 + Z），通过 `_set_state()` 调用 `_on_state_enter()`，并广播 `engine:state_changed`。

---
## 4. 调度系统 UnifiedScheduler

- 单线程循环 + `heapq` 最小堆，元素：`(next_run_ts, task_id, callable, interval)`
- 支持：添加、移除、暂停、恢复、更新间隔
- 线程安全：通常只在主逻辑线程调用，避免锁
- 使用模式：SkillManager 注册任务（冷却检测、资源检测、序列执行、Debug 发布）

防抖策略：高频任务 (≤100ms) 谨慎添加，避免饥饿；利用合并帧思想——一次捕获，多模块复用。

---
## 5. 图像捕获与检测链路

```
Native C++ Capture → (共享内存) → BorderFrameManager.get_latest_frame()
                                 ↘ template缓存/HSV模板
```

- READY 阶段：调用 `capture_once_for_debug_and_cache()` 和 `capture_template_hsv()` → 冻结一组模板
- RUNNING：技能冷却检测 `compare_cooldown_image(skill)`；药剂检测同入口（名称路由）
- 性能要点：尽量减少重复 `memcpy`；Python 层只处理必要像素区域

---
## 6. DebugDisplayManager & OSD

| 组件 | 职责 |
|------|------|
| DebugDisplayManager | 周期收集状态（HP/MP/技能冷却记录/动作队列）并通过 EventBus 发布 |
| DebugOsdWindow | 订阅更新事件，READY 显示提示，RUNNING 渲染动态数据，多行技能、透明背景 |

发布控制：只在 RUNNING 状态 `is_active=True` 时调度；PAUSED 停止发布；STOPPED 隐藏窗口。

---
## 7. 技能与药剂执行路径

`UnifiedScheduler` 周期→ `SkillManager.check_cooldowns()` / `check_resources()` → `_try_execute_skill()` → 条件判断 → 入队 InputHandler → 实际键鼠动作 / hold AHK。

药剂特殊：`ResourceManager` 被动接收调用 → `_should_use_hp_resource` 判定 → 委托 `BorderFrameManager` 计算 HSV 匹配度。

---
## 8. 输入系统交互

- InputHandler 维护安全队列；执行线程逐个发送
- 优先级：高优先级技能插入队列头部
- Hold 技能：进入 RUNNING 一次性 `hold:key`；暂停/停止 `release:key`
- dry_run 模式：不真实发送，只记录到 Debug OSD `actions` 列表

---
## 9. 事件总线 (EventBus)

特性：
- 订阅/发布 API：`subscribe(event, handler)` / `publish(event, **data)`
- 可选线程池执行，提高 UI/后台隔离
- 递归发布保护、防重入检测
- 性能监控：可在 DEBUG 模式打印耗时

常见事件：
- `engine:state_changed`
- `debug_osd_update`, `debug_osd_ready_state`
- `hotkey:pressed:<KEY>`
- `path:state_changed`

---
## 10. 扩展点指南

| 场景 | 建议做法 |
|------|----------|
| 新增检测类型 | 在 BorderFrameManager 增加分支，复用 compare_cooldown_image 接口路由 |
| 新增技能条件 | 扩展 `_evaluate_condition`；保持枚举整洁；更新文档 |
| 新 UI 模块 | 通过 EventBus 订阅状态；避免直接跨模块调用 |
| 新模式(如 自动拾取) | 在 MacroEngine 增加模式状态；复用统一状态机流程 |
| 性能优化 | 优先分析帧捕获与任务频率；避免无谓日志 |

---
## 11. 代码风格与约定

- 命名：模块/类清晰表达职责；私有方法前缀 `_`
- 日志：仅在 DEBUG 或关键失败路径输出详细信息
- 线程：除 Pathfinding / Reroll 外尽量单线程调度 + UI 主线程定时器
- 魔法数：集中为常量或配置字段
- 文档：新增功能同步更新对应 wiki 章节

---
## 12. 测试与调试建议

| 目标 | 方法 |
|------|------|
| 验证技能冷却检测 | F8 READY 后观察 Debug OSD 技能行是否随冷却恢复变化 |
| 检查药剂阈值 | 人为降低 threshold，观察是否触发且冷却间隔正确 |
| 性能分析 | 统计 scheduler 循环耗时 / 帧捕获耗时（临时日志） |
| OSD 状态切换 | 快速 F8 / Z 切换确认 READY/ RUNNING / PAUSED / STOPPED UI 正确 |
| Hold 功能 | 断开 AHK 进程观察是否优雅失败（不影响其他功能） |

---
## 13. 贡献流程 (建议)
1. Fork & 新建分支：`feature/<name>`
2. 保持小步提交，提交信息语义化：`feat(skill): 支持多段冷却图标比较`
3. 更新/新增 wiki 文档章节
4. 发起 PR，描述改动动机、接口影响、测试结果

---
## 14. 常见坑位
- 在 READY 阶段不应启动高频任务（避免空数据刷 RUNNING）
- 不要在多个线程访问同一帧缓冲未经同步
- 冷却图标坐标错误 → 反复判定为“未就绪”
- HSV 模板采样包含过多背景噪声 → 匹配抖动
- 按住技能遗留：状态 STOPPED 时务必释放所有 hold

---
## 15. 后续规划建议
- 统一 metrics 收集（任务延迟、帧耗时）
- 插件化条件系统（策略模式）
- A* 结果路径压缩（折线抽稀）
- GPU 加速 HSV/相似度计算
- 多语言文档（中文/英文）

---
本章完。返回目录：`README` 或继续阅读下一章节。
